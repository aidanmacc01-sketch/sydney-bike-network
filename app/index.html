<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Sydney Bike Network - Future Vision</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#7C3AED",
            "background-light": "#F8FAFC",
            "background-dark": "#0F172A",
            "acc-green": "#22C55E",
            "acc-yellow": "#FACC15",
            "acc-blue": "#3B82F6",
            "acc-orange": "#F59E0B",
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
          },
          borderRadius: {
            DEFAULT: "1rem",
          },
        },
      },
    };
  </script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .glass {
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    @keyframes pulse-ring {
      0% { transform: scale(.33); opacity: 1; }
      80%, 100% { transform: scale(1.5); opacity: 0; }
    }

    .pulse-dot::before {
      content: '';
      position: absolute;
      width: 300%;
      height: 300%;
      border-radius: 50%;
      background-color: inherit;
      animation: pulse-ring 1.5s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .pin-shadow {
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.2));
    }

    /* Hide scrollbar but allow scroll */
    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .hide-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Bottom sheet animation */
    .bottom-sheet {
      transition: transform 0.3s ease-out;
    }

    .bottom-sheet.collapsed {
      transform: translateY(calc(100% - 100px));
    }

    /* Custom marker styles */
    .custom-marker {
      cursor: pointer;
      transition: transform 0.2s;
    }
    .custom-marker:hover {
      transform: scale(1.1);
    }

    /* Progress bar animation */
    .progress-bar {
      transition: width 0.5s ease-out;
    }

    /* Toast notification */
    .toast {
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease-out;
    }
    .toast.visible {
      transform: translateY(0);
      opacity: 1;
    }

    /* Modal */
    .modal-overlay {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .modal-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }
    .modal-content {
      transform: translateY(50px) scale(0.95);
      opacity: 0;
      transition: all 0.3s ease-out;
    }
    .modal-overlay.visible .modal-content {
      transform: translateY(0) scale(1);
      opacity: 1;
    }
  </style>
</head>

<body class="font-display antialiased bg-background-light dark:bg-background-dark overflow-hidden select-none">

  <!-- Main Container - Full Screen -->
  <div class="relative w-full h-screen overflow-hidden">

    <!-- Google Map Container (Full Screen Background) -->
    <div id="map" class="absolute inset-0 w-full h-full"></div>

    <!-- Top Search Bar -->
    <div class="absolute top-4 left-4 right-4 z-40 md:left-20 md:right-20 lg:left-1/4 lg:right-1/4">
      <div class="glass bg-white/70 dark:bg-slate-900/70 p-1.5 rounded-full border border-white/30 dark:border-slate-800/30 flex items-center shadow-xl">
        <span class="material-icons-round text-gray-400 px-3">search</span>
        <input
          id="searchInput"
          class="bg-transparent border-none focus:ring-0 focus:outline-none text-sm w-full dark:text-white placeholder-gray-500"
          placeholder="Search Sydney Bike Network..."
          type="text"
        />
        <button id="filterBtn" class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white flex-shrink-0">
          <span class="material-icons-round text-lg">tune</span>
        </button>
      </div>
    </div>

    <!-- Network View Toggle -->
    <div class="absolute top-20 left-1/2 -translate-x-1/2 z-40">
      <div class="glass bg-white/80 dark:bg-slate-900/80 p-1 rounded-full border border-white/30 dark:border-slate-800/30 shadow-xl flex gap-1">
        <button class="toggle-btn px-4 py-2 rounded-full text-sm font-semibold transition-all bg-acc-green text-white" data-view="current">
          Today
        </button>
        <button class="toggle-btn px-4 py-2 rounded-full text-sm font-semibold transition-all text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-800" data-view="future">
          2026+
        </button>
        <button class="toggle-btn px-4 py-2 rounded-full text-sm font-semibold transition-all text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-800" data-view="all">
          Full Vision
        </button>
      </div>
    </div>

    <!-- Left Sidebar - Action Buttons -->
    <div class="absolute top-36 left-4 z-40">
      <div class="glass bg-white/80 dark:bg-slate-900/80 p-2 rounded-2xl border border-white/30 dark:border-slate-800/30 shadow-xl flex flex-col gap-3">
        <button id="routeBtn" class="w-10 h-10 rounded-xl bg-acc-green text-white flex items-center justify-center shadow-md hover:scale-105 transition-transform" title="Plan Route">
          <span class="material-icons-round">route</span>
        </button>
        <button id="editBtn" class="w-10 h-10 rounded-xl bg-primary text-white flex items-center justify-center shadow-md hover:scale-105 transition-transform" title="Report Issue">
          <span class="material-icons-round">edit_road</span>
        </button>
        <button id="communityBtn" class="w-10 h-10 rounded-xl bg-acc-yellow text-white flex items-center justify-center shadow-md hover:scale-105 transition-transform" title="Community">
          <span class="material-icons-round">groups</span>
        </button>
        <button id="educationBtn" class="w-10 h-10 rounded-xl bg-acc-blue text-white flex items-center justify-center shadow-md hover:scale-105 transition-transform" title="Learn & Earn">
          <span class="material-icons-round">school</span>
        </button>
        <div class="h-px bg-gray-200 dark:bg-gray-700 mx-1"></div>
        <button id="layersBtn" class="w-10 h-10 rounded-xl glass bg-white/50 dark:bg-slate-800/50 text-gray-600 dark:text-gray-300 flex items-center justify-center hover:scale-105 transition-transform" title="Layers">
          <span class="material-icons-round">layers</span>
        </button>
      </div>
    </div>

    <!-- Legend Pills -->
    <div class="absolute top-36 right-4 z-40 flex flex-col gap-2">
      <div class="glass bg-white/80 dark:bg-slate-900/80 px-3 py-2 rounded-xl border border-white/30 shadow-lg">
        <div class="flex items-center gap-2 text-xs font-medium">
          <div class="w-3 h-3 rounded-full bg-acc-green"></div>
          <span class="dark:text-white">Open</span>
        </div>
      </div>
      <div class="glass bg-white/80 dark:bg-slate-900/80 px-3 py-2 rounded-xl border border-white/30 shadow-lg">
        <div class="flex items-center gap-2 text-xs font-medium">
          <div class="w-3 h-3 rounded-full bg-acc-orange"></div>
          <span class="dark:text-white">Building</span>
        </div>
      </div>
      <div class="glass bg-white/80 dark:bg-slate-900/80 px-3 py-2 rounded-xl border border-white/30 shadow-lg">
        <div class="flex items-center gap-2 text-xs font-medium">
          <div class="w-3 h-3 rounded-full bg-acc-blue"></div>
          <span class="dark:text-white">Funded</span>
        </div>
      </div>
      <div class="glass bg-white/80 dark:bg-slate-900/80 px-3 py-2 rounded-xl border border-white/30 shadow-lg">
        <div class="flex items-center gap-2 text-xs font-medium">
          <div class="w-3 h-3 rounded-full bg-primary"></div>
          <span class="dark:text-white">Planned</span>
        </div>
      </div>
      <div class="glass bg-white/80 dark:bg-slate-900/80 px-3 py-2 rounded-xl border border-white/30 shadow-lg">
        <div class="flex items-center gap-2 text-xs font-medium">
          <div class="w-3 h-3 rounded-full bg-pink-500"></div>
          <span class="dark:text-white">Veloway</span>
        </div>
      </div>
    </div>

    <!-- Network Stats Banner -->
    <div id="statsBanner" class="absolute bottom-[340px] left-4 right-4 md:left-1/4 md:right-1/4 z-30">
      <div class="glass bg-white/90 dark:bg-slate-900/90 rounded-2xl border border-white/40 shadow-xl p-4 flex justify-around">
        <div class="text-center">
          <div class="text-2xl font-bold text-acc-green" id="statsKm">35</div>
          <div class="text-xs text-gray-500 dark:text-gray-400 font-medium">km Network</div>
        </div>
        <div class="h-10 w-px bg-gray-200 dark:bg-gray-700"></div>
        <div class="text-center">
          <div class="text-2xl font-bold text-primary" id="statsProjects">9</div>
          <div class="text-xs text-gray-500 dark:text-gray-400 font-medium">Projects</div>
        </div>
        <div class="h-10 w-px bg-gray-200 dark:bg-gray-700"></div>
        <div class="text-center">
          <div class="text-2xl font-bold text-acc-yellow" id="statsTrips">45k</div>
          <div class="text-xs text-gray-500 dark:text-gray-400 font-medium">Daily Trips</div>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet - Project/Segment Details -->
    <div id="bottomSheet" class="bottom-sheet absolute bottom-0 left-0 right-0 z-40 collapsed">
      <div class="glass bg-white/95 dark:bg-slate-900/95 rounded-t-[2rem] border-t border-white/40 dark:border-slate-800/40 shadow-2xl max-h-[70vh] overflow-hidden">

        <!-- Drag Handle -->
        <div class="flex justify-center pt-3 pb-2 cursor-pointer" id="sheetHandle">
          <div class="w-10 h-1 bg-gray-300 dark:bg-gray-700 rounded-full"></div>
        </div>

        <!-- Sheet Header - Always Visible -->
        <div class="px-5 pb-4" id="sheetHeader">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-xs font-bold text-acc-green bg-green-100 dark:bg-green-900/30 px-2 py-0.5 rounded-full" id="sheetBadge">
                  OPEN
                </span>
              </div>
              <h2 class="text-xl font-bold dark:text-white" id="sheetTitle">Select a cycleway</h2>
              <div class="flex items-center gap-1 text-sm text-gray-500 dark:text-gray-400">
                <span class="material-icons-round text-acc-green text-sm">check_circle</span>
                <span id="sheetMeta">Tap on the map to view details</span>
              </div>
            </div>
            <div class="flex flex-col items-end">
              <div class="flex items-center gap-0.5 text-acc-yellow">
                <span class="material-icons-round text-sm">star</span>
                <span class="text-sm font-bold dark:text-white" id="sheetRating">--</span>
              </div>
              <span class="text-[10px] text-gray-400 uppercase tracking-wider font-bold" id="sheetReviewCount">-- Reviews</span>
            </div>
          </div>
        </div>

        <!-- Expandable Content -->
        <div class="px-5 pb-6 overflow-y-auto hide-scrollbar" id="sheetContent" style="max-height: calc(70vh - 120px);">

          <!-- Stats Grid -->
          <div class="grid grid-cols-2 gap-3 mb-6" id="sheetStats">
            <div class="bg-white/40 dark:bg-slate-800/40 p-3 rounded-2xl border border-white/20">
              <span class="text-[10px] text-gray-500 font-bold uppercase tracking-tight">Safety Score</span>
              <div class="flex items-center gap-2 mt-1">
                <div class="flex-1 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                  <div class="h-full bg-acc-green progress-bar" id="safetyBar" style="width: 0%"></div>
                </div>
                <span class="text-xs font-bold dark:text-white" id="safetyScore">--</span>
              </div>
            </div>
            <div class="bg-white/40 dark:bg-slate-800/40 p-3 rounded-2xl border border-white/20">
              <span class="text-[10px] text-gray-500 font-bold uppercase tracking-tight">Surface Quality</span>
              <div class="flex items-center gap-2 mt-1">
                <div class="flex-1 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                  <div class="h-full bg-primary progress-bar" id="surfaceBar" style="width: 0%"></div>
                </div>
                <span class="text-xs font-bold dark:text-white" id="surfaceScore">--</span>
              </div>
            </div>
          </div>

          <!-- Project Info -->
          <div id="projectInfo" class="mb-6 hidden">
            <div class="grid grid-cols-3 gap-3 mb-4">
              <div class="text-center">
                <div class="text-lg font-bold text-acc-green" id="projectBudget">--</div>
                <div class="text-[10px] text-gray-500 uppercase">Budget</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-bold text-primary" id="projectLength">--</div>
                <div class="text-[10px] text-gray-500 uppercase">Length</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-bold text-acc-yellow" id="projectCompletion">--</div>
                <div class="text-[10px] text-gray-500 uppercase">Completion</div>
              </div>
            </div>

            <p class="text-sm text-gray-600 dark:text-gray-300 mb-4" id="projectDescription"></p>

            <div id="projectBenefits" class="mb-4 hidden">
              <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Benefits</h4>
              <ul class="space-y-1" id="benefitsList"></ul>
            </div>

            <div id="projectConnections" class="hidden">
              <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Connects To</h4>
              <p class="text-sm text-gray-600 dark:text-gray-300" id="connectionsList"></p>
            </div>
          </div>

          <!-- Recent Review -->
          <div id="reviewSection" class="mb-6 hidden">
            <div class="flex items-center gap-2 mb-2">
              <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center">
                <span class="text-white text-xs font-bold" id="reviewerInitial">A</span>
              </div>
              <span class="text-xs font-semibold dark:text-white" id="reviewerName">Alex M.</span>
              <span class="text-[10px] text-gray-400" id="reviewTime">2h ago</span>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-300 italic" id="reviewText">"Great infrastructure!"</p>
          </div>

          <!-- Action Buttons -->
          <div class="flex gap-3">
            <button id="directionsBtn" class="flex-1 bg-primary text-white font-bold py-3 rounded-2xl flex items-center justify-center gap-2 shadow-lg shadow-primary/30 hover:bg-primary/90 transition-colors">
              <span class="material-icons-round">directions</span>
              Get Directions
            </button>
            <button id="favoriteBtn" class="w-14 h-14 bg-white dark:bg-slate-800 text-gray-400 rounded-2xl flex items-center justify-center border border-gray-100 dark:border-slate-700 hover:text-red-500 transition-colors">
              <span class="material-icons-round">favorite_border</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Dark Mode Toggle -->
    <button id="darkModeBtn" class="fixed bottom-4 right-4 z-50 w-12 h-12 rounded-full bg-white dark:bg-slate-800 shadow-xl flex items-center justify-center border border-gray-200 dark:border-slate-700 hover:scale-105 transition-transform">
      <span class="material-icons-round dark:text-white">dark_mode</span>
    </button>

    <!-- Report Modal -->
    <div id="reportModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" onclick="closeReportModal()"></div>
      <div class="modal-content glass bg-white/95 dark:bg-slate-900/95 rounded-3xl border border-white/40 shadow-2xl w-full max-w-md p-6 relative">
        <button onclick="closeReportModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center">
          <span class="material-icons-round text-gray-500">close</span>
        </button>

        <h2 class="text-xl font-bold dark:text-white mb-4">Report an Issue</h2>

        <div class="grid grid-cols-4 gap-2 mb-6">
          <button class="report-type flex flex-col items-center p-3 rounded-xl bg-gray-50 dark:bg-slate-800 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors" data-type="glass">
            <span class="text-2xl mb-1">üî∂</span>
            <span class="text-[10px] font-medium dark:text-white">Glass</span>
          </button>
          <button class="report-type flex flex-col items-center p-3 rounded-xl bg-gray-50 dark:bg-slate-800 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors" data-type="pothole">
            <span class="text-2xl mb-1">üï≥Ô∏è</span>
            <span class="text-[10px] font-medium dark:text-white">Pothole</span>
          </button>
          <button class="report-type flex flex-col items-center p-3 rounded-xl bg-gray-50 dark:bg-slate-800 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors" data-type="construction">
            <span class="text-2xl mb-1">üöß</span>
            <span class="text-[10px] font-medium dark:text-white">Works</span>
          </button>
          <button class="report-type flex flex-col items-center p-3 rounded-xl bg-gray-50 dark:bg-slate-800 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors" data-type="hazard">
            <span class="text-2xl mb-1">‚ö†Ô∏è</span>
            <span class="text-[10px] font-medium dark:text-white">Hazard</span>
          </button>
        </div>

        <textarea class="w-full p-3 rounded-xl bg-gray-50 dark:bg-slate-800 border-none focus:ring-2 focus:ring-primary text-sm dark:text-white placeholder-gray-400 resize-none" rows="3" placeholder="Describe the issue (optional)..."></textarea>

        <button class="w-full mt-4 bg-primary text-white font-bold py-3 rounded-2xl shadow-lg shadow-primary/30 hover:bg-primary/90 transition-colors">
          Submit Report
        </button>
      </div>
    </div>

    <!-- Community Modal -->
    <div id="communityModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" onclick="closeCommunityModal()"></div>
      <div class="modal-content glass bg-white/95 dark:bg-slate-900/95 rounded-3xl border border-white/40 shadow-2xl w-full max-w-lg p-6 relative max-h-[85vh] overflow-hidden flex flex-col">
        <button onclick="closeCommunityModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center z-10">
          <span class="material-icons-round text-gray-500">close</span>
        </button>

        <h2 class="text-xl font-bold dark:text-white mb-4">Community Hub</h2>

        <!-- Tabs -->
        <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar">
          <button class="community-tab px-4 py-2 rounded-full text-sm font-semibold bg-primary text-white whitespace-nowrap" data-tab="feed">Feed</button>
          <button class="community-tab px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 whitespace-nowrap" data-tab="groups">Groups</button>
          <button class="community-tab px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 whitespace-nowrap" data-tab="charging">‚ö° Charging</button>
          <button class="community-tab px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 whitespace-nowrap" data-tab="stores">üè™ Stores</button>
        </div>

        <div class="overflow-y-auto flex-1 hide-scrollbar">
          <!-- Feed Tab -->
          <div id="tabFeed" class="tab-content space-y-3">
            <!-- Populated by JS -->
          </div>

          <!-- Groups Tab -->
          <div id="tabGroups" class="tab-content space-y-3 hidden">
            <!-- Populated by JS -->
          </div>

          <!-- Charging Tab -->
          <div id="tabCharging" class="tab-content space-y-3 hidden">
            <!-- Populated by JS -->
          </div>

          <!-- Stores Tab -->
          <div id="tabStores" class="tab-content space-y-3 hidden">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>
    </div>

    <!-- Layers Modal -->
    <div id="layersModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" onclick="closeLayersModal()"></div>
      <div class="modal-content glass bg-white/95 dark:bg-slate-900/95 rounded-3xl border border-white/40 shadow-2xl w-full max-w-sm p-6 relative">
        <button onclick="closeLayersModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center">
          <span class="material-icons-round text-gray-500">close</span>
        </button>

        <h2 class="text-xl font-bold dark:text-white mb-4">Map Layers</h2>

        <div class="space-y-3">
          <label class="flex items-center justify-between p-3 rounded-xl bg-gray-50 dark:bg-slate-800 cursor-pointer">
            <div class="flex items-center gap-3">
              <span class="text-xl">‚ö°</span>
              <span class="font-medium dark:text-white">E-Bike Charging</span>
            </div>
            <input type="checkbox" id="layerCharging" checked class="w-5 h-5 rounded text-primary focus:ring-primary">
          </label>

          <label class="flex items-center justify-between p-3 rounded-xl bg-gray-50 dark:bg-slate-800 cursor-pointer">
            <div class="flex items-center gap-3">
              <span class="text-xl">üè™</span>
              <span class="font-medium dark:text-white">E-Bike Stores</span>
            </div>
            <input type="checkbox" id="layerStores" checked class="w-5 h-5 rounded text-primary focus:ring-primary">
          </label>

          <label class="flex items-center justify-between p-3 rounded-xl bg-gray-50 dark:bg-slate-800 cursor-pointer">
            <div class="flex items-center gap-3">
              <span class="text-xl">üë•</span>
              <span class="font-medium dark:text-white">Communities</span>
            </div>
            <input type="checkbox" id="layerCommunities" checked class="w-5 h-5 rounded text-primary focus:ring-primary">
          </label>

          <div class="h-px bg-gray-200 dark:bg-gray-700 my-2"></div>

          <label class="flex items-center justify-between p-3 rounded-xl bg-gradient-to-r from-pink-50 to-purple-50 dark:from-pink-900/20 dark:to-purple-900/20 cursor-pointer">
            <div class="flex items-center gap-3">
              <span class="text-xl">üõ§Ô∏è</span>
              <span class="font-medium dark:text-white">Veloways (Regional)</span>
            </div>
            <input type="checkbox" id="layerVeloways" checked class="w-5 h-5 rounded text-pink-500 focus:ring-pink-500">
          </label>
        </div>
      </div>
    </div>

    <!-- POI Detail Modal -->
    <div id="poiModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" onclick="closePoiModal()"></div>
      <div class="modal-content glass bg-white/95 dark:bg-slate-900/95 rounded-3xl border border-white/40 shadow-2xl w-full max-w-md p-6 relative max-h-[85vh] overflow-y-auto">
        <button onclick="closePoiModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center">
          <span class="material-icons-round text-gray-500">close</span>
        </button>

        <div id="poiContent">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>

    <!-- Comments Modal -->
    <div id="commentsModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" onclick="closeCommentsModal()"></div>
      <div class="modal-content glass bg-white/95 dark:bg-slate-900/95 rounded-3xl border border-white/40 shadow-2xl w-full max-w-md p-6 relative max-h-[85vh] overflow-hidden flex flex-col">
        <button onclick="closeCommentsModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center z-10">
          <span class="material-icons-round text-gray-500">close</span>
        </button>

        <h2 class="text-xl font-bold dark:text-white mb-2" id="commentsTitle">Comments</h2>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4" id="commentsSubtitle">Community feedback</p>

        <div class="overflow-y-auto flex-1 hide-scrollbar mb-4" id="commentsList">
          <!-- Populated by JS -->
        </div>

        <!-- Add Comment -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
          <textarea id="newComment" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-slate-800 border-none focus:ring-2 focus:ring-primary text-sm dark:text-white placeholder-gray-400 resize-none" rows="2" placeholder="Add a comment..."></textarea>
          <button onclick="submitComment()" class="w-full mt-2 bg-primary text-white font-bold py-2 rounded-xl hover:bg-primary/90 transition-colors">
            Post Comment
          </button>
        </div>
      </div>
    </div>

    <!-- AI Route Planning Modal -->
    <div id="aiRouteModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" onclick="closeAiRouteModal()"></div>
      <div class="modal-content glass bg-white/95 dark:bg-slate-900/95 rounded-3xl border border-white/40 shadow-2xl w-full max-w-md p-6 relative max-h-[90vh] overflow-hidden flex flex-col">
        <button onclick="closeAiRouteModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center z-10">
          <span class="material-icons-round text-gray-500">close</span>
        </button>

        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center">
            <span class="material-icons-round text-white">auto_awesome</span>
          </div>
          <div>
            <h2 class="text-xl font-bold dark:text-white">AI Route Planner</h2>
            <p class="text-xs text-gray-500">Powered by Gemini</p>
          </div>
        </div>

        <!-- Route Inputs -->
        <div class="space-y-3 mb-4">
          <div>
            <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">From</label>
            <div class="flex items-center gap-2 bg-gray-50 dark:bg-slate-800 rounded-xl p-3">
              <span class="material-icons-round text-acc-green">my_location</span>
              <input id="aiRouteFrom" type="text" placeholder="Current location or address" class="flex-1 bg-transparent border-none focus:ring-0 text-sm dark:text-white placeholder-gray-400">
            </div>
          </div>
          <div>
            <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">To</label>
            <div class="flex items-center gap-2 bg-gray-50 dark:bg-slate-800 rounded-xl p-3">
              <span class="material-icons-round text-red-500">place</span>
              <input id="aiRouteTo" type="text" placeholder="Destination address" class="flex-1 bg-transparent border-none focus:ring-0 text-sm dark:text-white placeholder-gray-400">
            </div>
          </div>
        </div>

        <!-- Preference Toggles -->
        <div class="mb-4">
          <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Route Preferences</label>
          <div class="grid grid-cols-2 gap-2">
            <label class="route-pref flex items-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-slate-800 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
              <input type="checkbox" id="prefCoffee" class="w-4 h-4 rounded text-primary focus:ring-primary">
              <span class="text-lg">‚òï</span>
              <span class="text-sm font-medium dark:text-white">Coffee Stop</span>
            </label>
            <label class="route-pref flex items-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-slate-800 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
              <input type="checkbox" id="prefShade" class="w-4 h-4 rounded text-primary focus:ring-primary">
              <span class="text-lg">üå≥</span>
              <span class="text-sm font-medium dark:text-white">Shady Route</span>
            </label>
            <label class="route-pref flex items-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-slate-800 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
              <input type="checkbox" id="prefScenic" class="w-4 h-4 rounded text-primary focus:ring-primary">
              <span class="text-lg">üåä</span>
              <span class="text-sm font-medium dark:text-white">Scenic Views</span>
            </label>
            <label class="route-pref flex items-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-slate-800 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
              <input type="checkbox" id="prefCharging" class="w-4 h-4 rounded text-primary focus:ring-primary">
              <span class="text-lg">‚ö°</span>
              <span class="text-sm font-medium dark:text-white">E-Bike Charging</span>
            </label>
            <label class="route-pref flex items-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-slate-800 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
              <input type="checkbox" id="prefFlat" class="w-4 h-4 rounded text-primary focus:ring-primary">
              <span class="text-lg">üìâ</span>
              <span class="text-sm font-medium dark:text-white">Flat Terrain</span>
            </label>
            <label class="route-pref flex items-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-slate-800 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
              <input type="checkbox" id="prefSafe" class="w-4 h-4 rounded text-primary focus:ring-primary">
              <span class="text-lg">üõ°Ô∏è</span>
              <span class="text-sm font-medium dark:text-white">Safest Route</span>
            </label>
          </div>
        </div>

        <!-- Custom Request -->
        <div class="mb-4">
          <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Special Requests (Optional)</label>
          <textarea id="aiRouteCustom" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-slate-800 border-none focus:ring-2 focus:ring-primary text-sm dark:text-white placeholder-gray-400 resize-none" rows="2" placeholder="e.g., 'Stop at a bakery near Surry Hills' or 'Avoid busy roads'"></textarea>
        </div>

        <!-- Generate Button -->
        <button id="generateRouteBtn" onclick="generateAiRoute()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-4 rounded-2xl shadow-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
          <span class="material-icons-round">auto_awesome</span>
          Generate Smart Route
        </button>

        <!-- Loading State -->
        <div id="aiRouteLoading" class="hidden">
          <div class="flex flex-col items-center justify-center py-8">
            <div class="w-16 h-16 rounded-full border-4 border-purple-200 border-t-purple-500 animate-spin mb-4"></div>
            <p class="text-sm font-medium dark:text-white">AI is planning your perfect route...</p>
            <p class="text-xs text-gray-500">Analyzing preferences & local data</p>
          </div>
        </div>

        <!-- AI Response -->
        <div id="aiRouteResult" class="hidden mt-4 overflow-y-auto max-h-[40vh]">
          <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-xl p-4">
            <div class="flex items-center gap-2 mb-3">
              <span class="material-icons-round text-purple-500">smart_toy</span>
              <span class="font-bold dark:text-white">AI Route Suggestion</span>
            </div>
            <div id="aiRouteText" class="text-sm text-gray-700 dark:text-gray-300 space-y-2">
              <!-- AI response will be populated here -->
            </div>
          </div>

          <!-- Route Preview -->
          <div id="aiRouteStops" class="mt-4 space-y-2">
            <!-- Stops will be populated here -->
          </div>

          <!-- Action Buttons -->
          <div class="flex gap-3 mt-4">
            <button onclick="applyAiRoute()" class="flex-1 bg-acc-green text-white font-bold py-3 rounded-2xl flex items-center justify-center gap-2 shadow-lg hover:bg-acc-green/90 transition-colors">
              <span class="material-icons-round">directions</span>
              Use This Route
            </button>
            <button onclick="regenerateAiRoute()" class="w-14 h-14 bg-gray-100 dark:bg-slate-800 rounded-2xl flex items-center justify-center hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors">
              <span class="material-icons-round text-gray-600 dark:text-gray-300">refresh</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Education & Rewards Modal -->
    <div id="educationModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" onclick="closeEducationModal()"></div>
      <div class="modal-content glass bg-white/95 dark:bg-slate-900/95 rounded-3xl border border-white/40 shadow-2xl w-full max-w-lg p-6 relative max-h-[90vh] overflow-hidden flex flex-col">
        <button onclick="closeEducationModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center z-10">
          <span class="material-icons-round text-gray-500">close</span>
        </button>

        <!-- Header with Points -->
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-tr from-blue-500 to-cyan-400 flex items-center justify-center">
              <span class="material-icons-round text-white text-2xl">school</span>
            </div>
            <div>
              <h2 class="text-xl font-bold dark:text-white">Learn & Earn</h2>
              <p class="text-xs text-gray-500">Complete modules, earn rewards</p>
            </div>
          </div>
          <div class="text-right">
            <div class="text-2xl font-bold text-acc-blue" id="eduTotalPoints">850</div>
            <div class="text-[10px] text-gray-500 uppercase">Points</div>
          </div>
        </div>

        <!-- Level Progress -->
        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20 rounded-xl p-4 mb-4">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="text-xl" id="eduLevelIcon">üö¥</span>
              <span class="font-bold dark:text-white" id="eduLevelName">Confident Cyclist</span>
            </div>
            <span class="text-xs text-gray-500" id="eduLevelLabel">Level 3</span>
          </div>
          <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-blue-500 to-cyan-400 progress-bar" id="eduLevelBar" style="width: 70%"></div>
          </div>
          <div class="flex justify-between mt-1 text-xs text-gray-500">
            <span id="eduPointsCurrent">850</span>
            <span id="eduPointsNext">500 more to Urban Navigator</span>
          </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar">
          <button class="edu-tab px-4 py-2 rounded-full text-sm font-semibold bg-acc-blue text-white whitespace-nowrap" data-tab="modules">üìö Modules</button>
          <button class="edu-tab px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 whitespace-nowrap" data-tab="rewards">üéÅ Rewards</button>
          <button class="edu-tab px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 whitespace-nowrap" data-tab="badges">üèÖ Badges</button>
        </div>

        <div class="overflow-y-auto flex-1 hide-scrollbar">
          <!-- Modules Tab -->
          <div id="eduTabModules" class="edu-tab-content space-y-3">
            <!-- Populated by JS -->
          </div>

          <!-- Rewards Tab -->
          <div id="eduTabRewards" class="edu-tab-content space-y-3 hidden">
            <!-- Populated by JS -->
          </div>

          <!-- Badges Tab -->
          <div id="eduTabBadges" class="edu-tab-content space-y-3 hidden">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>
    </div>

    <!-- Quiz Modal -->
    <div id="quizModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" onclick="closeQuizModal()"></div>
      <div class="modal-content glass bg-white/95 dark:bg-slate-900/95 rounded-3xl border border-white/40 shadow-2xl w-full max-w-md p-6 relative max-h-[90vh] overflow-hidden flex flex-col">
        <button onclick="closeQuizModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center z-10">
          <span class="material-icons-round text-gray-500">close</span>
        </button>

        <!-- Quiz Header -->
        <div class="mb-4">
          <h2 class="text-xl font-bold dark:text-white" id="quizTitle">Road Rules Quiz</h2>
          <div class="flex items-center gap-2 mt-1">
            <span class="text-xs text-gray-500" id="quizProgress">Question 1 of 5</span>
            <div class="flex-1 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
              <div class="h-full bg-acc-blue progress-bar" id="quizProgressBar" style="width: 20%"></div>
            </div>
          </div>
        </div>

        <!-- Quiz Content -->
        <div id="quizContent" class="flex-1 overflow-y-auto">
          <!-- Question -->
          <div id="quizQuestion" class="mb-6">
            <p class="text-lg font-medium dark:text-white" id="quizQuestionText">What is the fine for not wearing a helmet in NSW?</p>
          </div>

          <!-- Options -->
          <div id="quizOptions" class="space-y-2">
            <!-- Populated by JS -->
          </div>

          <!-- Explanation (shown after answer) -->
          <div id="quizExplanation" class="hidden mt-4 p-4 rounded-xl bg-blue-50 dark:bg-blue-900/20">
            <div class="flex items-start gap-2">
              <span class="material-icons-round text-acc-blue">info</span>
              <p class="text-sm text-gray-700 dark:text-gray-300" id="quizExplanationText"></p>
            </div>
          </div>
        </div>

        <!-- Quiz Actions -->
        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
          <button id="quizNextBtn" onclick="nextQuizQuestion()" class="hidden w-full bg-acc-blue text-white font-bold py-3 rounded-2xl shadow-lg hover:bg-acc-blue/90 transition-colors">
            Next Question
          </button>
          <div id="quizScore" class="hidden text-center">
            <div class="text-4xl mb-2" id="quizScoreEmoji">üéâ</div>
            <div class="text-2xl font-bold text-acc-green" id="quizScoreText">+50 Points!</div>
            <p class="text-sm text-gray-500 mt-1" id="quizScoreDetail">You got 5/5 correct!</p>
            <button onclick="closeQuizModal()" class="mt-4 w-full bg-acc-green text-white font-bold py-3 rounded-2xl">
              Collect Points
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Module Content Modal -->
    <div id="moduleModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" onclick="closeModuleModal()"></div>
      <div class="modal-content glass bg-white/95 dark:bg-slate-900/95 rounded-3xl border border-white/40 shadow-2xl w-full max-w-md p-6 relative max-h-[90vh] overflow-hidden flex flex-col">
        <button onclick="closeModuleModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center z-10">
          <span class="material-icons-round text-gray-500">close</span>
        </button>

        <!-- Module Header -->
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 rounded-xl bg-gradient-to-tr from-blue-500 to-cyan-400 flex items-center justify-center">
            <span class="text-2xl" id="moduleIcon">üìú</span>
          </div>
          <div>
            <h2 class="text-lg font-bold dark:text-white" id="moduleTitle">Module Title</h2>
            <p class="text-xs text-gray-500" id="moduleMeta">8 min ‚Ä¢ 100 points</p>
          </div>
        </div>

        <!-- Progress -->
        <div class="flex items-center gap-2 mb-4">
          <span class="text-xs text-gray-500" id="moduleSectionProgress">Section 1 of 4</span>
          <div class="flex-1 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
            <div class="h-full bg-acc-blue progress-bar" id="moduleSectionBar" style="width: 25%"></div>
          </div>
        </div>

        <!-- Content -->
        <div id="moduleContent" class="flex-1 overflow-y-auto">
          <h3 class="font-bold dark:text-white mb-2" id="moduleSectionTitle">Section Title</h3>
          <p class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed" id="moduleSectionText">
            Section content here...
          </p>
        </div>

        <!-- Actions -->
        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex gap-3">
          <button id="modulePrevBtn" onclick="prevModuleSection()" class="flex-1 bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-white font-bold py-3 rounded-2xl hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors">
            Previous
          </button>
          <button id="moduleNextBtn" onclick="nextModuleSection()" class="flex-1 bg-acc-blue text-white font-bold py-3 rounded-2xl shadow-lg hover:bg-acc-blue/90 transition-colors">
            Next
          </button>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast fixed bottom-20 left-1/2 -translate-x-1/2 z-50 glass bg-slate-900/90 text-white px-6 py-3 rounded-full flex items-center gap-2 shadow-xl">
      <span class="material-icons-round text-acc-green">check_circle</span>
      <span id="toastMessage">Thanks, legend!</span>
    </div>

  </div>

  <!-- Config (contains API key - not committed to git) -->
  <script src="js/config.js"></script>

  <!-- Google Maps API (loaded dynamically) -->
  <script>
    // Load Google Maps with API key from config
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${window.GOOGLE_MAPS_API_KEY || 'YOUR_API_KEY'}&libraries=places,geometry&callback=initMap`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
  </script>

  <!-- Data -->
  <script src="js/data-planned.js"></script>
  <script src="js/data-community.js"></script>
  <script src="js/data-education.js"></script>
  <script src="js/data-veloways.js"></script>

  <!-- App Logic -->
  <script>
    // ============================================
    // GLOBAL STATE
    // ============================================
    let map = null;
    let polylines = [];
    let poiMarkers = [];
    let selectedProject = null;
    let selectedPoi = null;
    let currentView = 'current';
    let isSheetExpanded = false;
    let showCharging = true;
    let showStores = true;
    let showCommunities = true;
    let showVeloways = true;

    // ============================================
    // MAP INITIALIZATION
    // ============================================
    function initMap() {
      // Sydney CBD center
      const sydneyCenter = { lat: -33.8688, lng: 151.2093 };

      map = new google.maps.Map(document.getElementById('map'), {
        center: sydneyCenter,
        zoom: 14,
        disableDefaultUI: true,
        zoomControl: true,
        zoomControlOptions: {
          position: google.maps.ControlPosition.RIGHT_CENTER
        },
        styles: getMapStyles()
      });

      // Add cycleways to map
      addCyclewaysToMap();

      // Add POI markers
      addPoiMarkers();

      // Map click - deselect
      map.addListener('click', () => {
        deselectProject();
      });

      // Update stats
      updateStats('current');
    }

    // ============================================
    // ADD POI MARKERS
    // ============================================
    function addPoiMarkers() {
      // Charging Stations
      if (typeof EBIKE_CHARGING_STATIONS !== 'undefined') {
        EBIKE_CHARGING_STATIONS.forEach(station => {
          const marker = createPoiMarker(station, '‚ö°', '#10B981', 'charging');
          poiMarkers.push(marker);
        });
      }

      // E-Bike Stores
      if (typeof EBIKE_STORES !== 'undefined') {
        EBIKE_STORES.forEach(store => {
          const marker = createPoiMarker(store, 'üè™', '#3B82F6', 'store');
          poiMarkers.push(marker);
        });
      }

      // Communities
      if (typeof BIKE_COMMUNITIES !== 'undefined') {
        BIKE_COMMUNITIES.forEach(community => {
          const marker = createPoiMarker(community, 'üë•', '#F59E0B', 'community');
          poiMarkers.push(marker);
        });
      }
    }

    function createPoiMarker(poi, emoji, color, type) {
      const marker = new google.maps.Marker({
        position: poi.location,
        map: map,
        icon: {
          url: `data:image/svg+xml,${encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="50" viewBox="0 0 40 50">
              <defs>
                <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                  <feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.3"/>
                </filter>
              </defs>
              <path d="M20 0 C9 0 0 9 0 20 C0 35 20 50 20 50 C20 50 40 35 40 20 C40 9 31 0 20 0Z" fill="${color}" filter="url(#shadow)"/>
              <circle cx="20" cy="18" r="12" fill="white"/>
              <text x="20" y="23" text-anchor="middle" font-size="14">${emoji}</text>
            </svg>
          `)}`,
          scaledSize: new google.maps.Size(40, 50),
          anchor: new google.maps.Point(20, 50)
        },
        title: poi.name
      });

      marker.poiData = poi;
      marker.poiType = type;

      marker.addListener('click', () => {
        openPoiDetail(poi, type);
      });

      return marker;
    }

    function updatePoiVisibility() {
      poiMarkers.forEach(marker => {
        const type = marker.poiType;
        let visible = false;

        if (type === 'charging' && showCharging) visible = true;
        if (type === 'store' && showStores) visible = true;
        if (type === 'community' && showCommunities) visible = true;

        marker.setMap(visible ? map : null);
      });
    }

    function updateVelowayVisibility() {
      polylines.forEach(polyline => {
        if (polyline.isVeloway) {
          const project = polyline.projectData;
          let shouldShow = showVeloways;

          // Also respect the current network view filter
          if (shouldShow) {
            switch (currentView) {
              case 'current':
                shouldShow = project.status === 'existing';
                break;
              case 'future':
                shouldShow = ['existing', 'under_construction', 'funded'].includes(project.status);
                break;
              case 'all':
                shouldShow = true;
                break;
            }
          }

          polyline.setMap(shouldShow ? map : null);
        }
      });
    }

    // ============================================
    // MAP STYLES
    // ============================================
    function getMapStyles() {
      const isDark = document.documentElement.classList.contains('dark');

      if (isDark) {
        return [
          { elementType: "geometry", stylers: [{ color: "#1a1a2e" }] },
          { elementType: "labels.text.stroke", stylers: [{ color: "#1a1a2e" }] },
          { elementType: "labels.text.fill", stylers: [{ color: "#8a8a8a" }] },
          { featureType: "road", elementType: "geometry", stylers: [{ color: "#2d2d44" }] },
          { featureType: "water", elementType: "geometry", stylers: [{ color: "#0e1626" }] },
          { featureType: "poi", stylers: [{ visibility: "off" }] },
          { featureType: "transit", stylers: [{ visibility: "off" }] }
        ];
      }

      return [
        { featureType: "water", elementType: "geometry", stylers: [{ color: "#e9e9e9" }] },
        { featureType: "road", elementType: "geometry.fill", stylers: [{ color: "#ffffff" }] },
        { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#e0e0e0" }] },
        { featureType: "poi", stylers: [{ visibility: "off" }] },
        { featureType: "transit", stylers: [{ visibility: "off" }] }
      ];
    }

    // ============================================
    // ADD CYCLEWAYS TO MAP
    // ============================================
    function addCyclewaysToMap() {
      if (typeof EXISTING_CYCLEWAYS !== 'undefined') {
        EXISTING_CYCLEWAYS.forEach(cycleway => {
          if (!cycleway.coordinates || cycleway.coordinates.length < 2) return;
          createPolyline(cycleway);
        });
      }

      if (typeof PLANNED_CYCLEWAYS !== 'undefined') {
        PLANNED_CYCLEWAYS.forEach(project => {
          if (!project.coordinates || project.coordinates.length < 2) return;
          createPolyline(project);
        });
      }

      // Add Veloway Routes (Eastern Sydney Regional Bike Network)
      if (typeof VELOWAY_ROUTES !== 'undefined') {
        VELOWAY_ROUTES.forEach(veloway => {
          if (!veloway.coordinates || veloway.coordinates.length < 2) return;
          createPolyline(veloway, true); // true = is veloway
        });
      }

      // Apply initial view filter
      switchNetworkView('current');
    }

    function createPolyline(project, isVeloway = false) {
      const color = getStatusColor(project.status);
      const isPlanned = project.status === 'planned' || project.status === 'proposed';
      const baseWeight = isVeloway ? 8 : 6;
      const hoverWeight = isVeloway ? 12 : 10;

      const polylineOptions = {
        path: project.coordinates,
        strokeColor: isVeloway ? '#EC4899' : color, // Pink for veloways
        strokeOpacity: isPlanned ? 0 : (isVeloway ? 0.9 : 1),
        strokeWeight: baseWeight,
        map: null,
        zIndex: isVeloway ? 150 : (project.status === 'existing' ? 100 : 50)
      };

      const polyline = new google.maps.Polyline(polylineOptions);

      // Dashed line for planned/proposed
      if (isPlanned) {
        polyline.setOptions({
          icons: [{
            icon: {
              path: 'M 0,-1 0,1',
              strokeOpacity: 0.8,
              strokeColor: isVeloway ? '#EC4899' : color,
              strokeWeight: baseWeight,
              scale: isVeloway ? 5 : 4
            },
            offset: '0',
            repeat: isVeloway ? '25px' : '20px'
          }]
        });
      }

      polyline.projectData = project;
      polyline.isVeloway = isVeloway;
      polylines.push(polyline);

      // Click listener
      polyline.addListener('click', () => {
        selectProject(project);
      });

      // Hover effects
      polyline.addListener('mouseover', () => {
        polyline.setOptions({ strokeWeight: hoverWeight });
      });

      polyline.addListener('mouseout', () => {
        polyline.setOptions({ strokeWeight: baseWeight });
      });
    }

    function getStatusColor(status) {
      const colors = {
        'existing': '#22C55E',
        'completed_2026': '#10B981',
        'under_construction': '#F59E0B',
        'funded': '#3B82F6',
        'planned': '#8B5CF6',
        'proposed': '#6B7280'
      };
      return colors[status] || '#6B7280';
    }

    // ============================================
    // SWITCH NETWORK VIEW
    // ============================================
    function switchNetworkView(view) {
      currentView = view;

      polylines.forEach(polyline => {
        const project = polyline.projectData;
        let shouldShow = false;

        // Check if veloway layer is enabled
        if (polyline.isVeloway && !showVeloways) {
          polyline.setMap(null);
          return;
        }

        switch (view) {
          case 'current':
            shouldShow = project.status === 'existing';
            break;
          case 'future':
            shouldShow = ['existing', 'completed_2026', 'under_construction', 'funded'].includes(project.status);
            break;
          case 'all':
            shouldShow = true;
            break;
        }

        polyline.setMap(shouldShow ? map : null);
      });

      updateStats(view);
    }

    // ============================================
    // UPDATE STATS
    // ============================================
    function updateStats(view) {
      const stats = typeof NETWORK_STATS !== 'undefined' ? NETWORK_STATS : null;
      if (!stats) return;

      let data;
      switch (view) {
        case 'current':
          data = stats.current;
          break;
        case 'future':
          data = stats.planned_2026;
          break;
        case 'all':
          data = stats.strategic_2030;
          break;
      }

      if (data) {
        document.getElementById('statsKm').textContent = data.total_km || '--';
        document.getElementById('statsTrips').textContent =
          data.daily_trips ? (data.daily_trips / 1000).toFixed(0) + 'k' :
          data.estimated_daily_trips ? (data.estimated_daily_trips / 1000).toFixed(0) + 'k' : '--';
      }

      // Count projects
      const projectCount = polylines.filter(p => {
        const project = p.projectData;
        switch (view) {
          case 'current': return project.status === 'existing';
          case 'future': return ['existing', 'completed_2026', 'under_construction', 'funded'].includes(project.status);
          case 'all': return true;
        }
      }).length;
      document.getElementById('statsProjects').textContent = projectCount;
    }

    // ============================================
    // SELECT PROJECT
    // ============================================
    function selectProject(project) {
      selectedProject = project;

      // Update sheet content
      const statusLabels = {
        'existing': 'OPEN',
        'completed_2026': 'OPENED 2026',
        'under_construction': 'UNDER CONSTRUCTION',
        'funded': 'FUNDED',
        'planned': 'PLANNED',
        'proposed': 'UNDER INVESTIGATION'
      };

      const badge = document.getElementById('sheetBadge');
      badge.textContent = statusLabels[project.status] || project.status.toUpperCase();
      badge.className = 'text-xs font-bold px-2 py-0.5 rounded-full ';

      switch (project.status) {
        case 'existing':
        case 'completed_2026':
          badge.className += 'text-acc-green bg-green-100 dark:bg-green-900/30';
          break;
        case 'under_construction':
          badge.className += 'text-acc-orange bg-orange-100 dark:bg-orange-900/30';
          break;
        case 'funded':
          badge.className += 'text-acc-blue bg-blue-100 dark:bg-blue-900/30';
          break;
        case 'planned':
          badge.className += 'text-primary bg-purple-100 dark:bg-purple-900/30';
          break;
        default:
          badge.className += 'text-gray-600 bg-gray-100 dark:bg-gray-800';
      }

      document.getElementById('sheetTitle').textContent = project.name;
      document.getElementById('sheetMeta').textContent =
        (project.local_areas?.join(', ') || '') +
        (project.length_km ? ' ‚Ä¢ ' + project.length_km + ' km' : '');

      // Ratings
      const rating = project.daily_trips ? (project.daily_trips / 1000 + 3).toFixed(1) : '--';
      document.getElementById('sheetRating').textContent = rating;
      document.getElementById('sheetReviewCount').textContent =
        project.daily_trips ? Math.floor(project.daily_trips / 50) + ' Reviews' : '-- Reviews';

      // Safety/Surface scores (simulated)
      const safetyScore = project.facility_type === 'separated_cycleway' ? 8.5 : 6.0;
      const surfaceScore = project.status === 'existing' ? 7.5 : 8.0;

      document.getElementById('safetyBar').style.width = (safetyScore * 10) + '%';
      document.getElementById('safetyScore').textContent = safetyScore.toFixed(1);
      document.getElementById('surfaceBar').style.width = (surfaceScore * 10) + '%';
      document.getElementById('surfaceScore').textContent = surfaceScore.toFixed(1);

      // Project info
      const projectInfo = document.getElementById('projectInfo');
      if (project.budget_aud || project.description) {
        projectInfo.classList.remove('hidden');

        document.getElementById('projectBudget').textContent =
          project.budget_aud ? '$' + (project.budget_aud / 1000000).toFixed(1) + 'M' : 'TBC';
        document.getElementById('projectLength').textContent =
          project.length_km ? project.length_km + ' km' : '--';
        document.getElementById('projectCompletion').textContent =
          project.expected_completion || project.completion_date || 'TBC';
        document.getElementById('projectDescription').textContent = project.description || '';

        // Benefits
        const benefitsSection = document.getElementById('projectBenefits');
        const benefitsList = document.getElementById('benefitsList');
        if (project.benefits && project.benefits.length > 0) {
          benefitsSection.classList.remove('hidden');
          benefitsList.innerHTML = project.benefits.map(b =>
            `<li class="text-sm text-gray-600 dark:text-gray-300 flex items-start gap-2">
              <span class="text-acc-green">‚úì</span> ${b}
            </li>`
          ).join('');
        } else {
          benefitsSection.classList.add('hidden');
        }

        // Connections
        const connectionsSection = document.getElementById('projectConnections');
        if (project.connects_to && project.connects_to.length > 0) {
          connectionsSection.classList.remove('hidden');
          document.getElementById('connectionsList').textContent = project.connects_to.join(', ');
        } else {
          connectionsSection.classList.add('hidden');
        }
      } else {
        projectInfo.classList.add('hidden');
      }

      // Show review section for existing cycleways
      const reviewSection = document.getElementById('reviewSection');
      if (project.status === 'existing' && project.daily_trips) {
        reviewSection.classList.remove('hidden');
        document.getElementById('reviewText').textContent =
          '"Great protected lane, perfect for morning commutes!"';
      } else {
        reviewSection.classList.add('hidden');
      }

      // Expand sheet
      expandSheet();

      // Pan map
      if (project.coordinates && project.coordinates.length > 0) {
        const midIdx = Math.floor(project.coordinates.length / 2);
        map.panTo(project.coordinates[midIdx]);
      }
    }

    function deselectProject() {
      selectedProject = null;
      collapseSheet();

      document.getElementById('sheetTitle').textContent = 'Select a cycleway';
      document.getElementById('sheetMeta').textContent = 'Tap on the map to view details';
      document.getElementById('sheetBadge').textContent = 'BROWSE';
      document.getElementById('sheetBadge').className = 'text-xs font-bold px-2 py-0.5 rounded-full text-gray-600 bg-gray-100 dark:bg-gray-800';
      document.getElementById('sheetRating').textContent = '--';
      document.getElementById('sheetReviewCount').textContent = '-- Reviews';
      document.getElementById('projectInfo').classList.add('hidden');
      document.getElementById('reviewSection').classList.add('hidden');
    }

    // ============================================
    // BOTTOM SHEET
    // ============================================
    function expandSheet() {
      const sheet = document.getElementById('bottomSheet');
      sheet.classList.remove('collapsed');
      isSheetExpanded = true;
      document.getElementById('statsBanner').style.display = 'none';
    }

    function collapseSheet() {
      const sheet = document.getElementById('bottomSheet');
      sheet.classList.add('collapsed');
      isSheetExpanded = false;
      document.getElementById('statsBanner').style.display = 'block';
    }

    // ============================================
    // MODALS
    // ============================================
    function openReportModal() {
      document.getElementById('reportModal').classList.add('visible');
    }

    function closeReportModal() {
      document.getElementById('reportModal').classList.remove('visible');
    }

    function openCommunityModal() {
      document.getElementById('communityModal').classList.add('visible');
      loadCommunityFeed();
    }

    function closeCommunityModal() {
      document.getElementById('communityModal').classList.remove('visible');
    }

    function loadCommunityFeed() {
      // Load Feed Tab
      const feed = document.getElementById('tabFeed');
      if (typeof INFRASTRUCTURE_COMMENTS !== 'undefined') {
        feed.innerHTML = INFRASTRUCTURE_COMMENTS.map(comment => `
          <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl">
            <div class="flex items-center gap-2 mb-2">
              <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center">
                <span class="text-white text-xs font-bold">${comment.user.avatar}</span>
              </div>
              <span class="font-semibold dark:text-white">${comment.user.name}</span>
              ${comment.user.verified ? '<span class="material-icons-round text-acc-blue text-sm">verified</span>' : ''}
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">${comment.text}</p>
            <div class="flex items-center justify-between">
              <span class="text-xs text-gray-400">${formatTimeAgo(comment.timestamp)}</span>
              <div class="flex items-center gap-3">
                <button onclick="vote('${comment.id}', 'up')" class="flex items-center gap-1 text-xs text-gray-500 hover:text-acc-green transition-colors">
                  <span class="material-icons-round text-sm">thumb_up</span>
                  <span>${comment.upvotes}</span>
                </button>
                <button onclick="vote('${comment.id}', 'down')" class="flex items-center gap-1 text-xs text-gray-500 hover:text-red-500 transition-colors">
                  <span class="material-icons-round text-sm">thumb_down</span>
                  <span>${comment.downvotes}</span>
                </button>
              </div>
            </div>
          </div>
        `).join('');
      }

      // Load Groups Tab
      const groups = document.getElementById('tabGroups');
      if (typeof BIKE_COMMUNITIES !== 'undefined') {
        groups.innerHTML = BIKE_COMMUNITIES.map(comm => `
          <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl">
            <div class="flex justify-between items-start mb-2">
              <h3 class="font-bold dark:text-white">${comm.name}</h3>
              <span class="text-xs text-gray-400">${comm.members.toLocaleString()} members</span>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">${comm.description}</p>
            <div class="flex flex-wrap gap-1 mb-3">
              ${comm.focus.map(f => `<span class="text-xs px-2 py-0.5 rounded-full bg-primary/10 text-primary">${f}</span>`).join('')}
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <button onclick="vote('${comm.id}', 'up')" class="flex items-center gap-1 text-xs text-gray-500 hover:text-acc-green">
                  <span class="material-icons-round text-sm">thumb_up</span> ${comm.upvotes}
                </button>
                <button onclick="vote('${comm.id}', 'down')" class="flex items-center gap-1 text-xs text-gray-500 hover:text-red-500">
                  <span class="material-icons-round text-sm">thumb_down</span> ${comm.downvotes}
                </button>
              </div>
              <a href="${comm.website}" target="_blank" class="text-xs text-primary font-medium">Visit ‚Üí</a>
            </div>
          </div>
        `).join('');
      }

      // Load Charging Tab
      const charging = document.getElementById('tabCharging');
      if (typeof EBIKE_CHARGING_STATIONS !== 'undefined') {
        charging.innerHTML = EBIKE_CHARGING_STATIONS.map(station => `
          <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl" onclick="openPoiDetail(EBIKE_CHARGING_STATIONS.find(s => s.id === '${station.id}'), 'charging')">
            <div class="flex justify-between items-start mb-2">
              <div class="flex items-center gap-2">
                <span class="text-xl">‚ö°</span>
                <h3 class="font-bold dark:text-white">${station.name}</h3>
              </div>
              <span class="text-xs px-2 py-0.5 rounded-full ${station.available > 3 ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                ${station.available}/${station.capacity} available
              </span>
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">${station.address}</p>
            <div class="flex items-center gap-2 mb-2">
              ${station.amenities.slice(0, 3).map(a => `<span class="text-xs px-2 py-0.5 rounded-full bg-gray-200 dark:bg-gray-700 dark:text-gray-300">${getAmenityIcon(a)} ${getAmenityLabel(a)}</span>`).join('')}
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-1 text-acc-yellow">
                <span class="material-icons-round text-sm">star</span>
                <span class="text-sm font-bold dark:text-white">${station.rating}</span>
                <span class="text-xs text-gray-400">(${station.reviews})</span>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="event.stopPropagation(); vote('${station.id}', 'up')" class="flex items-center gap-1 text-xs text-gray-500 hover:text-acc-green">
                  <span class="material-icons-round text-sm">thumb_up</span> ${station.upvotes}
                </button>
                <button onclick="event.stopPropagation(); vote('${station.id}', 'down')" class="flex items-center gap-1 text-xs text-gray-500 hover:text-red-500">
                  <span class="material-icons-round text-sm">thumb_down</span> ${station.downvotes}
                </button>
              </div>
            </div>
          </div>
        `).join('');
      }

      // Load Stores Tab
      const stores = document.getElementById('tabStores');
      if (typeof EBIKE_STORES !== 'undefined') {
        stores.innerHTML = EBIKE_STORES.map(store => `
          <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl" onclick="openPoiDetail(EBIKE_STORES.find(s => s.id === '${store.id}'), 'store')">
            <div class="flex justify-between items-start mb-2">
              <div class="flex items-center gap-2">
                <span class="text-xl">üè™</span>
                <h3 class="font-bold dark:text-white">${store.name}</h3>
              </div>
              ${store.demo_available ? '<span class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700">Demos ‚úì</span>' : ''}
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">${store.address}</p>
            <div class="flex flex-wrap gap-1 mb-2">
              ${store.services.map(s => `<span class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400">${s}</span>`).join('')}
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-1 text-acc-yellow">
                <span class="material-icons-round text-sm">star</span>
                <span class="text-sm font-bold dark:text-white">${store.rating}</span>
                <span class="text-xs text-gray-400">(${store.reviews})</span>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="event.stopPropagation(); vote('${store.id}', 'up')" class="flex items-center gap-1 text-xs text-gray-500 hover:text-acc-green">
                  <span class="material-icons-round text-sm">thumb_up</span> ${store.upvotes}
                </button>
                <button onclick="event.stopPropagation(); vote('${store.id}', 'down')" class="flex items-center gap-1 text-xs text-gray-500 hover:text-red-500">
                  <span class="material-icons-round text-sm">thumb_down</span> ${store.downvotes}
                </button>
              </div>
            </div>
          </div>
        `).join('');
      }
    }

    // ============================================
    // POI DETAIL MODAL
    // ============================================
    function openPoiDetail(poi, type) {
      selectedPoi = poi;
      const content = document.getElementById('poiContent');

      if (type === 'charging') {
        content.innerHTML = `
          <div class="text-center mb-4">
            <span class="text-5xl">‚ö°</span>
          </div>
          <h2 class="text-xl font-bold dark:text-white text-center mb-1">${poi.name}</h2>
          <p class="text-sm text-gray-500 dark:text-gray-400 text-center mb-4">${poi.address}</p>

          <div class="flex justify-center gap-1 mb-4">
            ${[...Array(5)].map((_, i) => `<span class="material-icons-round ${i < Math.floor(poi.rating) ? 'text-acc-yellow' : 'text-gray-300'} text-xl">star</span>`).join('')}
            <span class="ml-2 font-bold dark:text-white">${poi.rating}</span>
          </div>

          <div class="bg-gray-50 dark:bg-slate-800 rounded-xl p-4 mb-4">
            <div class="flex justify-between items-center mb-2">
              <span class="text-sm text-gray-600 dark:text-gray-300">Available Spots</span>
              <span class="text-lg font-bold ${poi.available > 3 ? 'text-acc-green' : 'text-acc-orange'}">${poi.available}/${poi.capacity}</span>
            </div>
            <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
              <div class="h-full ${poi.available > 3 ? 'bg-acc-green' : 'bg-acc-orange'}" style="width: ${(poi.available / poi.capacity) * 100}%"></div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2 mb-4">
            ${poi.amenities.map(a => `
              <div class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-slate-800 rounded-lg">
                <span>${getAmenityIcon(a)}</span>
                <span class="text-sm dark:text-white">${getAmenityLabel(a)}</span>
              </div>
            `).join('')}
          </div>

          <div class="flex items-center justify-between mb-4 p-3 bg-gray-50 dark:bg-slate-800 rounded-xl">
            <span class="text-sm text-gray-600 dark:text-gray-300">Hours</span>
            <span class="font-medium dark:text-white">${poi.hours}</span>
          </div>

          <div class="flex items-center justify-center gap-6 mb-4">
            <button onclick="vote('${poi.id}', 'up')" class="flex flex-col items-center gap-1 p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors">
              <span class="material-icons-round text-2xl text-acc-green">thumb_up</span>
              <span class="text-sm font-bold dark:text-white">${poi.upvotes}</span>
            </button>
            <button onclick="vote('${poi.id}', 'down')" class="flex flex-col items-center gap-1 p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors">
              <span class="material-icons-round text-2xl text-red-500">thumb_down</span>
              <span class="text-sm font-bold dark:text-white">${poi.downvotes}</span>
            </button>
          </div>

          <button onclick="openCommentsForPoi('${poi.id}')" class="w-full bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-white font-bold py-3 rounded-2xl mb-3 hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors">
            üí¨ View Comments (${poi.reviews})
          </button>

          <button onclick="getDirectionsToPoi()" class="w-full bg-primary text-white font-bold py-3 rounded-2xl shadow-lg shadow-primary/30 hover:bg-primary/90 transition-colors">
            <span class="material-icons-round align-middle mr-1">directions</span> Get Directions
          </button>
        `;
      } else if (type === 'store') {
        content.innerHTML = `
          <div class="text-center mb-4">
            <span class="text-5xl">üè™</span>
          </div>
          <h2 class="text-xl font-bold dark:text-white text-center mb-1">${poi.name}</h2>
          <p class="text-sm text-gray-500 dark:text-gray-400 text-center mb-4">${poi.address}</p>

          <div class="flex justify-center gap-1 mb-4">
            ${[...Array(5)].map((_, i) => `<span class="material-icons-round ${i < Math.floor(poi.rating) ? 'text-acc-yellow' : 'text-gray-300'} text-xl">star</span>`).join('')}
            <span class="ml-2 font-bold dark:text-white">${poi.rating}</span>
          </div>

          ${poi.demo_available ? `
            <div class="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 p-3 rounded-xl text-center mb-4 font-medium">
              ‚úì Test Rides / Demos Available
            </div>
          ` : ''}

          <div class="mb-4">
            <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Services</h4>
            <div class="flex flex-wrap gap-2">
              ${poi.services.map(s => `<span class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400 text-sm">${s}</span>`).join('')}
            </div>
          </div>

          <div class="mb-4">
            <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Brands</h4>
            <div class="flex flex-wrap gap-2">
              ${poi.brands.map(b => `<span class="px-3 py-1 rounded-full bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-gray-300 text-sm">${b}</span>`).join('')}
            </div>
          </div>

          <div class="space-y-2 mb-4">
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-800 rounded-xl">
              <span class="text-sm text-gray-600 dark:text-gray-300">Hours</span>
              <span class="font-medium dark:text-white text-sm">${poi.hours}</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-800 rounded-xl">
              <span class="text-sm text-gray-600 dark:text-gray-300">Phone</span>
              <a href="tel:${poi.phone}" class="font-medium text-primary">${poi.phone}</a>
            </div>
          </div>

          <div class="flex items-center justify-center gap-6 mb-4">
            <button onclick="vote('${poi.id}', 'up')" class="flex flex-col items-center gap-1 p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors">
              <span class="material-icons-round text-2xl text-acc-green">thumb_up</span>
              <span class="text-sm font-bold dark:text-white">${poi.upvotes}</span>
            </button>
            <button onclick="vote('${poi.id}', 'down')" class="flex flex-col items-center gap-1 p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors">
              <span class="material-icons-round text-2xl text-red-500">thumb_down</span>
              <span class="text-sm font-bold dark:text-white">${poi.downvotes}</span>
            </button>
          </div>

          <button onclick="getDirectionsToPoi()" class="w-full bg-primary text-white font-bold py-3 rounded-2xl shadow-lg shadow-primary/30 hover:bg-primary/90 transition-colors">
            <span class="material-icons-round align-middle mr-1">directions</span> Get Directions
          </button>
        `;
      } else if (type === 'community') {
        content.innerHTML = `
          <div class="text-center mb-4">
            <span class="text-5xl">üë•</span>
          </div>
          <h2 class="text-xl font-bold dark:text-white text-center mb-1">${poi.name}</h2>
          <p class="text-sm text-gray-500 dark:text-gray-400 text-center mb-4">${poi.members.toLocaleString()} members</p>

          <p class="text-sm text-gray-600 dark:text-gray-300 text-center mb-4">${poi.description}</p>

          <div class="flex flex-wrap justify-center gap-2 mb-4">
            ${poi.focus.map(f => `<span class="px-3 py-1 rounded-full bg-primary/10 text-primary text-sm font-medium">${f}</span>`).join('')}
          </div>

          ${poi.rides && poi.rides.length > 0 ? `
            <div class="mb-4">
              <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Regular Rides</h4>
              <div class="space-y-2">
                ${poi.rides.map(r => `
                  <div class="p-3 bg-gray-50 dark:bg-slate-800 rounded-xl">
                    <div class="flex justify-between items-center">
                      <span class="font-medium dark:text-white">${r.type}</span>
                      <span class="text-xs px-2 py-0.5 rounded-full bg-gray-200 dark:bg-gray-700 dark:text-gray-300">${r.difficulty}</span>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">${r.day} at ${r.time}</p>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <div class="flex items-center justify-center gap-6 mb-4">
            <button onclick="vote('${poi.id}', 'up')" class="flex flex-col items-center gap-1 p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors">
              <span class="material-icons-round text-2xl text-acc-green">thumb_up</span>
              <span class="text-sm font-bold dark:text-white">${poi.upvotes}</span>
            </button>
            <button onclick="vote('${poi.id}', 'down')" class="flex flex-col items-center gap-1 p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors">
              <span class="material-icons-round text-2xl text-red-500">thumb_down</span>
              <span class="text-sm font-bold dark:text-white">${poi.downvotes}</span>
            </button>
          </div>

          <a href="https://${poi.website}" target="_blank" class="block w-full bg-primary text-white font-bold py-3 rounded-2xl text-center shadow-lg shadow-primary/30 hover:bg-primary/90 transition-colors">
            Visit Website ‚Üí
          </a>
        `;
      }

      document.getElementById('poiModal').classList.add('visible');

      // Pan to POI
      if (poi.location) {
        map.panTo(poi.location);
        map.setZoom(16);
      }
    }

    function closePoiModal() {
      document.getElementById('poiModal').classList.remove('visible');
      selectedPoi = null;
    }

    function getDirectionsToPoi() {
      if (selectedPoi && selectedPoi.location) {
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${selectedPoi.location.lat},${selectedPoi.location.lng}&travelmode=bicycling`, '_blank');
      }
    }

    // ============================================
    // LAYERS MODAL
    // ============================================
    function openLayersModal() {
      document.getElementById('layersModal').classList.add('visible');
    }

    function closeLayersModal() {
      document.getElementById('layersModal').classList.remove('visible');
    }

    // ============================================
    // COMMENTS MODAL
    // ============================================
    function openCommentsForPoi(poiId) {
      document.getElementById('commentsTitle').textContent = 'Comments';
      document.getElementById('commentsSubtitle').textContent = 'Community feedback';

      const commentsList = document.getElementById('commentsList');
      commentsList.innerHTML = `
        <div class="space-y-3">
          <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl">
            <div class="flex items-center gap-2 mb-2">
              <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-cyan-500 flex items-center justify-center">
                <span class="text-white text-xs font-bold">J</span>
              </div>
              <span class="font-semibold dark:text-white">Jake S.</span>
              <span class="text-xs text-gray-400">1 day ago</span>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-300">Great location! Always has spots available in the morning.</p>
            <div class="flex items-center gap-3 mt-2">
              <button class="flex items-center gap-1 text-xs text-gray-500 hover:text-acc-green">
                <span class="material-icons-round text-sm">thumb_up</span> 8
              </button>
              <button class="flex items-center gap-1 text-xs text-gray-500 hover:text-red-500">
                <span class="material-icons-round text-sm">thumb_down</span> 0
              </button>
            </div>
          </div>
          <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl">
            <div class="flex items-center gap-2 mb-2">
              <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-orange-500 to-red-500 flex items-center justify-center">
                <span class="text-white text-xs font-bold">M</span>
              </div>
              <span class="font-semibold dark:text-white">Maya T.</span>
              <span class="text-xs text-gray-400">3 days ago</span>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-300">Fast charging works perfectly. My e-bike was fully charged in under an hour.</p>
            <div class="flex items-center gap-3 mt-2">
              <button class="flex items-center gap-1 text-xs text-gray-500 hover:text-acc-green">
                <span class="material-icons-round text-sm">thumb_up</span> 12
              </button>
              <button class="flex items-center gap-1 text-xs text-gray-500 hover:text-red-500">
                <span class="material-icons-round text-sm">thumb_down</span> 1
              </button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('commentsModal').classList.add('visible');
    }

    function closeCommentsModal() {
      document.getElementById('commentsModal').classList.remove('visible');
    }

    function submitComment() {
      const textarea = document.getElementById('newComment');
      if (textarea.value.trim()) {
        showToast('Comment posted! üí¨');
        textarea.value = '';
        closeCommentsModal();
      }
    }

    // ============================================
    // VOTING
    // ============================================
    function vote(id, direction) {
      showToast(direction === 'up' ? 'Upvoted! üëç' : 'Downvoted üëé');
    }

    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    function formatTimeAgo(timestamp) {
      const now = new Date();
      const date = new Date(timestamp);
      const seconds = Math.floor((now - date) / 1000);

      if (seconds < 60) return 'just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
      return date.toLocaleDateString();
    }

    function getAmenityIcon(amenity) {
      const icons = {
        'fast_charging': '‚ö°',
        'secure_lock': 'üîí',
        'covered': 'üè†',
        'repair_tools': 'üîß',
        'student_discount': 'üéì'
      };
      return icons[amenity] || '‚úì';
    }

    function getAmenityLabel(amenity) {
      const labels = {
        'fast_charging': 'Fast Charging',
        'secure_lock': 'Secure Lock',
        'covered': 'Covered',
        'repair_tools': 'Repair Tools',
        'student_discount': 'Student Discount'
      };
      return labels[amenity] || amenity;
    }

    // ============================================
    // TOAST
    // ============================================
    function showToast(message) {
      const toast = document.getElementById('toast');
      document.getElementById('toastMessage').textContent = message;
      toast.classList.add('visible');
      setTimeout(() => toast.classList.remove('visible'), 3000);
    }

    // ============================================
    // AI ROUTE PLANNING (GEMINI)
    // ============================================
    let aiRoutePolyline = null;
    let aiRouteMarkers = [];
    let lastAiRouteData = null;

    function openAiRouteModal() {
      document.getElementById('aiRouteModal').classList.add('visible');
      // Reset state
      document.getElementById('generateRouteBtn').classList.remove('hidden');
      document.getElementById('aiRouteLoading').classList.add('hidden');
      document.getElementById('aiRouteResult').classList.add('hidden');
    }

    function closeAiRouteModal() {
      document.getElementById('aiRouteModal').classList.remove('visible');
    }

    async function generateAiRoute() {
      const from = document.getElementById('aiRouteFrom').value.trim();
      const to = document.getElementById('aiRouteTo').value.trim();

      if (!from || !to) {
        showToast('Please enter start and destination');
        return;
      }

      // Get preferences
      const preferences = [];
      if (document.getElementById('prefCoffee').checked) preferences.push('coffee shop stop');
      if (document.getElementById('prefShade').checked) preferences.push('shady tree-lined streets');
      if (document.getElementById('prefScenic').checked) preferences.push('scenic harbour/water views');
      if (document.getElementById('prefCharging').checked) preferences.push('e-bike charging station');
      if (document.getElementById('prefFlat').checked) preferences.push('flat terrain with minimal hills');
      if (document.getElementById('prefSafe').checked) preferences.push('separated bike lanes for safety');

      const customRequest = document.getElementById('aiRouteCustom').value.trim();

      // Show loading
      document.getElementById('generateRouteBtn').classList.add('hidden');
      document.getElementById('aiRouteLoading').classList.remove('hidden');
      document.getElementById('aiRouteResult').classList.add('hidden');

      try {
        const routeData = await callGeminiForRoute(from, to, preferences, customRequest);
        displayAiRouteResult(routeData);
      } catch (error) {
        console.error('AI Route Error:', error);
        showToast('AI route generation failed. Check API key.');
        document.getElementById('generateRouteBtn').classList.remove('hidden');
        document.getElementById('aiRouteLoading').classList.add('hidden');
      }
    }

    async function callGeminiForRoute(from, to, preferences, customRequest) {
      const apiKey = window.GEMINI_API_KEY;

      if (!apiKey || apiKey === 'YOUR_GEMINI_API_KEY_HERE') {
        // Demo mode - return mock data
        return getMockRouteData(from, to, preferences);
      }

      const prefText = preferences.length > 0 ? preferences.join(', ') : 'most direct bike-friendly route';
      const customText = customRequest ? `\nAdditional request: ${customRequest}` : '';

      const prompt = `You are a Sydney cycling route planner AI. Plan a bike route from "${from}" to "${to}" in Sydney, Australia.

User preferences: ${prefText}${customText}

Respond in this exact JSON format (no markdown, just raw JSON):
{
  "summary": "Brief 1-2 sentence description of the route",
  "distance_km": 5.2,
  "duration_mins": 22,
  "elevation_gain_m": 45,
  "route_type": "scenic/direct/safe",
  "stops": [
    {
      "name": "Stop name",
      "type": "coffee/charging/viewpoint/other",
      "address": "Address in Sydney",
      "why": "Brief reason for this stop",
      "lat": -33.8688,
      "lng": 151.2093
    }
  ],
  "waypoints": [
    {"lat": -33.8688, "lng": 151.2093},
    {"lat": -33.8700, "lng": 151.2100}
  ],
  "tips": ["Helpful tip 1", "Helpful tip 2"],
  "shade_rating": 4,
  "safety_rating": 5,
  "scenery_rating": 4
}

Include real Sydney locations, coffee shops, cycleways, and points of interest. Use actual coordinates for Sydney CBD and surrounding areas. Make the route practical and cyclist-friendly.`;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{
            parts: [{
              text: prompt
            }]
          }],
          generationConfig: {
            temperature: 0.7,
            maxOutputTokens: 2048,
          }
        })
      });

      if (!response.ok) {
        throw new Error('Gemini API request failed');
      }

      const data = await response.json();
      const text = data.candidates[0].content.parts[0].text;

      // Parse JSON from response (handle markdown code blocks)
      let jsonStr = text;
      if (text.includes('```json')) {
        jsonStr = text.split('```json')[1].split('```')[0];
      } else if (text.includes('```')) {
        jsonStr = text.split('```')[1].split('```')[0];
      }

      return JSON.parse(jsonStr.trim());
    }

    function getMockRouteData(from, to, preferences) {
      // Demo data when no API key
      const hasCoffee = preferences.includes('coffee shop stop');
      const hasShade = preferences.includes('shady tree-lined streets');
      const hasCharging = preferences.includes('e-bike charging station');
      const hasScenic = preferences.includes('scenic harbour/water views');

      const stops = [];

      if (hasCoffee) {
        stops.push({
          name: "Single O Surry Hills",
          type: "coffee",
          address: "60-64 Reservoir St, Surry Hills",
          why: "Top-rated specialty coffee, cyclist-friendly outdoor seating",
          lat: -33.8847,
          lng: 151.2110
        });
      }

      if (hasCharging) {
        stops.push({
          name: "Town Hall Charging Hub",
          type: "charging",
          address: "George St, Sydney CBD",
          why: "Fast charging with 6 available spots",
          lat: -33.8731,
          lng: 151.2065
        });
      }

      if (hasScenic) {
        stops.push({
          name: "Mrs Macquarie's Point",
          type: "viewpoint",
          address: "Mrs Macquaries Rd, Sydney",
          why: "Stunning Opera House and Harbour Bridge views",
          lat: -33.8598,
          lng: 151.2228
        });
      }

      return {
        summary: `A ${hasShade ? 'tree-lined ' : ''}${hasScenic ? 'scenic ' : ''}bike route from ${from} to ${to}${hasCoffee ? ' with a great coffee stop' : ''}.`,
        distance_km: 6.8,
        duration_mins: 28,
        elevation_gain_m: hasShade ? 25 : 55,
        route_type: hasScenic ? 'scenic' : (hasShade ? 'safe' : 'direct'),
        stops: stops,
        waypoints: [
          { lat: -33.8688, lng: 151.2093 },
          { lat: -33.8720, lng: 151.2100 },
          { lat: -33.8780, lng: 151.2120 },
          { lat: -33.8847, lng: 151.2110 },
          { lat: -33.8900, lng: 151.2050 }
        ],
        tips: [
          hasShade ? "Hyde Park and Moore Park offer great shade coverage" : "Apply sunscreen - limited shade on this route",
          "Kent Street cycleway has the smoothest surface",
          hasCoffee ? "Single O opens at 7am - perfect for morning rides" : "Several water fountains along Bourke St cycleway"
        ],
        shade_rating: hasShade ? 5 : 3,
        safety_rating: 4,
        scenery_rating: hasScenic ? 5 : 3
      };
    }

    function displayAiRouteResult(routeData) {
      lastAiRouteData = routeData;

      // Hide loading, show result
      document.getElementById('aiRouteLoading').classList.add('hidden');
      document.getElementById('aiRouteResult').classList.remove('hidden');

      // Populate AI response
      const resultText = document.getElementById('aiRouteText');
      resultText.innerHTML = `
        <p class="font-medium">${routeData.summary}</p>
        <div class="grid grid-cols-3 gap-2 mt-3">
          <div class="text-center p-2 bg-white dark:bg-slate-800 rounded-lg">
            <div class="text-lg font-bold text-primary">${routeData.distance_km}km</div>
            <div class="text-[10px] text-gray-500">Distance</div>
          </div>
          <div class="text-center p-2 bg-white dark:bg-slate-800 rounded-lg">
            <div class="text-lg font-bold text-acc-green">${routeData.duration_mins}min</div>
            <div class="text-[10px] text-gray-500">Time</div>
          </div>
          <div class="text-center p-2 bg-white dark:bg-slate-800 rounded-lg">
            <div class="text-lg font-bold text-acc-orange">${routeData.elevation_gain_m}m</div>
            <div class="text-[10px] text-gray-500">Climb</div>
          </div>
        </div>
        <div class="flex items-center gap-4 mt-3 text-xs">
          <div class="flex items-center gap-1">
            <span>üå≥</span>
            <span class="dark:text-gray-300">Shade: ${routeData.shade_rating}/5</span>
          </div>
          <div class="flex items-center gap-1">
            <span>üõ°Ô∏è</span>
            <span class="dark:text-gray-300">Safety: ${routeData.safety_rating}/5</span>
          </div>
          <div class="flex items-center gap-1">
            <span>üåä</span>
            <span class="dark:text-gray-300">Views: ${routeData.scenery_rating}/5</span>
          </div>
        </div>
      `;

      // Populate stops
      const stopsContainer = document.getElementById('aiRouteStops');
      if (routeData.stops && routeData.stops.length > 0) {
        stopsContainer.innerHTML = `
          <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Suggested Stops</h4>
          ${routeData.stops.map((stop, i) => `
            <div class="flex items-start gap-3 p-3 bg-gray-50 dark:bg-slate-800 rounded-xl">
              <div class="w-8 h-8 rounded-full bg-gradient-to-tr ${getStopGradient(stop.type)} flex items-center justify-center flex-shrink-0">
                <span class="text-sm">${getStopEmoji(stop.type)}</span>
              </div>
              <div class="flex-1">
                <h5 class="font-semibold dark:text-white text-sm">${stop.name}</h5>
                <p class="text-xs text-gray-500">${stop.address}</p>
                <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${stop.why}</p>
              </div>
            </div>
          `).join('')}
        `;
      } else {
        stopsContainer.innerHTML = '';
      }

      // Display tips
      if (routeData.tips && routeData.tips.length > 0) {
        stopsContainer.innerHTML += `
          <h4 class="text-xs font-bold text-gray-500 uppercase mb-2 mt-4">Route Tips</h4>
          <div class="space-y-1">
            ${routeData.tips.map(tip => `
              <div class="flex items-start gap-2 text-xs text-gray-600 dark:text-gray-400">
                <span class="text-acc-green">üí°</span>
                <span>${tip}</span>
              </div>
            `).join('')}
          </div>
        `;
      }

      // Draw route preview on map
      drawAiRouteOnMap(routeData);
    }

    function getStopEmoji(type) {
      const emojis = {
        coffee: '‚òï',
        charging: '‚ö°',
        viewpoint: 'üì∏',
        food: 'üçΩÔ∏è',
        park: 'üå≥',
        other: 'üìç'
      };
      return emojis[type] || 'üìç';
    }

    function getStopGradient(type) {
      const gradients = {
        coffee: 'from-amber-400 to-orange-500',
        charging: 'from-green-400 to-emerald-500',
        viewpoint: 'from-blue-400 to-cyan-500',
        food: 'from-red-400 to-pink-500',
        park: 'from-green-500 to-teal-500',
        other: 'from-purple-400 to-indigo-500'
      };
      return gradients[type] || 'from-gray-400 to-gray-500';
    }

    function drawAiRouteOnMap(routeData) {
      // Clear previous AI route
      clearAiRoute();

      if (!routeData.waypoints || routeData.waypoints.length < 2) return;

      // Draw the route polyline
      aiRoutePolyline = new google.maps.Polyline({
        path: routeData.waypoints,
        strokeColor: '#9333EA',
        strokeOpacity: 0,
        strokeWeight: 6,
        map: map,
        zIndex: 200,
        icons: [{
          icon: {
            path: 'M 0,-1 0,1',
            strokeOpacity: 1,
            strokeColor: '#9333EA',
            strokeWeight: 6,
            scale: 3
          },
          offset: '0',
          repeat: '15px'
        }]
      });

      // Add stop markers
      if (routeData.stops) {
        routeData.stops.forEach(stop => {
          if (stop.lat && stop.lng) {
            const marker = new google.maps.Marker({
              position: { lat: stop.lat, lng: stop.lng },
              map: map,
              icon: {
                url: `data:image/svg+xml,${encodeURIComponent(`
                  <svg xmlns="http://www.w3.org/2000/svg" width="36" height="44" viewBox="0 0 36 44">
                    <defs>
                      <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#9333EA"/>
                        <stop offset="100%" style="stop-color:#EC4899"/>
                      </linearGradient>
                    </defs>
                    <path d="M18 0 C8 0 0 8 0 18 C0 31 18 44 18 44 C18 44 36 31 36 18 C36 8 28 0 18 0Z" fill="url(#grad)"/>
                    <circle cx="18" cy="16" r="10" fill="white"/>
                    <text x="18" y="20" text-anchor="middle" font-size="12">${getStopEmoji(stop.type)}</text>
                  </svg>
                `)}`,
                scaledSize: new google.maps.Size(36, 44),
                anchor: new google.maps.Point(18, 44)
              },
              title: stop.name,
              zIndex: 201
            });

            marker.addListener('click', () => {
              showToast(`${stop.name}: ${stop.why}`);
            });

            aiRouteMarkers.push(marker);
          }
        });
      }

      // Fit bounds to show full route
      const bounds = new google.maps.LatLngBounds();
      routeData.waypoints.forEach(wp => bounds.extend(wp));
      if (routeData.stops) {
        routeData.stops.forEach(stop => {
          if (stop.lat && stop.lng) bounds.extend({ lat: stop.lat, lng: stop.lng });
        });
      }
      map.fitBounds(bounds, { padding: 80 });
    }

    function clearAiRoute() {
      if (aiRoutePolyline) {
        aiRoutePolyline.setMap(null);
        aiRoutePolyline = null;
      }
      aiRouteMarkers.forEach(marker => marker.setMap(null));
      aiRouteMarkers = [];
    }

    function applyAiRoute() {
      if (!lastAiRouteData || !lastAiRouteData.waypoints || lastAiRouteData.waypoints.length < 2) {
        showToast('No route to apply');
        return;
      }

      // Build Google Maps directions URL with waypoints
      const waypoints = lastAiRouteData.waypoints;
      const start = waypoints[0];
      const end = waypoints[waypoints.length - 1];

      let url = `https://www.google.com/maps/dir/?api=1&origin=${start.lat},${start.lng}&destination=${end.lat},${end.lng}&travelmode=bicycling`;

      // Add intermediate waypoints (max 8 for Google Maps URL)
      if (lastAiRouteData.stops && lastAiRouteData.stops.length > 0) {
        const stopCoords = lastAiRouteData.stops
          .filter(s => s.lat && s.lng)
          .map(s => `${s.lat},${s.lng}`)
          .slice(0, 8);

        if (stopCoords.length > 0) {
          url += `&waypoints=${stopCoords.join('|')}`;
        }
      }

      window.open(url, '_blank');
      closeAiRouteModal();
      showToast('Opening route in Google Maps! üó∫Ô∏è');
    }

    function regenerateAiRoute() {
      document.getElementById('aiRouteResult').classList.add('hidden');
      document.getElementById('generateRouteBtn').classList.remove('hidden');
      clearAiRoute();
    }

    // ============================================
    // EDUCATION & REWARDS SYSTEM
    // ============================================
    let currentModule = null;
    let currentModuleSection = 0;
    let currentQuiz = null;
    let currentQuizQuestion = 0;
    let quizScore = 0;
    let quizAnswered = false;

    function openEducationModal() {
      document.getElementById('educationModal').classList.add('visible');
      updateEducationUI();
      loadEducationModules();
    }

    function closeEducationModal() {
      document.getElementById('educationModal').classList.remove('visible');
    }

    function updateEducationUI() {
      if (typeof USER_PROGRESS === 'undefined') return;

      const points = USER_PROGRESS.total_points;
      document.getElementById('eduTotalPoints').textContent = points.toLocaleString();
      document.getElementById('eduPointsCurrent').textContent = points.toLocaleString();

      const level = getUserLevel(points);
      const nextLevel = getNextLevel(points);
      const progress = getLevelProgress(points);

      document.getElementById('eduLevelIcon').textContent = level.icon;
      document.getElementById('eduLevelName').textContent = level.name;
      document.getElementById('eduLevelLabel').textContent = `Level ${level.level}`;
      document.getElementById('eduLevelBar').style.width = progress + '%';

      if (nextLevel) {
        const pointsNeeded = nextLevel.min_points - points;
        document.getElementById('eduPointsNext').textContent = `${pointsNeeded} more to ${nextLevel.name}`;
      } else {
        document.getElementById('eduPointsNext').textContent = 'Max level reached!';
      }
    }

    function loadEducationModules() {
      if (typeof EDUCATION_MODULES === 'undefined') return;

      const container = document.getElementById('eduTabModules');
      container.innerHTML = EDUCATION_MODULES.map(mod => {
        const completed = isModuleCompleted(mod.id);
        return `
          <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl ${completed ? 'border-2 border-acc-green' : ''}" onclick="openModule('${mod.id}')">
            <div class="flex items-start gap-3">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-tr ${completed ? 'from-green-400 to-emerald-500' : 'from-blue-400 to-cyan-500'} flex items-center justify-center flex-shrink-0">
                <span class="text-2xl">${completed ? '‚úì' : mod.icon}</span>
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <h3 class="font-bold dark:text-white text-sm">${mod.title}</h3>
                  ${completed ? '<span class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700">Completed</span>' : ''}
                </div>
                <p class="text-xs text-gray-500 mb-2">${mod.description}</p>
                <div class="flex items-center gap-3 text-xs text-gray-400">
                  <span>‚è±Ô∏è ${mod.duration_mins} min</span>
                  <span>‚≠ê ${mod.points} pts</span>
                  <span class="px-2 py-0.5 rounded-full bg-gray-200 dark:bg-gray-700 dark:text-gray-300">${mod.difficulty}</span>
                </div>
              </div>
              <span class="material-icons-round text-gray-400">chevron_right</span>
            </div>
          </div>
        `;
      }).join('');

      // Load rewards
      loadRewards();

      // Load badges
      loadBadges();
    }

    function loadRewards() {
      if (typeof REWARDS === 'undefined') return;

      const container = document.getElementById('eduTabRewards');

      // Featured rewards first
      const featured = REWARDS.filter(r => r.featured);
      const regular = REWARDS.filter(r => !r.featured);

      container.innerHTML = `
        <div class="mb-4">
          <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">üö¥ E-Bike Discounts</h3>
          <div class="space-y-2">
            ${featured.map(reward => renderReward(reward)).join('')}
          </div>
        </div>
        <div>
          <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">üéÅ More Rewards</h3>
          <div class="space-y-2">
            ${regular.map(reward => renderReward(reward)).join('')}
          </div>
        </div>
      `;
    }

    function renderReward(reward) {
      const canAfford = USER_PROGRESS.total_points >= reward.points_cost;
      const redeemed = USER_PROGRESS.redeemed_rewards.includes(reward.id);

      return `
        <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl ${!canAfford && !redeemed ? 'opacity-60' : ''} ${redeemed ? 'border-2 border-acc-green' : ''}">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-tr ${reward.featured ? 'from-yellow-400 to-orange-500' : 'from-gray-400 to-gray-500'} flex items-center justify-center flex-shrink-0">
              <span class="text-xl">${reward.icon}</span>
            </div>
            <div class="flex-1">
              <h4 class="font-bold dark:text-white text-sm">${reward.name}</h4>
              <p class="text-xs text-gray-500">${reward.description}</p>
              <p class="text-[10px] text-gray-400 mt-1">Partner: ${reward.partner}</p>
            </div>
            <div class="text-right">
              ${redeemed ? `
                <span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700">Redeemed</span>
              ` : `
                <button onclick="event.stopPropagation(); redeemReward('${reward.id}')" class="px-3 py-1.5 rounded-full text-xs font-bold ${canAfford ? 'bg-acc-blue text-white hover:bg-acc-blue/90' : 'bg-gray-200 dark:bg-gray-700 text-gray-500 cursor-not-allowed'}">
                  ${reward.points_cost} pts
                </button>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function loadBadges() {
      if (typeof BADGES === 'undefined') return;

      const container = document.getElementById('eduTabBadges');
      container.innerHTML = BADGES.map(badge => {
        const earned = USER_PROGRESS.badges.includes(badge.id);
        return `
          <div class="flex items-center gap-3 p-3 rounded-xl ${earned ? 'bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20' : 'bg-gray-50 dark:bg-slate-800 opacity-50'}">
            <div class="w-12 h-12 rounded-full ${earned ? 'bg-gradient-to-tr from-yellow-400 to-orange-500' : 'bg-gray-300 dark:bg-gray-600'} flex items-center justify-center">
              <span class="text-2xl ${earned ? '' : 'grayscale opacity-50'}">${badge.icon}</span>
            </div>
            <div class="flex-1">
              <h4 class="font-bold dark:text-white text-sm">${badge.name}</h4>
              <p class="text-xs text-gray-500">${badge.description}</p>
            </div>
            ${earned ? `
              <span class="text-xs text-acc-green font-bold">+${badge.points_bonus}</span>
            ` : `
              <span class="material-icons-round text-gray-400">lock</span>
            `}
          </div>
        `;
      }).join('');
    }

    function redeemReward(rewardId) {
      const reward = REWARDS.find(r => r.id === rewardId);
      if (!reward) return;

      if (USER_PROGRESS.total_points < reward.points_cost) {
        showToast('Not enough points!');
        return;
      }

      USER_PROGRESS.total_points -= reward.points_cost;
      USER_PROGRESS.redeemed_rewards.push(rewardId);

      updateEducationUI();
      loadRewards();
      showToast(`üéâ Redeemed: ${reward.name}!`);
    }

    // Module functions
    function openModule(moduleId) {
      currentModule = EDUCATION_MODULES.find(m => m.id === moduleId);
      if (!currentModule) return;

      currentModuleSection = 0;
      displayModuleSection();
      document.getElementById('moduleModal').classList.add('visible');
    }

    function closeModuleModal() {
      document.getElementById('moduleModal').classList.remove('visible');
      currentModule = null;
    }

    function displayModuleSection() {
      if (!currentModule) return;

      const section = currentModule.sections[currentModuleSection];
      const total = currentModule.sections.length;
      const progress = ((currentModuleSection + 1) / total) * 100;

      document.getElementById('moduleIcon').textContent = currentModule.icon;
      document.getElementById('moduleTitle').textContent = currentModule.title;
      document.getElementById('moduleMeta').textContent = `${currentModule.duration_mins} min ‚Ä¢ ${currentModule.points} points`;
      document.getElementById('moduleSectionProgress').textContent = `Section ${currentModuleSection + 1} of ${total}`;
      document.getElementById('moduleSectionBar').style.width = progress + '%';
      document.getElementById('moduleSectionTitle').textContent = section.title;
      document.getElementById('moduleSectionText').textContent = section.content;

      // Update buttons
      document.getElementById('modulePrevBtn').style.display = currentModuleSection === 0 ? 'none' : 'block';

      const nextBtn = document.getElementById('moduleNextBtn');
      if (currentModuleSection === total - 1) {
        nextBtn.textContent = currentModule.quiz_id ? 'Take Quiz' : 'Complete';
        nextBtn.classList.remove('bg-acc-blue');
        nextBtn.classList.add('bg-acc-green');
      } else {
        nextBtn.textContent = 'Next';
        nextBtn.classList.add('bg-acc-blue');
        nextBtn.classList.remove('bg-acc-green');
      }
    }

    function prevModuleSection() {
      if (currentModuleSection > 0) {
        currentModuleSection--;
        displayModuleSection();
      }
    }

    function nextModuleSection() {
      if (!currentModule) return;

      if (currentModuleSection < currentModule.sections.length - 1) {
        currentModuleSection++;
        displayModuleSection();
      } else {
        // Module complete
        if (currentModule.quiz_id) {
          closeModuleModal();
          openQuiz(currentModule.quiz_id);
        } else {
          completeModule(currentModule.id);
          closeModuleModal();
        }
      }
    }

    function completeModule(moduleId) {
      if (!USER_PROGRESS.completed_modules.includes(moduleId)) {
        const mod = EDUCATION_MODULES.find(m => m.id === moduleId);
        USER_PROGRESS.completed_modules.push(moduleId);
        USER_PROGRESS.total_points += mod.points;
        updateEducationUI();
        loadEducationModules();
        showToast(`üéâ +${mod.points} points! Module completed!`);
      }
    }

    // Quiz functions
    function openQuiz(quizId) {
      currentQuiz = EDUCATION_QUIZZES.find(q => q.id === quizId);
      if (!currentQuiz) return;

      currentQuizQuestion = 0;
      quizScore = 0;
      document.getElementById('quizScore').classList.add('hidden');
      document.getElementById('quizNextBtn').classList.add('hidden');
      document.getElementById('quizContent').classList.remove('hidden');
      displayQuizQuestion();
      document.getElementById('quizModal').classList.add('visible');
    }

    function closeQuizModal() {
      document.getElementById('quizModal').classList.remove('visible');
      currentQuiz = null;
      openEducationModal();
    }

    function displayQuizQuestion() {
      if (!currentQuiz) return;

      const q = currentQuiz.questions[currentQuizQuestion];
      const total = currentQuiz.questions.length;
      const progress = ((currentQuizQuestion + 1) / total) * 100;

      document.getElementById('quizTitle').textContent = currentQuiz.title;
      document.getElementById('quizProgress').textContent = `Question ${currentQuizQuestion + 1} of ${total}`;
      document.getElementById('quizProgressBar').style.width = progress + '%';
      document.getElementById('quizQuestionText').textContent = q.question;
      document.getElementById('quizExplanation').classList.add('hidden');
      document.getElementById('quizNextBtn').classList.add('hidden');
      quizAnswered = false;

      const optionsContainer = document.getElementById('quizOptions');
      optionsContainer.innerHTML = q.options.map((opt, i) => `
        <button onclick="selectQuizAnswer(${i})" class="quiz-option w-full text-left p-4 rounded-xl bg-gray-50 dark:bg-slate-800 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors border-2 border-transparent">
          <span class="font-medium dark:text-white">${opt}</span>
        </button>
      `).join('');
    }

    function selectQuizAnswer(index) {
      if (quizAnswered) return;
      quizAnswered = true;

      const q = currentQuiz.questions[currentQuizQuestion];
      const options = document.querySelectorAll('.quiz-option');

      options.forEach((opt, i) => {
        opt.classList.remove('hover:bg-gray-100', 'dark:hover:bg-slate-700');
        if (i === q.correct) {
          opt.classList.add('border-acc-green', 'bg-green-50', 'dark:bg-green-900/20');
        } else if (i === index && index !== q.correct) {
          opt.classList.add('border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
        }
      });

      if (index === q.correct) {
        quizScore++;
      }

      // Show explanation
      document.getElementById('quizExplanationText').textContent = q.explanation;
      document.getElementById('quizExplanation').classList.remove('hidden');

      // Show next button
      const nextBtn = document.getElementById('quizNextBtn');
      if (currentQuizQuestion < currentQuiz.questions.length - 1) {
        nextBtn.textContent = 'Next Question';
      } else {
        nextBtn.textContent = 'See Results';
      }
      nextBtn.classList.remove('hidden');
    }

    function nextQuizQuestion() {
      if (currentQuizQuestion < currentQuiz.questions.length - 1) {
        currentQuizQuestion++;
        displayQuizQuestion();
      } else {
        // Quiz complete
        showQuizResults();
      }
    }

    function showQuizResults() {
      const total = currentQuiz.questions.length;
      const pointsEarned = quizScore * currentQuiz.points_per_question;
      const perfectBonus = quizScore === total ? currentQuiz.perfect_bonus : 0;
      const totalPoints = pointsEarned + perfectBonus;

      document.getElementById('quizContent').classList.add('hidden');
      document.getElementById('quizNextBtn').classList.add('hidden');

      const scoreDiv = document.getElementById('quizScore');
      document.getElementById('quizScoreEmoji').textContent = quizScore === total ? 'üéâ' : quizScore >= total / 2 ? 'üëç' : 'üìö';
      document.getElementById('quizScoreText').textContent = `+${totalPoints} Points!`;
      document.getElementById('quizScoreDetail').textContent = `You got ${quizScore}/${total} correct!${perfectBonus > 0 ? ' Perfect score bonus!' : ''}`;
      scoreDiv.classList.remove('hidden');

      // Update progress
      USER_PROGRESS.total_points += totalPoints;
      if (!USER_PROGRESS.completed_quizzes.includes(currentQuiz.id)) {
        USER_PROGRESS.completed_quizzes.push(currentQuiz.id);

        // Also complete the module
        const mod = EDUCATION_MODULES.find(m => m.quiz_id === currentQuiz.id);
        if (mod && !USER_PROGRESS.completed_modules.includes(mod.id)) {
          USER_PROGRESS.completed_modules.push(mod.id);
          USER_PROGRESS.total_points += mod.points;
        }
      }

      // Check for quiz master badge
      if (quizScore === total && !USER_PROGRESS.badges.includes('quiz_master')) {
        USER_PROGRESS.badges.push('quiz_master');
        USER_PROGRESS.total_points += 100;
        setTimeout(() => showToast('üèÖ New Badge: Quiz Master!'), 1000);
      }
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      // Network toggle
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.toggle-btn').forEach(b => {
            b.classList.remove('bg-acc-green', 'text-white');
            b.classList.add('text-gray-600', 'dark:text-gray-300');
          });
          btn.classList.add('bg-acc-green', 'text-white');
          btn.classList.remove('text-gray-600', 'dark:text-gray-300');
          switchNetworkView(btn.dataset.view);
        });
      });

      // Dark mode toggle
      document.getElementById('darkModeBtn').addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        if (map) {
          map.setOptions({ styles: getMapStyles() });
        }
      });

      // Sidebar buttons
      document.getElementById('routeBtn').addEventListener('click', openAiRouteModal);
      document.getElementById('editBtn').addEventListener('click', openReportModal);
      document.getElementById('communityBtn').addEventListener('click', openCommunityModal);
      document.getElementById('educationBtn').addEventListener('click', openEducationModal);
      document.getElementById('layersBtn').addEventListener('click', openLayersModal);

      // Education tabs
      document.querySelectorAll('.edu-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.edu-tab').forEach(t => {
            t.classList.remove('bg-acc-blue', 'text-white');
            t.classList.add('bg-gray-100', 'dark:bg-slate-800', 'text-gray-600', 'dark:text-gray-300');
          });
          tab.classList.add('bg-acc-blue', 'text-white');
          tab.classList.remove('bg-gray-100', 'dark:bg-slate-800', 'text-gray-600', 'dark:text-gray-300');

          document.querySelectorAll('.edu-tab-content').forEach(c => c.classList.add('hidden'));
          document.getElementById('eduTab' + tab.dataset.tab.charAt(0).toUpperCase() + tab.dataset.tab.slice(1)).classList.remove('hidden');
        });
      });

      // Community tabs
      document.querySelectorAll('.community-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.community-tab').forEach(t => {
            t.classList.remove('bg-primary', 'text-white');
            t.classList.add('bg-gray-100', 'dark:bg-slate-800', 'text-gray-600', 'dark:text-gray-300');
          });
          tab.classList.add('bg-primary', 'text-white');
          tab.classList.remove('bg-gray-100', 'dark:bg-slate-800', 'text-gray-600', 'dark:text-gray-300');

          document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
          document.getElementById('tab' + tab.dataset.tab.charAt(0).toUpperCase() + tab.dataset.tab.slice(1)).classList.remove('hidden');
        });
      });

      // Layer toggles
      document.getElementById('layerCharging').addEventListener('change', (e) => {
        showCharging = e.target.checked;
        updatePoiVisibility();
      });
      document.getElementById('layerStores').addEventListener('change', (e) => {
        showStores = e.target.checked;
        updatePoiVisibility();
      });
      document.getElementById('layerCommunities').addEventListener('change', (e) => {
        showCommunities = e.target.checked;
        updatePoiVisibility();
      });
      document.getElementById('layerVeloways').addEventListener('change', (e) => {
        showVeloways = e.target.checked;
        updateVelowayVisibility();
      });

      // Sheet handle
      document.getElementById('sheetHandle').addEventListener('click', () => {
        if (isSheetExpanded) {
          collapseSheet();
        } else if (selectedProject) {
          expandSheet();
        }
      });

      // Report types
      document.querySelectorAll('.report-type').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.report-type').forEach(b => b.classList.remove('ring-2', 'ring-primary'));
          btn.classList.add('ring-2', 'ring-primary');
        });
      });

      // Directions button
      document.getElementById('directionsBtn').addEventListener('click', () => {
        if (selectedProject && selectedProject.coordinates) {
          const coord = selectedProject.coordinates[0];
          window.open(`https://www.google.com/maps/dir/?api=1&destination=${coord.lat},${coord.lng}&travelmode=bicycling`, '_blank');
        }
      });

      // Favorite button
      document.getElementById('favoriteBtn').addEventListener('click', () => {
        const btn = document.getElementById('favoriteBtn');
        const icon = btn.querySelector('.material-icons-round');
        if (icon.textContent === 'favorite_border') {
          icon.textContent = 'favorite';
          btn.classList.add('text-red-500');
          showToast('Added to favorites!');
        } else {
          icon.textContent = 'favorite_border';
          btn.classList.remove('text-red-500');
        }
      });
    });
  </script>
</body>
</html>
