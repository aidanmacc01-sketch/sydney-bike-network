<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
  <meta name="theme-color" content="#7C3AED"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="Micro2Move"/>
  <meta name="description" content="Sydney's community-powered cycling app - routes, charging, education & rewards"/>
  <title>Micro2Move Sydney - Bike Network</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json"/>
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png"/>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#7C3AED",
            "background-light": "#F8FAFC",
            "background-dark": "#0F172A",
            "acc-green": "#22C55E",
            "acc-yellow": "#FACC15",
            "acc-blue": "#3B82F6",
            "acc-orange": "#F59E0B",
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
          },
          borderRadius: {
            DEFAULT: "1rem",
          },
        },
      },
    };
  </script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .glass {
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    @keyframes pulse-ring {
      0% { transform: scale(.33); opacity: 1; }
      80%, 100% { transform: scale(1.5); opacity: 0; }
    }

    .pulse-dot::before {
      content: '';
      position: absolute;
      width: 300%;
      height: 300%;
      border-radius: 50%;
      background-color: inherit;
      animation: pulse-ring 1.5s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .pin-shadow {
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.2));
    }

    /* Hide scrollbar but allow scroll */
    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .hide-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Bottom sheet animation */
    .bottom-sheet {
      transition: transform 0.3s ease-out;
    }

    .bottom-sheet.collapsed {
      transform: translateY(calc(100% - 100px));
    }

    /* Custom marker styles */
    .custom-marker {
      cursor: pointer;
      transition: transform 0.2s;
    }
    .custom-marker:hover {
      transform: scale(1.1);
    }

    /* Progress bar animation */
    .progress-bar {
      transition: width 0.5s ease-out;
    }

    /* Toast notification */
    .toast {
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease-out;
    }
    .toast.visible {
      transform: translateY(0);
      opacity: 1;
    }

    /* Modal */
    .modal-overlay {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .modal-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }
    .modal-content {
      transform: translateY(50px) scale(0.95);
      opacity: 0;
      transition: all 0.3s ease-out;
    }
    .modal-overlay.visible .modal-content {
      transform: translateY(0) scale(1);
      opacity: 1;
    }
  </style>
</head>

<body class="font-display antialiased bg-background-light dark:bg-background-dark overflow-hidden select-none">

  <!-- Immediate onboarding control - runs before any other scripts -->
  <script>
    (function() {
      // Check if user has completed onboarding
      var completed = localStorage.getItem('micro2move_onboarding_complete');
      if (!completed) {
        // First time user - keep splash visible, ensure mainApp stays hidden
        document.addEventListener('DOMContentLoaded', function() {
          var mainApp = document.getElementById('mainApp');
          var splash = document.getElementById('splashScreen');
          if (mainApp) mainApp.classList.add('hidden');
          if (splash) splash.classList.remove('hidden');
        });
      }
    })();
  </script>

  <!-- ============================================
       ONBOARDING SCREENS
       ============================================ -->

  <!-- Splash Screen -->
  <div id="splashScreen" class="fixed inset-0 z-[200] flex flex-col items-center justify-center" style="background-color: #1a1a4e;">
    <div class="flex flex-col items-center justify-center flex-1 px-8">
      <!-- Tagline Top -->
      <p class="text-white text-xl mb-12 tracking-wide">Making Sydney E-bike Friendly</p>

      <!-- Logo -->
      <div class="relative mb-16">
        <!-- Lightning bolt -->
        <svg class="absolute -left-4 -top-2 w-8 h-12" viewBox="0 0 24 36" fill="none">
          <path d="M14 2L4 18h8l-2 16 12-20h-9l5-12h-4z" fill="#9333EA"/>
        </svg>
        <!-- Bike icon -->
        <svg class="w-32 h-20" viewBox="0 0 120 80" fill="none">
          <!-- Back wheel -->
          <circle cx="25" cy="55" r="18" stroke="#22C55E" stroke-width="4" fill="none"/>
          <!-- Front wheel -->
          <circle cx="95" cy="55" r="18" stroke="#22C55E" stroke-width="4" fill="none"/>
          <!-- Frame -->
          <path d="M25 55 L50 30 L75 55 L95 55" stroke="#22C55E" stroke-width="4" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M50 30 L50 20 L55 20" stroke="#22C55E" stroke-width="4" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M50 30 L75 30 L75 55" stroke="#22C55E" stroke-width="4" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <!-- Seat -->
          <path d="M45 20 L55 20" stroke="#22C55E" stroke-width="4" stroke-linecap="round"/>
          <!-- Handlebars -->
          <path d="M85 25 L95 25 L95 35" stroke="#22C55E" stroke-width="4" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M75 30 L95 25" stroke="#22C55E" stroke-width="4" stroke-linecap="round"/>
        </svg>
        <!-- Brand name -->
        <p class="text-center mt-2">
          <span class="text-primary text-xl font-bold">micro</span><span class="text-acc-green text-xl font-bold">2</span><span class="text-primary text-xl font-bold">move</span>
        </p>
      </div>

      <!-- Bottom Tagline -->
      <div class="flex gap-2 text-xl font-semibold">
        <span class="text-acc-green">Affordable</span>
        <span class="text-primary">Reliable</span>
        <span class="text-white">Safe</span>
      </div>
    </div>

    <!-- Tap to continue (auto-advances after 3s) -->
    <button onclick="showSignInScreen()" class="mb-12 text-white/60 text-sm animate-pulse">
      Tap to continue
    </button>
  </div>

  <!-- Sign In Screen -->
  <div id="signInScreen" class="fixed inset-0 z-[200] bg-white flex flex-col hidden">
    <div class="flex-1 px-6 pt-12 pb-6 overflow-y-auto">
      <!-- Logo Header -->
      <div class="flex items-center gap-2 mb-8">
        <svg class="w-16 h-12" viewBox="0 0 60 45" fill="none">
          <!-- Lightning -->
          <path d="M8 2L2 14h6l-1.5 12 9-15H9l4-9H8z" fill="#9333EA"/>
          <!-- Bike -->
          <circle cx="22" cy="32" r="10" stroke="#22C55E" stroke-width="2.5" fill="none"/>
          <circle cx="52" cy="32" r="10" stroke="#22C55E" stroke-width="2.5" fill="none"/>
          <path d="M22 32 L34 18 L46 32 L52 32" stroke="#22C55E" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M34 18 L34 12 L38 12" stroke="#22C55E" stroke-width="2.5" fill="none" stroke-linecap="round"/>
          <path d="M34 18 L46 18 L46 32" stroke="#22C55E" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M30 12 L38 12" stroke="#22C55E" stroke-width="2.5" stroke-linecap="round"/>
          <path d="M48 14 L52 14 L52 20" stroke="#22C55E" stroke-width="2.5" fill="none" stroke-linecap="round"/>
          <path d="M46 18 L52 14" stroke="#22C55E" stroke-width="2.5" stroke-linecap="round"/>
        </svg>
        <span class="text-primary text-2xl font-bold">micro2move</span>
      </div>

      <!-- Title -->
      <h1 class="text-3xl font-light text-gray-900 mb-8">Sign in to continue</h1>

      <!-- Form -->
      <form id="signInForm" onsubmit="handleSignIn(event)" class="space-y-4">
        <!-- Email Field -->
        <div>
          <div class="flex justify-between items-center mb-1">
            <label class="text-gray-600 text-sm">Email</label>
            <span id="emailError" class="text-red-500 text-sm hidden"></span>
          </div>
          <input
            type="email"
            id="signInEmail"
            placeholder="johndoe@email.com"
            class="w-full px-4 py-4 rounded-xl text-gray-600 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary/50"
            style="background-color: #EDE9FE;"
          />
        </div>

        <!-- Password Field -->
        <div>
          <div class="flex justify-between items-center mb-1">
            <label class="text-gray-600 text-sm">Password</label>
            <span id="passwordError" class="text-red-500 text-sm hidden"></span>
          </div>
          <input
            type="password"
            id="signInPassword"
            placeholder="********"
            class="w-full px-4 py-4 rounded-xl text-gray-600 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary/50"
            style="background-color: #EDE9FE;"
          />
        </div>

        <!-- Sign In Button -->
        <button
          type="submit"
          class="w-full py-4 rounded-xl text-white font-semibold text-lg mt-6 transition-colors hover:opacity-90"
          style="background-color: #A855F7;"
        >
          Sign In
        </button>
      </form>

      <!-- Sign Up Link -->
      <p class="text-center mt-6 text-gray-600">
        Don't have an account?
        <button onclick="showSignUpScreen()" class="text-primary font-semibold hover:underline">Sign Up</button>
      </p>

      <!-- Divider -->
      <div class="flex items-center gap-4 my-6">
        <div class="flex-1 h-px bg-gray-200"></div>
        <span class="text-sm text-gray-400">or</span>
        <div class="flex-1 h-px bg-gray-200"></div>
      </div>

      <!-- Social Sign In -->
      <div class="space-y-3">
        <button onclick="signInWithGoogle()" class="w-full bg-white border border-gray-200 text-gray-700 font-medium py-3 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-50 transition-colors">
          <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Continue with Google
        </button>

        <button onclick="signInWithApple()" class="w-full bg-black text-white font-medium py-3 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-900 transition-colors">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/></svg>
          Continue with Apple
        </button>
      </div>

      <!-- Skip -->
      <button onclick="continueAsGuest()" class="w-full text-gray-400 font-medium py-3 mt-4 hover:text-gray-600 transition-colors">
        Skip for now
      </button>
    </div>
  </div>

  <!-- Sign Up Screen -->
  <div id="signUpScreen" class="fixed inset-0 z-[200] bg-white flex flex-col hidden">
    <div class="flex-1 px-6 pt-12 pb-6 overflow-y-auto">
      <!-- Logo Header -->
      <div class="flex items-center gap-2 mb-6">
        <svg class="w-16 h-12" viewBox="0 0 60 45" fill="none">
          <path d="M8 2L2 14h6l-1.5 12 9-15H9l4-9H8z" fill="#9333EA"/>
          <circle cx="22" cy="32" r="10" stroke="#22C55E" stroke-width="2.5" fill="none"/>
          <circle cx="52" cy="32" r="10" stroke="#22C55E" stroke-width="2.5" fill="none"/>
          <path d="M22 32 L34 18 L46 32 L52 32" stroke="#22C55E" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M34 18 L34 12 L38 12" stroke="#22C55E" stroke-width="2.5" fill="none" stroke-linecap="round"/>
          <path d="M34 18 L46 18 L46 32" stroke="#22C55E" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M30 12 L38 12" stroke="#22C55E" stroke-width="2.5" stroke-linecap="round"/>
          <path d="M48 14 L52 14 L52 20" stroke="#22C55E" stroke-width="2.5" fill="none" stroke-linecap="round"/>
          <path d="M46 18 L52 14" stroke="#22C55E" stroke-width="2.5" stroke-linecap="round"/>
        </svg>
        <span class="text-primary text-2xl font-bold">micro2move</span>
      </div>

      <!-- Title -->
      <h1 class="text-2xl font-bold text-gray-900 mb-6">Sign up</h1>

      <!-- Form -->
      <form id="signUpForm" onsubmit="handleSignUp(event)" class="space-y-3">
        <!-- Full Name -->
        <div>
          <div class="flex justify-between items-center mb-1">
            <label class="text-gray-600 text-sm">Full Name (as displayed on government ID)</label>
            <span id="nameError" class="text-red-500 text-xs hidden"></span>
          </div>
          <input
            type="text"
            id="signUpName"
            placeholder="John Doe"
            class="w-full px-4 py-3 rounded-xl text-gray-600 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary/50"
            style="background-color: #EDE9FE;"
          />
        </div>

        <!-- Date of Birth -->
        <div>
          <div class="flex justify-between items-center mb-1">
            <label class="text-gray-600 text-sm">Date of Birth</label>
            <span id="dobError" class="text-red-500 text-xs hidden"></span>
          </div>
          <input
            type="text"
            id="signUpDob"
            placeholder="DD/MM/YYYY"
            class="w-full px-4 py-3 rounded-xl text-gray-600 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary/50"
            style="background-color: #EDE9FE;"
          />
        </div>

        <!-- Email -->
        <div>
          <div class="flex justify-between items-center mb-1">
            <label class="text-gray-600 text-sm">Email (for receipts and rides)</label>
            <span id="signUpEmailError" class="text-red-500 text-xs hidden"></span>
          </div>
          <input
            type="email"
            id="signUpEmail"
            placeholder="john@micro2move.com"
            class="w-full px-4 py-3 rounded-xl text-gray-600 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary/50"
            style="background-color: #EDE9FE;"
          />
        </div>

        <!-- Password -->
        <div>
          <div class="flex justify-between items-center mb-1">
            <label class="text-gray-600 text-sm">Create Password</label>
            <span id="signUpPasswordError" class="text-red-500 text-xs hidden"></span>
          </div>
          <input
            type="password"
            id="signUpPassword"
            placeholder="******"
            class="w-full px-4 py-3 rounded-xl text-gray-600 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary/50"
            style="background-color: #EDE9FE;"
          />
        </div>

        <!-- Terms & Conditions -->
        <div class="flex items-start gap-2 pt-2">
          <input type="checkbox" id="acceptTerms" class="mt-1 w-5 h-5 rounded border-gray-300 text-primary focus:ring-primary"/>
          <label class="text-gray-600 text-sm">
            I accept the <button type="button" onclick="showTermsModal()" class="text-primary font-semibold hover:underline">Terms & Conditions</button>
            <span id="termsError" class="text-red-500 text-xs block hidden"></span>
          </label>
        </div>

        <!-- ID Upload Section -->
        <div class="grid grid-cols-2 gap-3 pt-2">
          <button type="button" onclick="uploadGovernmentId()" class="flex flex-col items-center justify-center p-4 rounded-xl border-2 border-dashed border-gray-300 hover:border-primary transition-colors" style="background-color: #EDE9FE;">
            <span class="text-gray-500 text-xs text-center mb-2">Upload Government ID</span>
            <div id="govIdIcon" class="w-10 h-10 rounded-full bg-white/50 flex items-center justify-center">
              <span class="text-2xl text-gray-400">+</span>
            </div>
            <span id="govIdStatus" class="text-xs text-gray-400 mt-1"></span>
          </button>

          <button type="button" onclick="takeSelfieWithId()" class="flex flex-col items-center justify-center p-4 rounded-xl border-2 border-dashed border-gray-300 hover:border-primary transition-colors" style="background-color: #EDE9FE;">
            <span class="text-gray-500 text-xs text-center mb-2">Take Selfie Holding same Government ID</span>
            <div id="selfieIcon" class="w-10 h-10 rounded-full bg-white/50 flex items-center justify-center">
              <span class="material-icons-round text-gray-400">photo_camera</span>
            </div>
            <span id="selfieStatus" class="text-xs text-gray-400 mt-1"></span>
          </button>
        </div>
        <span id="idVerificationError" class="text-red-500 text-xs hidden"></span>

        <!-- Continue Button -->
        <button
          type="submit"
          class="w-full py-4 rounded-xl text-white font-semibold text-lg mt-4 transition-colors hover:opacity-90"
          style="background-color: #A855F7;"
        >
          Continue
        </button>
      </form>

      <!-- Sign In Link -->
      <p class="text-center mt-4 text-gray-600">
        Already an user?
        <button onclick="showSignInScreen()" class="text-primary font-semibold hover:underline">Sign in</button>
      </p>
    </div>
  </div>

  <!-- Terms & Conditions Modal -->
  <div id="termsModal" class="fixed inset-0 z-[250] bg-black/50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-2xl max-w-md w-full max-h-[80vh] flex flex-col">
      <div class="p-6 border-b">
        <h2 class="text-xl font-bold text-gray-900">Terms & Conditions</h2>
      </div>
      <div class="flex-1 overflow-y-auto p-6 text-gray-600 text-sm space-y-4">
        <p><strong>1. Acceptance of Terms</strong></p>
        <p>By accessing and using the Micro2Move application, you agree to be bound by these Terms and Conditions. If you do not agree with any part of these terms, you may not use our service.</p>

        <p><strong>2. User Eligibility</strong></p>
        <p>You must be at least 16 years of age to use this service. Users under 18 must have parental consent. A valid government-issued ID is required for verification.</p>

        <p><strong>3. E-Bike Rental Terms</strong></p>
        <p>Users are responsible for the safe operation of rented e-bikes. Any damage caused by negligence or misuse will be charged to the user's account. E-bikes must be returned to designated stations.</p>

        <p><strong>4. Safety Requirements</strong></p>
        <p>Helmets must be worn at all times while operating an e-bike. Users must follow all local traffic laws and regulations. Riding under the influence of alcohol or drugs is strictly prohibited.</p>

        <p><strong>5. Privacy & Data</strong></p>
        <p>We collect location data to provide our services. Your personal information is protected according to our Privacy Policy. ID verification data is securely stored and used only for identity confirmation.</p>

        <p><strong>6. Liability</strong></p>
        <p>Micro2Move is not liable for injuries sustained during the use of our e-bikes beyond what is covered by our insurance policy. Users assume responsibility for their safety.</p>

        <button onclick="showFullTerms()" class="text-primary font-semibold hover:underline">Read more...</button>
      </div>
      <div class="p-6 border-t">
        <button onclick="acceptTermsAndClose()" class="w-full py-3 rounded-xl text-white font-semibold transition-colors hover:opacity-90" style="background-color: #A855F7;">
          OK
        </button>
      </div>
    </div>
  </div>

  <!-- Main App Container -->
  <div id="mainApp" class="hidden">

  <!-- Main Container - Full Screen -->
  <div class="relative w-full h-screen overflow-hidden">

    <!-- Google Map Container (Full Screen Background) -->
    <div id="map" class="absolute inset-0 w-full h-full"></div>

    <!-- Top Search Bar -->
    <div class="absolute top-4 left-4 right-4 z-40 md:left-20 md:right-20 lg:left-1/4 lg:right-1/4">
      <div class="glass bg-white/70 dark:bg-slate-900/70 p-1.5 rounded-full border border-white/30 dark:border-slate-800/30 flex items-center shadow-xl">
        <span class="material-icons-round text-gray-400 px-3">search</span>
        <input
          id="searchInput"
          class="bg-transparent border-none focus:ring-0 focus:outline-none text-sm w-full dark:text-white placeholder-gray-500"
          placeholder="Search Sydney Bike Network..."
          type="text"
        />
        <button id="filterBtn" class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white flex-shrink-0">
          <span class="material-icons-round text-lg">tune</span>
        </button>
      </div>
    </div>

    <!-- Network View Toggle -->
    <div class="absolute top-20 left-1/2 -translate-x-1/2 z-40">
      <div class="glass bg-white/80 dark:bg-slate-900/80 p-1 rounded-full border border-white/30 dark:border-slate-800/30 shadow-xl flex gap-1">
        <button class="toggle-btn px-4 py-2 rounded-full text-sm font-semibold transition-all bg-acc-green text-white" data-view="current">
          Today
        </button>
        <button class="toggle-btn px-4 py-2 rounded-full text-sm font-semibold transition-all text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-800" data-view="future">
          2026+
        </button>
        <button class="toggle-btn px-4 py-2 rounded-full text-sm font-semibold transition-all text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-800" data-view="all">
          Full Vision
        </button>
      </div>
    </div>

    <!-- Left Sidebar - Action Buttons -->
    <div class="absolute top-36 left-4 z-40">
      <div class="glass bg-white/80 dark:bg-slate-900/80 p-2 rounded-2xl border border-white/30 dark:border-slate-800/30 shadow-xl flex flex-col gap-3">
        <button id="routeBtn" class="w-10 h-10 rounded-xl bg-acc-green text-white flex items-center justify-center shadow-md hover:scale-105 transition-transform" title="Plan Route">
          <span class="material-icons-round">route</span>
        </button>
        <button id="editBtn" class="w-10 h-10 rounded-xl bg-primary text-white flex items-center justify-center shadow-md hover:scale-105 transition-transform" title="Report Issue">
          <span class="material-icons-round">edit_road</span>
        </button>
        <button id="communityBtn" class="w-10 h-10 rounded-xl bg-acc-yellow text-white flex items-center justify-center shadow-md hover:scale-105 transition-transform" title="Community">
          <span class="material-icons-round">groups</span>
        </button>
        <button id="educationBtn" class="w-10 h-10 rounded-xl bg-acc-blue text-white flex items-center justify-center shadow-md hover:scale-105 transition-transform" title="Learn & Earn">
          <span class="material-icons-round">school</span>
        </button>
        <div class="h-px bg-gray-200 dark:bg-gray-700 mx-1"></div>
        <button id="layersBtn" class="w-10 h-10 rounded-xl glass bg-white/50 dark:bg-slate-800/50 text-gray-600 dark:text-gray-300 flex items-center justify-center hover:scale-105 transition-transform" title="Layers">
          <span class="material-icons-round">layers</span>
        </button>
        <button id="profileBtn" onclick="openProfileModal()" class="w-10 h-10 rounded-xl glass bg-white/50 dark:bg-slate-800/50 text-gray-600 dark:text-gray-300 flex items-center justify-center hover:scale-105 transition-transform" title="Profile & Settings">
          <span class="material-icons-round">person</span>
        </button>
      </div>
    </div>

    <!-- Legend Pills -->
    <div class="absolute top-36 right-4 z-40 flex flex-col gap-2">
      <div class="glass bg-white/80 dark:bg-slate-900/80 px-3 py-2 rounded-xl border border-white/30 shadow-lg">
        <div class="flex items-center gap-2 text-xs font-medium">
          <div class="w-3 h-3 rounded-full bg-acc-green"></div>
          <span class="dark:text-white">Open</span>
        </div>
      </div>
      <div class="glass bg-white/80 dark:bg-slate-900/80 px-3 py-2 rounded-xl border border-white/30 shadow-lg">
        <div class="flex items-center gap-2 text-xs font-medium">
          <div class="w-3 h-3 rounded-full bg-acc-orange"></div>
          <span class="dark:text-white">Building</span>
        </div>
      </div>
      <div class="glass bg-white/80 dark:bg-slate-900/80 px-3 py-2 rounded-xl border border-white/30 shadow-lg">
        <div class="flex items-center gap-2 text-xs font-medium">
          <div class="w-3 h-3 rounded-full bg-acc-blue"></div>
          <span class="dark:text-white">Funded</span>
        </div>
      </div>
      <div class="glass bg-white/80 dark:bg-slate-900/80 px-3 py-2 rounded-xl border border-white/30 shadow-lg">
        <div class="flex items-center gap-2 text-xs font-medium">
          <div class="w-3 h-3 rounded-full bg-primary"></div>
          <span class="dark:text-white">Planned</span>
        </div>
      </div>
      <div class="glass bg-white/80 dark:bg-slate-900/80 px-3 py-2 rounded-xl border border-white/30 shadow-lg">
        <div class="flex items-center gap-2 text-xs font-medium">
          <div class="w-3 h-3 rounded-full bg-pink-500"></div>
          <span class="dark:text-white">Veloway</span>
        </div>
      </div>
    </div>

    <!-- Network Stats Banner -->
    <div id="statsBanner" class="absolute bottom-[340px] left-4 right-4 md:left-1/4 md:right-1/4 z-30">
      <div class="glass bg-white/90 dark:bg-slate-900/90 rounded-2xl border border-white/40 shadow-xl p-4 flex justify-around">
        <div class="text-center">
          <div class="text-2xl font-bold text-acc-green" id="statsKm">35</div>
          <div class="text-xs text-gray-500 dark:text-gray-400 font-medium">km Network</div>
        </div>
        <div class="h-10 w-px bg-gray-200 dark:bg-gray-700"></div>
        <div class="text-center">
          <div class="text-2xl font-bold text-primary" id="statsProjects">9</div>
          <div class="text-xs text-gray-500 dark:text-gray-400 font-medium">Projects</div>
        </div>
        <div class="h-10 w-px bg-gray-200 dark:bg-gray-700"></div>
        <div class="text-center">
          <div class="text-2xl font-bold text-acc-yellow" id="statsTrips">45k</div>
          <div class="text-xs text-gray-500 dark:text-gray-400 font-medium">Daily Trips</div>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet - Project/Segment Details -->
    <div id="bottomSheet" class="bottom-sheet absolute bottom-0 left-0 right-0 z-40 collapsed">
      <div class="glass bg-white/95 dark:bg-slate-900/95 rounded-t-[2rem] border-t border-white/40 dark:border-slate-800/40 shadow-2xl max-h-[70vh] overflow-hidden">

        <!-- Drag Handle -->
        <div class="flex justify-center pt-3 pb-2 cursor-pointer" id="sheetHandle">
          <div class="w-10 h-1 bg-gray-300 dark:bg-gray-700 rounded-full"></div>
        </div>

        <!-- Sheet Header - Always Visible -->
        <div class="px-5 pb-4" id="sheetHeader">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-xs font-bold text-acc-green bg-green-100 dark:bg-green-900/30 px-2 py-0.5 rounded-full" id="sheetBadge">
                  OPEN
                </span>
              </div>
              <h2 class="text-xl font-bold dark:text-white" id="sheetTitle">Select a cycleway</h2>
              <div class="flex items-center gap-1 text-sm text-gray-500 dark:text-gray-400">
                <span class="material-icons-round text-acc-green text-sm">check_circle</span>
                <span id="sheetMeta">Tap on the map to view details</span>
              </div>
            </div>
            <div class="flex flex-col items-end">
              <div class="flex items-center gap-0.5 text-acc-yellow">
                <span class="material-icons-round text-sm">star</span>
                <span class="text-sm font-bold dark:text-white" id="sheetRating">--</span>
              </div>
              <span class="text-[10px] text-gray-400 uppercase tracking-wider font-bold" id="sheetReviewCount">-- Reviews</span>
            </div>
          </div>
        </div>

        <!-- Expandable Content -->
        <div class="px-5 pb-6 overflow-y-auto hide-scrollbar" id="sheetContent" style="max-height: calc(70vh - 120px);">

          <!-- Stats Grid -->
          <div class="grid grid-cols-2 gap-3 mb-6" id="sheetStats">
            <div class="bg-white/40 dark:bg-slate-800/40 p-3 rounded-2xl border border-white/20">
              <span class="text-[10px] text-gray-500 font-bold uppercase tracking-tight">Safety Score</span>
              <div class="flex items-center gap-2 mt-1">
                <div class="flex-1 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                  <div class="h-full bg-acc-green progress-bar" id="safetyBar" style="width: 0%"></div>
                </div>
                <span class="text-xs font-bold dark:text-white" id="safetyScore">--</span>
              </div>
            </div>
            <div class="bg-white/40 dark:bg-slate-800/40 p-3 rounded-2xl border border-white/20">
              <span class="text-[10px] text-gray-500 font-bold uppercase tracking-tight">Surface Quality</span>
              <div class="flex items-center gap-2 mt-1">
                <div class="flex-1 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                  <div class="h-full bg-primary progress-bar" id="surfaceBar" style="width: 0%"></div>
                </div>
                <span class="text-xs font-bold dark:text-white" id="surfaceScore">--</span>
              </div>
            </div>
          </div>

          <!-- Project Info -->
          <div id="projectInfo" class="mb-6 hidden">
            <div class="grid grid-cols-3 gap-3 mb-4">
              <div class="text-center">
                <div class="text-lg font-bold text-acc-green" id="projectBudget">--</div>
                <div class="text-[10px] text-gray-500 uppercase">Budget</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-bold text-primary" id="projectLength">--</div>
                <div class="text-[10px] text-gray-500 uppercase">Length</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-bold text-acc-yellow" id="projectCompletion">--</div>
                <div class="text-[10px] text-gray-500 uppercase">Completion</div>
              </div>
            </div>

            <p class="text-sm text-gray-600 dark:text-gray-300 mb-4" id="projectDescription"></p>

            <div id="projectBenefits" class="mb-4 hidden">
              <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Benefits</h4>
              <ul class="space-y-1" id="benefitsList"></ul>
            </div>

            <div id="projectConnections" class="hidden">
              <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Connects To</h4>
              <p class="text-sm text-gray-600 dark:text-gray-300" id="connectionsList"></p>
            </div>
          </div>

          <!-- Recent Review -->
          <div id="reviewSection" class="mb-6 hidden">
            <div class="flex items-center gap-2 mb-2">
              <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center">
                <span class="text-white text-xs font-bold" id="reviewerInitial">A</span>
              </div>
              <span class="text-xs font-semibold dark:text-white" id="reviewerName">Alex M.</span>
              <span class="text-[10px] text-gray-400" id="reviewTime">2h ago</span>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-300 italic" id="reviewText">"Great infrastructure!"</p>
          </div>

          <!-- Action Buttons -->
          <div class="flex gap-3">
            <button id="directionsBtn" class="flex-1 bg-primary text-white font-bold py-3 rounded-2xl flex items-center justify-center gap-2 shadow-lg shadow-primary/30 hover:bg-primary/90 transition-colors">
              <span class="material-icons-round">directions</span>
              Get Directions
            </button>
            <button id="favoriteBtn" class="w-14 h-14 bg-white dark:bg-slate-800 text-gray-400 rounded-2xl flex items-center justify-center border border-gray-100 dark:border-slate-700 hover:text-red-500 transition-colors">
              <span class="material-icons-round">favorite_border</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Dark Mode Toggle -->
    <button id="darkModeBtn" class="fixed bottom-4 right-4 z-50 w-12 h-12 rounded-full bg-white dark:bg-slate-800 shadow-xl flex items-center justify-center border border-gray-200 dark:border-slate-700 hover:scale-105 transition-transform">
      <span class="material-icons-round dark:text-white">dark_mode</span>
    </button>

    <!-- Report Modal -->
    <div id="reportModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" onclick="closeReportModal()"></div>
      <div class="modal-content glass bg-white/95 dark:bg-slate-900/95 rounded-3xl border border-white/40 shadow-2xl w-full max-w-md p-6 relative">
        <button onclick="closeReportModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center">
          <span class="material-icons-round text-gray-500">close</span>
        </button>

        <h2 class="text-xl font-bold dark:text-white mb-4">Report an Issue</h2>

        <div class="grid grid-cols-4 gap-2 mb-6">
          <button class="report-type flex flex-col items-center p-3 rounded-xl bg-gray-50 dark:bg-slate-800 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors" data-type="glass">
            <span class="text-2xl mb-1">üî∂</span>
            <span class="text-[10px] font-medium dark:text-white">Glass</span>
          </button>
          <button class="report-type flex flex-col items-center p-3 rounded-xl bg-gray-50 dark:bg-slate-800 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors" data-type="pothole">
            <span class="text-2xl mb-1">üï≥Ô∏è</span>
            <span class="text-[10px] font-medium dark:text-white">Pothole</span>
          </button>
          <button class="report-type flex flex-col items-center p-3 rounded-xl bg-gray-50 dark:bg-slate-800 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors" data-type="construction">
            <span class="text-2xl mb-1">üöß</span>
            <span class="text-[10px] font-medium dark:text-white">Works</span>
          </button>
          <button class="report-type flex flex-col items-center p-3 rounded-xl bg-gray-50 dark:bg-slate-800 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors" data-type="hazard">
            <span class="text-2xl mb-1">‚ö†Ô∏è</span>
            <span class="text-[10px] font-medium dark:text-white">Hazard</span>
          </button>
        </div>

        <textarea class="w-full p-3 rounded-xl bg-gray-50 dark:bg-slate-800 border-none focus:ring-2 focus:ring-primary text-sm dark:text-white placeholder-gray-400 resize-none" rows="3" placeholder="Describe the issue (optional)..."></textarea>

        <button class="w-full mt-4 bg-primary text-white font-bold py-3 rounded-2xl shadow-lg shadow-primary/30 hover:bg-primary/90 transition-colors">
          Submit Report
        </button>
      </div>
    </div>

    <!-- Community Modal -->
    <div id="communityModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" onclick="closeCommunityModal()"></div>
      <div class="modal-content glass bg-white/95 dark:bg-slate-900/95 rounded-3xl border border-white/40 shadow-2xl w-full max-w-lg p-6 relative max-h-[85vh] overflow-hidden flex flex-col">
        <button onclick="closeCommunityModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center z-10">
          <span class="material-icons-round text-gray-500">close</span>
        </button>

        <h2 class="text-xl font-bold dark:text-white mb-4">Community Hub</h2>

        <!-- Tabs -->
        <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar">
          <button class="community-tab px-4 py-2 rounded-full text-sm font-semibold bg-primary text-white whitespace-nowrap" data-tab="feed">Feed</button>
          <button class="community-tab px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 whitespace-nowrap" data-tab="groups">Groups</button>
          <button class="community-tab px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 whitespace-nowrap" data-tab="charging">‚ö° Charging</button>
          <button class="community-tab px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 whitespace-nowrap" data-tab="stores">üè™ Stores</button>
        </div>

        <div class="overflow-y-auto flex-1 hide-scrollbar">
          <!-- Feed Tab -->
          <div id="tabFeed" class="tab-content space-y-3">
            <!-- Populated by JS -->
          </div>

          <!-- Groups Tab -->
          <div id="tabGroups" class="tab-content space-y-3 hidden">
            <!-- Populated by JS -->
          </div>

          <!-- Charging Tab -->
          <div id="tabCharging" class="tab-content space-y-3 hidden">
            <!-- Populated by JS -->
          </div>

          <!-- Stores Tab -->
          <div id="tabStores" class="tab-content space-y-3 hidden">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>
    </div>

    <!-- Layers Modal -->
    <div id="layersModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" onclick="closeLayersModal()"></div>
      <div class="modal-content glass bg-white/95 dark:bg-slate-900/95 rounded-3xl border border-white/40 shadow-2xl w-full max-w-sm p-6 relative">
        <button onclick="closeLayersModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center">
          <span class="material-icons-round text-gray-500">close</span>
        </button>

        <h2 class="text-xl font-bold dark:text-white mb-4">Map Layers</h2>

        <div class="space-y-3">
          <label class="flex items-center justify-between p-3 rounded-xl bg-gray-50 dark:bg-slate-800 cursor-pointer">
            <div class="flex items-center gap-3">
              <span class="text-xl">‚ö°</span>
              <span class="font-medium dark:text-white">E-Bike Charging</span>
            </div>
            <input type="checkbox" id="layerCharging" checked class="w-5 h-5 rounded text-primary focus:ring-primary">
          </label>

          <label class="flex items-center justify-between p-3 rounded-xl bg-gray-50 dark:bg-slate-800 cursor-pointer">
            <div class="flex items-center gap-3">
              <span class="text-xl">üè™</span>
              <span class="font-medium dark:text-white">E-Bike Stores</span>
            </div>
            <input type="checkbox" id="layerStores" checked class="w-5 h-5 rounded text-primary focus:ring-primary">
          </label>

          <label class="flex items-center justify-between p-3 rounded-xl bg-gray-50 dark:bg-slate-800 cursor-pointer">
            <div class="flex items-center gap-3">
              <span class="text-xl">üë•</span>
              <span class="font-medium dark:text-white">Communities</span>
            </div>
            <input type="checkbox" id="layerCommunities" checked class="w-5 h-5 rounded text-primary focus:ring-primary">
          </label>

          <div class="h-px bg-gray-200 dark:bg-gray-700 my-2"></div>

          <label class="flex items-center justify-between p-3 rounded-xl bg-gradient-to-r from-pink-50 to-purple-50 dark:from-pink-900/20 dark:to-purple-900/20 cursor-pointer">
            <div class="flex items-center gap-3">
              <span class="text-xl">üõ§Ô∏è</span>
              <span class="font-medium dark:text-white">Veloways (Regional)</span>
            </div>
            <input type="checkbox" id="layerVeloways" checked class="w-5 h-5 rounded text-pink-500 focus:ring-pink-500">
          </label>
        </div>
      </div>
    </div>

    <!-- POI Detail Modal -->
    <div id="poiModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" onclick="closePoiModal()"></div>
      <div class="modal-content glass bg-white/95 dark:bg-slate-900/95 rounded-3xl border border-white/40 shadow-2xl w-full max-w-md p-6 relative max-h-[85vh] overflow-y-auto">
        <button onclick="closePoiModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center">
          <span class="material-icons-round text-gray-500">close</span>
        </button>

        <div id="poiContent">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>

    <!-- Comments Modal -->
    <div id="commentsModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" onclick="closeCommentsModal()"></div>
      <div class="modal-content glass bg-white/95 dark:bg-slate-900/95 rounded-3xl border border-white/40 shadow-2xl w-full max-w-md p-6 relative max-h-[85vh] overflow-hidden flex flex-col">
        <button onclick="closeCommentsModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center z-10">
          <span class="material-icons-round text-gray-500">close</span>
        </button>

        <h2 class="text-xl font-bold dark:text-white mb-2" id="commentsTitle">Comments</h2>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4" id="commentsSubtitle">Community feedback</p>

        <div class="overflow-y-auto flex-1 hide-scrollbar mb-4" id="commentsList">
          <!-- Populated by JS -->
        </div>

        <!-- Add Comment -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
          <textarea id="newComment" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-slate-800 border-none focus:ring-2 focus:ring-primary text-sm dark:text-white placeholder-gray-400 resize-none" rows="2" placeholder="Add a comment..."></textarea>
          <button onclick="submitComment()" class="w-full mt-2 bg-primary text-white font-bold py-2 rounded-xl hover:bg-primary/90 transition-colors">
            Post Comment
          </button>
        </div>
      </div>
    </div>

    <!-- AI Route Planning Modal -->
    <div id="aiRouteModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" onclick="closeAiRouteModal()"></div>
      <div class="modal-content glass bg-white/95 dark:bg-slate-900/95 rounded-3xl border border-white/40 shadow-2xl w-full max-w-md p-6 relative max-h-[90vh] overflow-hidden flex flex-col">
        <button onclick="closeAiRouteModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center z-10">
          <span class="material-icons-round text-gray-500">close</span>
        </button>

        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center">
            <span class="material-icons-round text-white">auto_awesome</span>
          </div>
          <div>
            <h2 class="text-xl font-bold dark:text-white">AI Route Planner</h2>
            <p class="text-xs text-gray-500">Powered by Gemini</p>
          </div>
        </div>

        <!-- Route Inputs -->
        <div class="space-y-3 mb-4">
          <div>
            <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">From</label>
            <div class="flex items-center gap-2 bg-gray-50 dark:bg-slate-800 rounded-xl p-3">
              <span class="material-icons-round text-acc-green">my_location</span>
              <input id="aiRouteFrom" type="text" placeholder="Current location or address" class="flex-1 bg-transparent border-none focus:ring-0 text-sm dark:text-white placeholder-gray-400">
            </div>
          </div>
          <div>
            <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">To</label>
            <div class="flex items-center gap-2 bg-gray-50 dark:bg-slate-800 rounded-xl p-3">
              <span class="material-icons-round text-red-500">place</span>
              <input id="aiRouteTo" type="text" placeholder="Destination address" class="flex-1 bg-transparent border-none focus:ring-0 text-sm dark:text-white placeholder-gray-400">
            </div>
          </div>
        </div>

        <!-- Preference Toggles -->
        <div class="mb-4">
          <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Route Preferences</label>
          <div class="grid grid-cols-2 gap-2">
            <label class="route-pref flex items-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-slate-800 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
              <input type="checkbox" id="prefCoffee" class="w-4 h-4 rounded text-primary focus:ring-primary">
              <span class="text-lg">‚òï</span>
              <span class="text-sm font-medium dark:text-white">Coffee Stop</span>
            </label>
            <label class="route-pref flex items-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-slate-800 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
              <input type="checkbox" id="prefShade" class="w-4 h-4 rounded text-primary focus:ring-primary">
              <span class="text-lg">üå≥</span>
              <span class="text-sm font-medium dark:text-white">Shady Route</span>
            </label>
            <label class="route-pref flex items-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-slate-800 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
              <input type="checkbox" id="prefScenic" class="w-4 h-4 rounded text-primary focus:ring-primary">
              <span class="text-lg">üåä</span>
              <span class="text-sm font-medium dark:text-white">Scenic Views</span>
            </label>
            <label class="route-pref flex items-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-slate-800 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
              <input type="checkbox" id="prefCharging" class="w-4 h-4 rounded text-primary focus:ring-primary">
              <span class="text-lg">‚ö°</span>
              <span class="text-sm font-medium dark:text-white">E-Bike Charging</span>
            </label>
            <label class="route-pref flex items-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-slate-800 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
              <input type="checkbox" id="prefFlat" class="w-4 h-4 rounded text-primary focus:ring-primary">
              <span class="text-lg">üìâ</span>
              <span class="text-sm font-medium dark:text-white">Flat Terrain</span>
            </label>
            <label class="route-pref flex items-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-slate-800 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
              <input type="checkbox" id="prefSafe" class="w-4 h-4 rounded text-primary focus:ring-primary">
              <span class="text-lg">üõ°Ô∏è</span>
              <span class="text-sm font-medium dark:text-white">Safest Route</span>
            </label>
          </div>
        </div>

        <!-- Custom Request -->
        <div class="mb-4">
          <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Special Requests (Optional)</label>
          <textarea id="aiRouteCustom" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-slate-800 border-none focus:ring-2 focus:ring-primary text-sm dark:text-white placeholder-gray-400 resize-none" rows="2" placeholder="e.g., 'Stop at a bakery near Surry Hills' or 'Avoid busy roads'"></textarea>
        </div>

        <!-- Generate Button -->
        <button id="generateRouteBtn" onclick="generateAiRoute()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-4 rounded-2xl shadow-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
          <span class="material-icons-round">auto_awesome</span>
          Generate Smart Route
        </button>

        <!-- Loading State -->
        <div id="aiRouteLoading" class="hidden">
          <div class="flex flex-col items-center justify-center py-8">
            <div class="w-16 h-16 rounded-full border-4 border-purple-200 border-t-purple-500 animate-spin mb-4"></div>
            <p class="text-sm font-medium dark:text-white">AI is planning your perfect route...</p>
            <p class="text-xs text-gray-500">Analyzing preferences & local data</p>
          </div>
        </div>

        <!-- AI Response -->
        <div id="aiRouteResult" class="hidden mt-4 overflow-y-auto max-h-[40vh]">
          <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-xl p-4">
            <div class="flex items-center gap-2 mb-3">
              <span class="material-icons-round text-purple-500">smart_toy</span>
              <span class="font-bold dark:text-white">AI Route Suggestion</span>
            </div>
            <div id="aiRouteText" class="text-sm text-gray-700 dark:text-gray-300 space-y-2">
              <!-- AI response will be populated here -->
            </div>
          </div>

          <!-- Route Preview -->
          <div id="aiRouteStops" class="mt-4 space-y-2">
            <!-- Stops will be populated here -->
          </div>

          <!-- Action Buttons -->
          <div class="flex gap-3 mt-4">
            <button onclick="applyAiRoute()" class="flex-1 bg-acc-green text-white font-bold py-3 rounded-2xl flex items-center justify-center gap-2 shadow-lg hover:bg-acc-green/90 transition-colors">
              <span class="material-icons-round">directions</span>
              Use This Route
            </button>
            <button onclick="regenerateAiRoute()" class="w-14 h-14 bg-gray-100 dark:bg-slate-800 rounded-2xl flex items-center justify-center hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors">
              <span class="material-icons-round text-gray-600 dark:text-gray-300">refresh</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Education & Rewards Modal -->
    <div id="educationModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" onclick="closeEducationModal()"></div>
      <div class="modal-content glass bg-white/95 dark:bg-slate-900/95 rounded-3xl border border-white/40 shadow-2xl w-full max-w-lg p-6 relative max-h-[90vh] overflow-hidden flex flex-col">
        <button onclick="closeEducationModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center z-10">
          <span class="material-icons-round text-gray-500">close</span>
        </button>

        <!-- Header with Points -->
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-tr from-blue-500 to-cyan-400 flex items-center justify-center">
              <span class="material-icons-round text-white text-2xl">school</span>
            </div>
            <div>
              <h2 class="text-xl font-bold dark:text-white">Learn & Earn</h2>
              <p class="text-xs text-gray-500">Complete modules, earn rewards</p>
            </div>
          </div>
          <div class="text-right">
            <div class="text-2xl font-bold text-acc-blue" id="eduTotalPoints">850</div>
            <div class="text-[10px] text-gray-500 uppercase">Points</div>
          </div>
        </div>

        <!-- Level Progress -->
        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20 rounded-xl p-4 mb-4">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="text-xl" id="eduLevelIcon">üö¥</span>
              <span class="font-bold dark:text-white" id="eduLevelName">Confident Cyclist</span>
            </div>
            <span class="text-xs text-gray-500" id="eduLevelLabel">Level 3</span>
          </div>
          <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-blue-500 to-cyan-400 progress-bar" id="eduLevelBar" style="width: 70%"></div>
          </div>
          <div class="flex justify-between mt-1 text-xs text-gray-500">
            <span id="eduPointsCurrent">850</span>
            <span id="eduPointsNext">500 more to Urban Navigator</span>
          </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar">
          <button class="edu-tab px-4 py-2 rounded-full text-sm font-semibold bg-acc-blue text-white whitespace-nowrap" data-tab="modules">üìö Modules</button>
          <button class="edu-tab px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 whitespace-nowrap" data-tab="rewards">üéÅ Rewards</button>
          <button class="edu-tab px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 whitespace-nowrap" data-tab="badges">üèÖ Badges</button>
        </div>

        <div class="overflow-y-auto flex-1 hide-scrollbar">
          <!-- Modules Tab -->
          <div id="eduTabModules" class="edu-tab-content space-y-3">
            <!-- Populated by JS -->
          </div>

          <!-- Rewards Tab -->
          <div id="eduTabRewards" class="edu-tab-content space-y-3 hidden">
            <!-- Populated by JS -->
          </div>

          <!-- Badges Tab -->
          <div id="eduTabBadges" class="edu-tab-content space-y-3 hidden">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>
    </div>

    <!-- Quiz Modal -->
    <div id="quizModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" onclick="closeQuizModal()"></div>
      <div class="modal-content glass bg-white/95 dark:bg-slate-900/95 rounded-3xl border border-white/40 shadow-2xl w-full max-w-md p-6 relative max-h-[90vh] overflow-hidden flex flex-col">
        <button onclick="closeQuizModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center z-10">
          <span class="material-icons-round text-gray-500">close</span>
        </button>

        <!-- Quiz Header -->
        <div class="mb-4">
          <h2 class="text-xl font-bold dark:text-white" id="quizTitle">Road Rules Quiz</h2>
          <div class="flex items-center gap-2 mt-1">
            <span class="text-xs text-gray-500" id="quizProgress">Question 1 of 5</span>
            <div class="flex-1 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
              <div class="h-full bg-acc-blue progress-bar" id="quizProgressBar" style="width: 20%"></div>
            </div>
          </div>
        </div>

        <!-- Quiz Content -->
        <div id="quizContent" class="flex-1 overflow-y-auto">
          <!-- Question -->
          <div id="quizQuestion" class="mb-6">
            <p class="text-lg font-medium dark:text-white" id="quizQuestionText">What is the fine for not wearing a helmet in NSW?</p>
          </div>

          <!-- Options -->
          <div id="quizOptions" class="space-y-2">
            <!-- Populated by JS -->
          </div>

          <!-- Explanation (shown after answer) -->
          <div id="quizExplanation" class="hidden mt-4 p-4 rounded-xl bg-blue-50 dark:bg-blue-900/20">
            <div class="flex items-start gap-2">
              <span class="material-icons-round text-acc-blue">info</span>
              <p class="text-sm text-gray-700 dark:text-gray-300" id="quizExplanationText"></p>
            </div>
          </div>
        </div>

        <!-- Quiz Actions -->
        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
          <button id="quizNextBtn" onclick="nextQuizQuestion()" class="hidden w-full bg-acc-blue text-white font-bold py-3 rounded-2xl shadow-lg hover:bg-acc-blue/90 transition-colors">
            Next Question
          </button>
          <div id="quizScore" class="hidden text-center">
            <div class="text-4xl mb-2" id="quizScoreEmoji">üéâ</div>
            <div class="text-2xl font-bold text-acc-green" id="quizScoreText">+50 Points!</div>
            <p class="text-sm text-gray-500 mt-1" id="quizScoreDetail">You got 5/5 correct!</p>
            <button onclick="closeQuizModal()" class="mt-4 w-full bg-acc-green text-white font-bold py-3 rounded-2xl">
              Collect Points
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Module Content Modal -->
    <div id="moduleModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" onclick="closeModuleModal()"></div>
      <div class="modal-content glass bg-white/95 dark:bg-slate-900/95 rounded-3xl border border-white/40 shadow-2xl w-full max-w-md p-6 relative max-h-[90vh] overflow-hidden flex flex-col">
        <button onclick="closeModuleModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center z-10">
          <span class="material-icons-round text-gray-500">close</span>
        </button>

        <!-- Module Header -->
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 rounded-xl bg-gradient-to-tr from-blue-500 to-cyan-400 flex items-center justify-center">
            <span class="text-2xl" id="moduleIcon">üìú</span>
          </div>
          <div>
            <h2 class="text-lg font-bold dark:text-white" id="moduleTitle">Module Title</h2>
            <p class="text-xs text-gray-500" id="moduleMeta">8 min ‚Ä¢ 100 points</p>
          </div>
        </div>

        <!-- Progress -->
        <div class="flex items-center gap-2 mb-4">
          <span class="text-xs text-gray-500" id="moduleSectionProgress">Section 1 of 4</span>
          <div class="flex-1 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
            <div class="h-full bg-acc-blue progress-bar" id="moduleSectionBar" style="width: 25%"></div>
          </div>
        </div>

        <!-- Content -->
        <div id="moduleContent" class="flex-1 overflow-y-auto">
          <h3 class="font-bold dark:text-white mb-2" id="moduleSectionTitle">Section Title</h3>
          <p class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed" id="moduleSectionText">
            Section content here...
          </p>
        </div>

        <!-- Actions -->
        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex gap-3">
          <button id="modulePrevBtn" onclick="prevModuleSection()" class="flex-1 bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-white font-bold py-3 rounded-2xl hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors">
            Previous
          </button>
          <button id="moduleNextBtn" onclick="nextModuleSection()" class="flex-1 bg-acc-blue text-white font-bold py-3 rounded-2xl shadow-lg hover:bg-acc-blue/90 transition-colors">
            Next
          </button>
        </div>
      </div>
    </div>

    <!-- Profile & Settings Modal -->
    <div id="profileModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50" onclick="closeProfileModal()"></div>
      <div class="modal-content glass bg-white/95 dark:bg-slate-900/95 rounded-3xl border border-white/40 shadow-2xl w-full max-w-md p-6 relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeProfileModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center">
          <span class="material-icons-round text-gray-500">close</span>
        </button>

        <!-- Profile Header -->
        <div class="text-center mb-6">
          <div class="w-20 h-20 rounded-full bg-gradient-to-tr from-primary to-pink-500 flex items-center justify-center mx-auto mb-3" id="profileAvatar">
            <span class="material-icons-round text-white text-3xl" id="profileAvatarIcon">person</span>
            <img id="profileAvatarImg" class="w-full h-full rounded-full object-cover hidden" alt="Profile"/>
          </div>
          <h2 class="text-xl font-bold dark:text-white" id="profileName">Cyclist</h2>
          <p class="text-sm text-gray-500" id="profileEmail">Sign in to save progress</p>
        </div>

        <!-- Points & Level -->
        <div class="bg-gradient-to-r from-primary to-pink-500 rounded-2xl p-4 mb-6 text-white">
          <div class="flex items-center justify-between mb-2">
            <div>
              <p class="text-xs text-white/70">Your Points</p>
              <p class="text-2xl font-bold" id="profilePoints" data-points-display>0</p>
            </div>
            <div class="text-right">
              <p class="text-xs text-white/70">Level</p>
              <p class="text-lg font-bold" id="profileLevel">Learner</p>
            </div>
          </div>
          <div class="h-2 bg-white/20 rounded-full overflow-hidden">
            <div class="h-full bg-white progress-bar" id="profileLevelBar" style="width: 20%"></div>
          </div>
          <p class="text-xs text-white/70 mt-1" id="profileLevelProgress">200 / 1000 points to next level</p>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-3 gap-3 mb-6">
          <div class="bg-gray-50 dark:bg-slate-800 rounded-xl p-3 text-center">
            <p class="text-xl font-bold text-acc-green" id="profileRides">0</p>
            <p class="text-xs text-gray-500">Rides</p>
          </div>
          <div class="bg-gray-50 dark:bg-slate-800 rounded-xl p-3 text-center">
            <p class="text-xl font-bold text-acc-blue" id="profileKm">0</p>
            <p class="text-xs text-gray-500">km</p>
          </div>
          <div class="bg-gray-50 dark:bg-slate-800 rounded-xl p-3 text-center">
            <p class="text-xl font-bold text-acc-yellow" id="profileCO2">0</p>
            <p class="text-xs text-gray-500">kg CO‚ÇÇ</p>
          </div>
        </div>

        <!-- Badges -->
        <div class="mb-6">
          <h3 class="font-bold dark:text-white mb-3 flex items-center gap-2">
            <span class="material-icons-round text-acc-yellow">military_tech</span>
            Badges Earned
          </h3>
          <div class="flex flex-wrap gap-2" id="profileBadges">
            <span class="text-2xl" title="First Ride">üö¥</span>
          </div>
        </div>

        <!-- Preferences -->
        <div class="mb-6">
          <h3 class="font-bold dark:text-white mb-3 flex items-center gap-2">
            <span class="material-icons-round text-primary">settings</span>
            Route Preferences
          </h3>
          <div class="space-y-3">
            <label class="flex items-center justify-between">
              <span class="text-sm dark:text-gray-300">Prefer shaded routes</span>
              <input type="checkbox" id="prefShade" class="w-5 h-5 rounded text-primary focus:ring-primary" onchange="updatePreference('preferShade', this.checked)"/>
            </label>
            <label class="flex items-center justify-between">
              <span class="text-sm dark:text-gray-300">Prefer scenic routes</span>
              <input type="checkbox" id="prefScenic" class="w-5 h-5 rounded text-primary focus:ring-primary" onchange="updatePreference('preferScenic', this.checked)"/>
            </label>
            <label class="flex items-center justify-between">
              <span class="text-sm dark:text-gray-300">Prefer safer routes</span>
              <input type="checkbox" id="prefSafe" class="w-5 h-5 rounded text-primary focus:ring-primary" checked onchange="updatePreference('preferSafe', this.checked)"/>
            </label>
            <label class="flex items-center justify-between">
              <span class="text-sm dark:text-gray-300">Prefer flat routes</span>
              <input type="checkbox" id="prefFlat" class="w-5 h-5 rounded text-primary focus:ring-primary" onchange="updatePreference('preferFlat', this.checked)"/>
            </label>
          </div>
        </div>

        <!-- App Settings -->
        <div class="mb-6">
          <h3 class="font-bold dark:text-white mb-3 flex items-center gap-2">
            <span class="material-icons-round text-acc-blue">tune</span>
            App Settings
          </h3>
          <div class="space-y-3">
            <label class="flex items-center justify-between">
              <span class="text-sm dark:text-gray-300">Dark mode</span>
              <input type="checkbox" id="settingDarkMode" class="w-5 h-5 rounded text-primary focus:ring-primary" onchange="toggleDarkMode(this.checked)"/>
            </label>
            <label class="flex items-center justify-between">
              <span class="text-sm dark:text-gray-300">Push notifications</span>
              <input type="checkbox" id="settingNotifications" class="w-5 h-5 rounded text-primary focus:ring-primary" onchange="toggleNotifications(this.checked)"/>
            </label>
          </div>
        </div>

        <!-- Premium Section -->
        <div id="premiumSection" class="mb-6 hidden">
          <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-2xl p-4 text-white">
            <div class="flex items-center gap-2 mb-2">
              <span class="material-icons-round">workspace_premium</span>
              <span class="font-bold">Premium Member</span>
            </div>
            <p class="text-sm text-white/80" id="premiumUntil">Valid until: --</p>
          </div>
        </div>

        <div id="upgradePremiumSection" class="mb-6">
          <button onclick="showPremiumOptions()" class="w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-bold py-3 rounded-2xl flex items-center justify-center gap-2 shadow-lg hover:shadow-xl transition-shadow">
            <span class="material-icons-round">workspace_premium</span>
            Upgrade to Premium
          </button>
        </div>

        <!-- Actions -->
        <div class="space-y-3">
          <button id="profileSignInBtn" onclick="showOnboardingForSignIn()" class="w-full bg-primary text-white font-bold py-3 rounded-2xl shadow-lg hover:bg-primary/90 transition-colors">
            Sign In
          </button>
          <button id="profileSignOutBtn" onclick="handleSignOut()" class="hidden w-full bg-red-500/10 text-red-500 font-bold py-3 rounded-2xl hover:bg-red-500/20 transition-colors">
            Sign Out
          </button>
        </div>

        <!-- Version -->
        <p class="text-center text-xs text-gray-400 mt-6">Micro2Move Sydney v1.0.0</p>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast fixed bottom-20 left-1/2 -translate-x-1/2 z-50 glass bg-slate-900/90 text-white px-6 py-3 rounded-full flex items-center gap-2 shadow-xl">
      <span class="material-icons-round text-acc-green">check_circle</span>
      <span id="toastMessage">Thanks, legend!</span>
    </div>

  </div>

  <!-- Config (contains API key - not committed to git) -->
  <script src="js/config.js"></script>

  <!-- Google Maps API (loaded dynamically) -->
  <script>
    // Load Google Maps with API key from config
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${window.GOOGLE_MAPS_API_KEY || 'YOUR_API_KEY'}&libraries=places,geometry&callback=initMap`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
  </script>

  <!-- Data -->
  <script src="js/data-planned.js"></script>
  <script src="js/data-community.js"></script>
  <script src="js/data-education.js"></script>
  <script src="js/data-veloways.js"></script>

  <!-- App Logic -->
  <script>
    // ============================================
    // GLOBAL STATE
    // ============================================
    let map = null;
    let polylines = [];
    let poiMarkers = [];
    let selectedProject = null;
    let selectedPoi = null;
    let currentView = 'current';
    let isSheetExpanded = false;
    let showCharging = true;
    let showStores = true;
    let showCommunities = true;
    let showVeloways = true;

    // ============================================
    // MAP INITIALIZATION
    // ============================================
    function initMap() {
      // Sydney CBD center
      const sydneyCenter = { lat: -33.8688, lng: 151.2093 };

      map = new google.maps.Map(document.getElementById('map'), {
        center: sydneyCenter,
        zoom: 14,
        disableDefaultUI: true,
        zoomControl: true,
        zoomControlOptions: {
          position: google.maps.ControlPosition.RIGHT_CENTER
        },
        styles: getMapStyles()
      });

      // Add cycleways to map
      addCyclewaysToMap();

      // Add POI markers
      addPoiMarkers();

      // Map click - deselect
      map.addListener('click', () => {
        deselectProject();
      });

      // Update stats
      updateStats('current');
    }

    // ============================================
    // ADD POI MARKERS
    // ============================================
    function addPoiMarkers() {
      // Charging Stations
      if (typeof EBIKE_CHARGING_STATIONS !== 'undefined') {
        EBIKE_CHARGING_STATIONS.forEach(station => {
          const marker = createPoiMarker(station, '‚ö°', '#10B981', 'charging');
          poiMarkers.push(marker);
        });
      }

      // E-Bike Stores
      if (typeof EBIKE_STORES !== 'undefined') {
        EBIKE_STORES.forEach(store => {
          const marker = createPoiMarker(store, 'üè™', '#3B82F6', 'store');
          poiMarkers.push(marker);
        });
      }

      // Communities
      if (typeof BIKE_COMMUNITIES !== 'undefined') {
        BIKE_COMMUNITIES.forEach(community => {
          const marker = createPoiMarker(community, 'üë•', '#F59E0B', 'community');
          poiMarkers.push(marker);
        });
      }
    }

    function createPoiMarker(poi, emoji, color, type) {
      const marker = new google.maps.Marker({
        position: poi.location,
        map: map,
        icon: {
          url: `data:image/svg+xml,${encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="50" viewBox="0 0 40 50">
              <defs>
                <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                  <feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.3"/>
                </filter>
              </defs>
              <path d="M20 0 C9 0 0 9 0 20 C0 35 20 50 20 50 C20 50 40 35 40 20 C40 9 31 0 20 0Z" fill="${color}" filter="url(#shadow)"/>
              <circle cx="20" cy="18" r="12" fill="white"/>
              <text x="20" y="23" text-anchor="middle" font-size="14">${emoji}</text>
            </svg>
          `)}`,
          scaledSize: new google.maps.Size(40, 50),
          anchor: new google.maps.Point(20, 50)
        },
        title: poi.name
      });

      marker.poiData = poi;
      marker.poiType = type;

      marker.addListener('click', () => {
        openPoiDetail(poi, type);
      });

      return marker;
    }

    function updatePoiVisibility() {
      poiMarkers.forEach(marker => {
        const type = marker.poiType;
        let visible = false;

        if (type === 'charging' && showCharging) visible = true;
        if (type === 'store' && showStores) visible = true;
        if (type === 'community' && showCommunities) visible = true;

        marker.setMap(visible ? map : null);
      });
    }

    function updateVelowayVisibility() {
      polylines.forEach(polyline => {
        if (polyline.isVeloway) {
          const project = polyline.projectData;
          let shouldShow = showVeloways;

          // Also respect the current network view filter
          if (shouldShow) {
            switch (currentView) {
              case 'current':
                shouldShow = project.status === 'existing';
                break;
              case 'future':
                shouldShow = ['existing', 'under_construction', 'funded'].includes(project.status);
                break;
              case 'all':
                shouldShow = true;
                break;
            }
          }

          polyline.setMap(shouldShow ? map : null);
        }
      });
    }

    // ============================================
    // MAP STYLES
    // ============================================
    function getMapStyles() {
      const isDark = document.documentElement.classList.contains('dark');

      if (isDark) {
        return [
          { elementType: "geometry", stylers: [{ color: "#1a1a2e" }] },
          { elementType: "labels.text.stroke", stylers: [{ color: "#1a1a2e" }] },
          { elementType: "labels.text.fill", stylers: [{ color: "#8a8a8a" }] },
          { featureType: "road", elementType: "geometry", stylers: [{ color: "#2d2d44" }] },
          { featureType: "water", elementType: "geometry", stylers: [{ color: "#0e1626" }] },
          { featureType: "poi", stylers: [{ visibility: "off" }] },
          { featureType: "transit", stylers: [{ visibility: "off" }] }
        ];
      }

      return [
        { featureType: "water", elementType: "geometry", stylers: [{ color: "#e9e9e9" }] },
        { featureType: "road", elementType: "geometry.fill", stylers: [{ color: "#ffffff" }] },
        { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#e0e0e0" }] },
        { featureType: "poi", stylers: [{ visibility: "off" }] },
        { featureType: "transit", stylers: [{ visibility: "off" }] }
      ];
    }

    // ============================================
    // ADD CYCLEWAYS TO MAP
    // ============================================
    function addCyclewaysToMap() {
      if (typeof EXISTING_CYCLEWAYS !== 'undefined') {
        EXISTING_CYCLEWAYS.forEach(cycleway => {
          if (!cycleway.coordinates || cycleway.coordinates.length < 2) return;
          createPolyline(cycleway);
        });
      }

      if (typeof PLANNED_CYCLEWAYS !== 'undefined') {
        PLANNED_CYCLEWAYS.forEach(project => {
          if (!project.coordinates || project.coordinates.length < 2) return;
          createPolyline(project);
        });
      }

      // Add Veloway Routes (Eastern Sydney Regional Bike Network)
      if (typeof VELOWAY_ROUTES !== 'undefined') {
        VELOWAY_ROUTES.forEach(veloway => {
          if (!veloway.coordinates || veloway.coordinates.length < 2) return;
          createPolyline(veloway, true); // true = is veloway
        });
      }

      // Apply initial view filter
      switchNetworkView('current');
    }

    function createPolyline(project, isVeloway = false) {
      const color = getStatusColor(project.status);
      const isPlanned = project.status === 'planned' || project.status === 'proposed';
      const baseWeight = isVeloway ? 8 : 6;
      const hoverWeight = isVeloway ? 12 : 10;

      const polylineOptions = {
        path: project.coordinates,
        strokeColor: isVeloway ? '#EC4899' : color, // Pink for veloways
        strokeOpacity: isPlanned ? 0 : (isVeloway ? 0.9 : 1),
        strokeWeight: baseWeight,
        map: null,
        zIndex: isVeloway ? 150 : (project.status === 'existing' ? 100 : 50)
      };

      const polyline = new google.maps.Polyline(polylineOptions);

      // Dashed line for planned/proposed
      if (isPlanned) {
        polyline.setOptions({
          icons: [{
            icon: {
              path: 'M 0,-1 0,1',
              strokeOpacity: 0.8,
              strokeColor: isVeloway ? '#EC4899' : color,
              strokeWeight: baseWeight,
              scale: isVeloway ? 5 : 4
            },
            offset: '0',
            repeat: isVeloway ? '25px' : '20px'
          }]
        });
      }

      polyline.projectData = project;
      polyline.isVeloway = isVeloway;
      polylines.push(polyline);

      // Click listener
      polyline.addListener('click', () => {
        selectProject(project);
      });

      // Hover effects
      polyline.addListener('mouseover', () => {
        polyline.setOptions({ strokeWeight: hoverWeight });
      });

      polyline.addListener('mouseout', () => {
        polyline.setOptions({ strokeWeight: baseWeight });
      });
    }

    function getStatusColor(status) {
      const colors = {
        'existing': '#22C55E',
        'completed_2026': '#10B981',
        'under_construction': '#F59E0B',
        'funded': '#3B82F6',
        'planned': '#8B5CF6',
        'proposed': '#6B7280'
      };
      return colors[status] || '#6B7280';
    }

    // ============================================
    // SWITCH NETWORK VIEW
    // ============================================
    function switchNetworkView(view) {
      currentView = view;

      polylines.forEach(polyline => {
        const project = polyline.projectData;
        let shouldShow = false;

        // Check if veloway layer is enabled
        if (polyline.isVeloway && !showVeloways) {
          polyline.setMap(null);
          return;
        }

        switch (view) {
          case 'current':
            shouldShow = project.status === 'existing';
            break;
          case 'future':
            shouldShow = ['existing', 'completed_2026', 'under_construction', 'funded'].includes(project.status);
            break;
          case 'all':
            shouldShow = true;
            break;
        }

        polyline.setMap(shouldShow ? map : null);
      });

      updateStats(view);
    }

    // ============================================
    // UPDATE STATS
    // ============================================
    function updateStats(view) {
      const stats = typeof NETWORK_STATS !== 'undefined' ? NETWORK_STATS : null;
      if (!stats) return;

      let data;
      switch (view) {
        case 'current':
          data = stats.current;
          break;
        case 'future':
          data = stats.planned_2026;
          break;
        case 'all':
          data = stats.strategic_2030;
          break;
      }

      if (data) {
        document.getElementById('statsKm').textContent = data.total_km || '--';
        document.getElementById('statsTrips').textContent =
          data.daily_trips ? (data.daily_trips / 1000).toFixed(0) + 'k' :
          data.estimated_daily_trips ? (data.estimated_daily_trips / 1000).toFixed(0) + 'k' : '--';
      }

      // Count projects
      const projectCount = polylines.filter(p => {
        const project = p.projectData;
        switch (view) {
          case 'current': return project.status === 'existing';
          case 'future': return ['existing', 'completed_2026', 'under_construction', 'funded'].includes(project.status);
          case 'all': return true;
        }
      }).length;
      document.getElementById('statsProjects').textContent = projectCount;
    }

    // ============================================
    // SELECT PROJECT
    // ============================================
    function selectProject(project) {
      selectedProject = project;

      // Update sheet content
      const statusLabels = {
        'existing': 'OPEN',
        'completed_2026': 'OPENED 2026',
        'under_construction': 'UNDER CONSTRUCTION',
        'funded': 'FUNDED',
        'planned': 'PLANNED',
        'proposed': 'UNDER INVESTIGATION'
      };

      const badge = document.getElementById('sheetBadge');
      badge.textContent = statusLabels[project.status] || project.status.toUpperCase();
      badge.className = 'text-xs font-bold px-2 py-0.5 rounded-full ';

      switch (project.status) {
        case 'existing':
        case 'completed_2026':
          badge.className += 'text-acc-green bg-green-100 dark:bg-green-900/30';
          break;
        case 'under_construction':
          badge.className += 'text-acc-orange bg-orange-100 dark:bg-orange-900/30';
          break;
        case 'funded':
          badge.className += 'text-acc-blue bg-blue-100 dark:bg-blue-900/30';
          break;
        case 'planned':
          badge.className += 'text-primary bg-purple-100 dark:bg-purple-900/30';
          break;
        default:
          badge.className += 'text-gray-600 bg-gray-100 dark:bg-gray-800';
      }

      document.getElementById('sheetTitle').textContent = project.name;
      document.getElementById('sheetMeta').textContent =
        (project.local_areas?.join(', ') || '') +
        (project.length_km ? ' ‚Ä¢ ' + project.length_km + ' km' : '');

      // Ratings
      const rating = project.daily_trips ? (project.daily_trips / 1000 + 3).toFixed(1) : '--';
      document.getElementById('sheetRating').textContent = rating;
      document.getElementById('sheetReviewCount').textContent =
        project.daily_trips ? Math.floor(project.daily_trips / 50) + ' Reviews' : '-- Reviews';

      // Safety/Surface scores (simulated)
      const safetyScore = project.facility_type === 'separated_cycleway' ? 8.5 : 6.0;
      const surfaceScore = project.status === 'existing' ? 7.5 : 8.0;

      document.getElementById('safetyBar').style.width = (safetyScore * 10) + '%';
      document.getElementById('safetyScore').textContent = safetyScore.toFixed(1);
      document.getElementById('surfaceBar').style.width = (surfaceScore * 10) + '%';
      document.getElementById('surfaceScore').textContent = surfaceScore.toFixed(1);

      // Project info
      const projectInfo = document.getElementById('projectInfo');
      if (project.budget_aud || project.description) {
        projectInfo.classList.remove('hidden');

        document.getElementById('projectBudget').textContent =
          project.budget_aud ? '$' + (project.budget_aud / 1000000).toFixed(1) + 'M' : 'TBC';
        document.getElementById('projectLength').textContent =
          project.length_km ? project.length_km + ' km' : '--';
        document.getElementById('projectCompletion').textContent =
          project.expected_completion || project.completion_date || 'TBC';
        document.getElementById('projectDescription').textContent = project.description || '';

        // Benefits
        const benefitsSection = document.getElementById('projectBenefits');
        const benefitsList = document.getElementById('benefitsList');
        if (project.benefits && project.benefits.length > 0) {
          benefitsSection.classList.remove('hidden');
          benefitsList.innerHTML = project.benefits.map(b =>
            `<li class="text-sm text-gray-600 dark:text-gray-300 flex items-start gap-2">
              <span class="text-acc-green">‚úì</span> ${b}
            </li>`
          ).join('');
        } else {
          benefitsSection.classList.add('hidden');
        }

        // Connections
        const connectionsSection = document.getElementById('projectConnections');
        if (project.connects_to && project.connects_to.length > 0) {
          connectionsSection.classList.remove('hidden');
          document.getElementById('connectionsList').textContent = project.connects_to.join(', ');
        } else {
          connectionsSection.classList.add('hidden');
        }
      } else {
        projectInfo.classList.add('hidden');
      }

      // Show review section for existing cycleways
      const reviewSection = document.getElementById('reviewSection');
      if (project.status === 'existing' && project.daily_trips) {
        reviewSection.classList.remove('hidden');
        document.getElementById('reviewText').textContent =
          '"Great protected lane, perfect for morning commutes!"';
      } else {
        reviewSection.classList.add('hidden');
      }

      // Expand sheet
      expandSheet();

      // Pan map
      if (project.coordinates && project.coordinates.length > 0) {
        const midIdx = Math.floor(project.coordinates.length / 2);
        map.panTo(project.coordinates[midIdx]);
      }
    }

    function deselectProject() {
      selectedProject = null;
      collapseSheet();

      document.getElementById('sheetTitle').textContent = 'Select a cycleway';
      document.getElementById('sheetMeta').textContent = 'Tap on the map to view details';
      document.getElementById('sheetBadge').textContent = 'BROWSE';
      document.getElementById('sheetBadge').className = 'text-xs font-bold px-2 py-0.5 rounded-full text-gray-600 bg-gray-100 dark:bg-gray-800';
      document.getElementById('sheetRating').textContent = '--';
      document.getElementById('sheetReviewCount').textContent = '-- Reviews';
      document.getElementById('projectInfo').classList.add('hidden');
      document.getElementById('reviewSection').classList.add('hidden');
    }

    // ============================================
    // BOTTOM SHEET
    // ============================================
    function expandSheet() {
      const sheet = document.getElementById('bottomSheet');
      sheet.classList.remove('collapsed');
      isSheetExpanded = true;
      document.getElementById('statsBanner').style.display = 'none';
    }

    function collapseSheet() {
      const sheet = document.getElementById('bottomSheet');
      sheet.classList.add('collapsed');
      isSheetExpanded = false;
      document.getElementById('statsBanner').style.display = 'block';
    }

    // ============================================
    // MODALS
    // ============================================
    function openReportModal() {
      document.getElementById('reportModal').classList.add('visible');
    }

    function closeReportModal() {
      document.getElementById('reportModal').classList.remove('visible');
    }

    function openCommunityModal() {
      document.getElementById('communityModal').classList.add('visible');
      loadCommunityFeed();
    }

    function closeCommunityModal() {
      document.getElementById('communityModal').classList.remove('visible');
    }

    function loadCommunityFeed() {
      // Load Feed Tab
      const feed = document.getElementById('tabFeed');
      if (typeof INFRASTRUCTURE_COMMENTS !== 'undefined') {
        feed.innerHTML = INFRASTRUCTURE_COMMENTS.map(comment => `
          <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl">
            <div class="flex items-center gap-2 mb-2">
              <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center">
                <span class="text-white text-xs font-bold">${comment.user.avatar}</span>
              </div>
              <span class="font-semibold dark:text-white">${comment.user.name}</span>
              ${comment.user.verified ? '<span class="material-icons-round text-acc-blue text-sm">verified</span>' : ''}
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">${comment.text}</p>
            <div class="flex items-center justify-between">
              <span class="text-xs text-gray-400">${formatTimeAgo(comment.timestamp)}</span>
              <div class="flex items-center gap-3">
                <button onclick="vote('${comment.id}', 'up')" class="flex items-center gap-1 text-xs text-gray-500 hover:text-acc-green transition-colors">
                  <span class="material-icons-round text-sm">thumb_up</span>
                  <span>${comment.upvotes}</span>
                </button>
                <button onclick="vote('${comment.id}', 'down')" class="flex items-center gap-1 text-xs text-gray-500 hover:text-red-500 transition-colors">
                  <span class="material-icons-round text-sm">thumb_down</span>
                  <span>${comment.downvotes}</span>
                </button>
              </div>
            </div>
          </div>
        `).join('');
      }

      // Load Groups Tab
      const groups = document.getElementById('tabGroups');
      if (typeof BIKE_COMMUNITIES !== 'undefined') {
        groups.innerHTML = BIKE_COMMUNITIES.map(comm => `
          <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl">
            <div class="flex justify-between items-start mb-2">
              <h3 class="font-bold dark:text-white">${comm.name}</h3>
              <span class="text-xs text-gray-400">${comm.members.toLocaleString()} members</span>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">${comm.description}</p>
            <div class="flex flex-wrap gap-1 mb-3">
              ${comm.focus.map(f => `<span class="text-xs px-2 py-0.5 rounded-full bg-primary/10 text-primary">${f}</span>`).join('')}
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <button onclick="vote('${comm.id}', 'up')" class="flex items-center gap-1 text-xs text-gray-500 hover:text-acc-green">
                  <span class="material-icons-round text-sm">thumb_up</span> ${comm.upvotes}
                </button>
                <button onclick="vote('${comm.id}', 'down')" class="flex items-center gap-1 text-xs text-gray-500 hover:text-red-500">
                  <span class="material-icons-round text-sm">thumb_down</span> ${comm.downvotes}
                </button>
              </div>
              <a href="${comm.website}" target="_blank" class="text-xs text-primary font-medium">Visit ‚Üí</a>
            </div>
          </div>
        `).join('');
      }

      // Load Charging Tab
      const charging = document.getElementById('tabCharging');
      if (typeof EBIKE_CHARGING_STATIONS !== 'undefined') {
        charging.innerHTML = EBIKE_CHARGING_STATIONS.map(station => `
          <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl" onclick="openPoiDetail(EBIKE_CHARGING_STATIONS.find(s => s.id === '${station.id}'), 'charging')">
            <div class="flex justify-between items-start mb-2">
              <div class="flex items-center gap-2">
                <span class="text-xl">‚ö°</span>
                <h3 class="font-bold dark:text-white">${station.name}</h3>
              </div>
              <span class="text-xs px-2 py-0.5 rounded-full ${station.available > 3 ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                ${station.available}/${station.capacity} available
              </span>
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">${station.address}</p>
            <div class="flex items-center gap-2 mb-2">
              ${station.amenities.slice(0, 3).map(a => `<span class="text-xs px-2 py-0.5 rounded-full bg-gray-200 dark:bg-gray-700 dark:text-gray-300">${getAmenityIcon(a)} ${getAmenityLabel(a)}</span>`).join('')}
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-1 text-acc-yellow">
                <span class="material-icons-round text-sm">star</span>
                <span class="text-sm font-bold dark:text-white">${station.rating}</span>
                <span class="text-xs text-gray-400">(${station.reviews})</span>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="event.stopPropagation(); vote('${station.id}', 'up')" class="flex items-center gap-1 text-xs text-gray-500 hover:text-acc-green">
                  <span class="material-icons-round text-sm">thumb_up</span> ${station.upvotes}
                </button>
                <button onclick="event.stopPropagation(); vote('${station.id}', 'down')" class="flex items-center gap-1 text-xs text-gray-500 hover:text-red-500">
                  <span class="material-icons-round text-sm">thumb_down</span> ${station.downvotes}
                </button>
              </div>
            </div>
          </div>
        `).join('');
      }

      // Load Stores Tab
      const stores = document.getElementById('tabStores');
      if (typeof EBIKE_STORES !== 'undefined') {
        stores.innerHTML = EBIKE_STORES.map(store => `
          <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl" onclick="openPoiDetail(EBIKE_STORES.find(s => s.id === '${store.id}'), 'store')">
            <div class="flex justify-between items-start mb-2">
              <div class="flex items-center gap-2">
                <span class="text-xl">üè™</span>
                <h3 class="font-bold dark:text-white">${store.name}</h3>
              </div>
              ${store.demo_available ? '<span class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700">Demos ‚úì</span>' : ''}
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">${store.address}</p>
            <div class="flex flex-wrap gap-1 mb-2">
              ${store.services.map(s => `<span class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400">${s}</span>`).join('')}
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-1 text-acc-yellow">
                <span class="material-icons-round text-sm">star</span>
                <span class="text-sm font-bold dark:text-white">${store.rating}</span>
                <span class="text-xs text-gray-400">(${store.reviews})</span>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="event.stopPropagation(); vote('${store.id}', 'up')" class="flex items-center gap-1 text-xs text-gray-500 hover:text-acc-green">
                  <span class="material-icons-round text-sm">thumb_up</span> ${store.upvotes}
                </button>
                <button onclick="event.stopPropagation(); vote('${store.id}', 'down')" class="flex items-center gap-1 text-xs text-gray-500 hover:text-red-500">
                  <span class="material-icons-round text-sm">thumb_down</span> ${store.downvotes}
                </button>
              </div>
            </div>
          </div>
        `).join('');
      }
    }

    // ============================================
    // POI DETAIL MODAL
    // ============================================
    function openPoiDetail(poi, type) {
      selectedPoi = poi;
      const content = document.getElementById('poiContent');

      if (type === 'charging') {
        content.innerHTML = `
          <div class="text-center mb-4">
            <span class="text-5xl">‚ö°</span>
          </div>
          <h2 class="text-xl font-bold dark:text-white text-center mb-1">${poi.name}</h2>
          <p class="text-sm text-gray-500 dark:text-gray-400 text-center mb-4">${poi.address}</p>

          <div class="flex justify-center gap-1 mb-4">
            ${[...Array(5)].map((_, i) => `<span class="material-icons-round ${i < Math.floor(poi.rating) ? 'text-acc-yellow' : 'text-gray-300'} text-xl">star</span>`).join('')}
            <span class="ml-2 font-bold dark:text-white">${poi.rating}</span>
          </div>

          <div class="bg-gray-50 dark:bg-slate-800 rounded-xl p-4 mb-4">
            <div class="flex justify-between items-center mb-2">
              <span class="text-sm text-gray-600 dark:text-gray-300">Available Spots</span>
              <span class="text-lg font-bold ${poi.available > 3 ? 'text-acc-green' : 'text-acc-orange'}">${poi.available}/${poi.capacity}</span>
            </div>
            <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
              <div class="h-full ${poi.available > 3 ? 'bg-acc-green' : 'bg-acc-orange'}" style="width: ${(poi.available / poi.capacity) * 100}%"></div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2 mb-4">
            ${poi.amenities.map(a => `
              <div class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-slate-800 rounded-lg">
                <span>${getAmenityIcon(a)}</span>
                <span class="text-sm dark:text-white">${getAmenityLabel(a)}</span>
              </div>
            `).join('')}
          </div>

          <div class="flex items-center justify-between mb-4 p-3 bg-gray-50 dark:bg-slate-800 rounded-xl">
            <span class="text-sm text-gray-600 dark:text-gray-300">Hours</span>
            <span class="font-medium dark:text-white">${poi.hours}</span>
          </div>

          <div class="flex items-center justify-center gap-6 mb-4">
            <button onclick="vote('${poi.id}', 'up')" class="flex flex-col items-center gap-1 p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors">
              <span class="material-icons-round text-2xl text-acc-green">thumb_up</span>
              <span class="text-sm font-bold dark:text-white">${poi.upvotes}</span>
            </button>
            <button onclick="vote('${poi.id}', 'down')" class="flex flex-col items-center gap-1 p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors">
              <span class="material-icons-round text-2xl text-red-500">thumb_down</span>
              <span class="text-sm font-bold dark:text-white">${poi.downvotes}</span>
            </button>
          </div>

          <button onclick="openCommentsForPoi('${poi.id}')" class="w-full bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-white font-bold py-3 rounded-2xl mb-3 hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors">
            üí¨ View Comments (${poi.reviews})
          </button>

          <button onclick="getDirectionsToPoi()" class="w-full bg-primary text-white font-bold py-3 rounded-2xl shadow-lg shadow-primary/30 hover:bg-primary/90 transition-colors">
            <span class="material-icons-round align-middle mr-1">directions</span> Get Directions
          </button>
        `;
      } else if (type === 'store') {
        content.innerHTML = `
          <div class="text-center mb-4">
            <span class="text-5xl">üè™</span>
          </div>
          <h2 class="text-xl font-bold dark:text-white text-center mb-1">${poi.name}</h2>
          <p class="text-sm text-gray-500 dark:text-gray-400 text-center mb-4">${poi.address}</p>

          <div class="flex justify-center gap-1 mb-4">
            ${[...Array(5)].map((_, i) => `<span class="material-icons-round ${i < Math.floor(poi.rating) ? 'text-acc-yellow' : 'text-gray-300'} text-xl">star</span>`).join('')}
            <span class="ml-2 font-bold dark:text-white">${poi.rating}</span>
          </div>

          ${poi.demo_available ? `
            <div class="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 p-3 rounded-xl text-center mb-4 font-medium">
              ‚úì Test Rides / Demos Available
            </div>
          ` : ''}

          <div class="mb-4">
            <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Services</h4>
            <div class="flex flex-wrap gap-2">
              ${poi.services.map(s => `<span class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400 text-sm">${s}</span>`).join('')}
            </div>
          </div>

          <div class="mb-4">
            <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Brands</h4>
            <div class="flex flex-wrap gap-2">
              ${poi.brands.map(b => `<span class="px-3 py-1 rounded-full bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-gray-300 text-sm">${b}</span>`).join('')}
            </div>
          </div>

          <div class="space-y-2 mb-4">
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-800 rounded-xl">
              <span class="text-sm text-gray-600 dark:text-gray-300">Hours</span>
              <span class="font-medium dark:text-white text-sm">${poi.hours}</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-800 rounded-xl">
              <span class="text-sm text-gray-600 dark:text-gray-300">Phone</span>
              <a href="tel:${poi.phone}" class="font-medium text-primary">${poi.phone}</a>
            </div>
          </div>

          <div class="flex items-center justify-center gap-6 mb-4">
            <button onclick="vote('${poi.id}', 'up')" class="flex flex-col items-center gap-1 p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors">
              <span class="material-icons-round text-2xl text-acc-green">thumb_up</span>
              <span class="text-sm font-bold dark:text-white">${poi.upvotes}</span>
            </button>
            <button onclick="vote('${poi.id}', 'down')" class="flex flex-col items-center gap-1 p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors">
              <span class="material-icons-round text-2xl text-red-500">thumb_down</span>
              <span class="text-sm font-bold dark:text-white">${poi.downvotes}</span>
            </button>
          </div>

          <button onclick="getDirectionsToPoi()" class="w-full bg-primary text-white font-bold py-3 rounded-2xl shadow-lg shadow-primary/30 hover:bg-primary/90 transition-colors">
            <span class="material-icons-round align-middle mr-1">directions</span> Get Directions
          </button>
        `;
      } else if (type === 'community') {
        content.innerHTML = `
          <div class="text-center mb-4">
            <span class="text-5xl">üë•</span>
          </div>
          <h2 class="text-xl font-bold dark:text-white text-center mb-1">${poi.name}</h2>
          <p class="text-sm text-gray-500 dark:text-gray-400 text-center mb-4">${poi.members.toLocaleString()} members</p>

          <p class="text-sm text-gray-600 dark:text-gray-300 text-center mb-4">${poi.description}</p>

          <div class="flex flex-wrap justify-center gap-2 mb-4">
            ${poi.focus.map(f => `<span class="px-3 py-1 rounded-full bg-primary/10 text-primary text-sm font-medium">${f}</span>`).join('')}
          </div>

          ${poi.rides && poi.rides.length > 0 ? `
            <div class="mb-4">
              <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Regular Rides</h4>
              <div class="space-y-2">
                ${poi.rides.map(r => `
                  <div class="p-3 bg-gray-50 dark:bg-slate-800 rounded-xl">
                    <div class="flex justify-between items-center">
                      <span class="font-medium dark:text-white">${r.type}</span>
                      <span class="text-xs px-2 py-0.5 rounded-full bg-gray-200 dark:bg-gray-700 dark:text-gray-300">${r.difficulty}</span>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">${r.day} at ${r.time}</p>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <div class="flex items-center justify-center gap-6 mb-4">
            <button onclick="vote('${poi.id}', 'up')" class="flex flex-col items-center gap-1 p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors">
              <span class="material-icons-round text-2xl text-acc-green">thumb_up</span>
              <span class="text-sm font-bold dark:text-white">${poi.upvotes}</span>
            </button>
            <button onclick="vote('${poi.id}', 'down')" class="flex flex-col items-center gap-1 p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors">
              <span class="material-icons-round text-2xl text-red-500">thumb_down</span>
              <span class="text-sm font-bold dark:text-white">${poi.downvotes}</span>
            </button>
          </div>

          <a href="https://${poi.website}" target="_blank" class="block w-full bg-primary text-white font-bold py-3 rounded-2xl text-center shadow-lg shadow-primary/30 hover:bg-primary/90 transition-colors">
            Visit Website ‚Üí
          </a>
        `;
      }

      document.getElementById('poiModal').classList.add('visible');

      // Pan to POI
      if (poi.location) {
        map.panTo(poi.location);
        map.setZoom(16);
      }
    }

    function closePoiModal() {
      document.getElementById('poiModal').classList.remove('visible');
      selectedPoi = null;
    }

    function getDirectionsToPoi() {
      if (selectedPoi && selectedPoi.location) {
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${selectedPoi.location.lat},${selectedPoi.location.lng}&travelmode=bicycling`, '_blank');
      }
    }

    // ============================================
    // LAYERS MODAL
    // ============================================
    function openLayersModal() {
      document.getElementById('layersModal').classList.add('visible');
    }

    function closeLayersModal() {
      document.getElementById('layersModal').classList.remove('visible');
    }

    // ============================================
    // COMMENTS MODAL
    // ============================================
    function openCommentsForPoi(poiId) {
      document.getElementById('commentsTitle').textContent = 'Comments';
      document.getElementById('commentsSubtitle').textContent = 'Community feedback';

      const commentsList = document.getElementById('commentsList');
      commentsList.innerHTML = `
        <div class="space-y-3">
          <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl">
            <div class="flex items-center gap-2 mb-2">
              <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-cyan-500 flex items-center justify-center">
                <span class="text-white text-xs font-bold">J</span>
              </div>
              <span class="font-semibold dark:text-white">Jake S.</span>
              <span class="text-xs text-gray-400">1 day ago</span>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-300">Great location! Always has spots available in the morning.</p>
            <div class="flex items-center gap-3 mt-2">
              <button class="flex items-center gap-1 text-xs text-gray-500 hover:text-acc-green">
                <span class="material-icons-round text-sm">thumb_up</span> 8
              </button>
              <button class="flex items-center gap-1 text-xs text-gray-500 hover:text-red-500">
                <span class="material-icons-round text-sm">thumb_down</span> 0
              </button>
            </div>
          </div>
          <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl">
            <div class="flex items-center gap-2 mb-2">
              <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-orange-500 to-red-500 flex items-center justify-center">
                <span class="text-white text-xs font-bold">M</span>
              </div>
              <span class="font-semibold dark:text-white">Maya T.</span>
              <span class="text-xs text-gray-400">3 days ago</span>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-300">Fast charging works perfectly. My e-bike was fully charged in under an hour.</p>
            <div class="flex items-center gap-3 mt-2">
              <button class="flex items-center gap-1 text-xs text-gray-500 hover:text-acc-green">
                <span class="material-icons-round text-sm">thumb_up</span> 12
              </button>
              <button class="flex items-center gap-1 text-xs text-gray-500 hover:text-red-500">
                <span class="material-icons-round text-sm">thumb_down</span> 1
              </button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('commentsModal').classList.add('visible');
    }

    function closeCommentsModal() {
      document.getElementById('commentsModal').classList.remove('visible');
    }

    function submitComment() {
      const textarea = document.getElementById('newComment');
      if (textarea.value.trim()) {
        showToast('Comment posted! üí¨');
        textarea.value = '';
        closeCommentsModal();
      }
    }

    // ============================================
    // VOTING
    // ============================================
    function vote(id, direction) {
      showToast(direction === 'up' ? 'Upvoted! üëç' : 'Downvoted üëé');
    }

    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    function formatTimeAgo(timestamp) {
      const now = new Date();
      const date = new Date(timestamp);
      const seconds = Math.floor((now - date) / 1000);

      if (seconds < 60) return 'just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
      return date.toLocaleDateString();
    }

    function getAmenityIcon(amenity) {
      const icons = {
        'fast_charging': '‚ö°',
        'secure_lock': 'üîí',
        'covered': 'üè†',
        'repair_tools': 'üîß',
        'student_discount': 'üéì'
      };
      return icons[amenity] || '‚úì';
    }

    function getAmenityLabel(amenity) {
      const labels = {
        'fast_charging': 'Fast Charging',
        'secure_lock': 'Secure Lock',
        'covered': 'Covered',
        'repair_tools': 'Repair Tools',
        'student_discount': 'Student Discount'
      };
      return labels[amenity] || amenity;
    }

    // ============================================
    // TOAST
    // ============================================
    function showToast(message) {
      const toast = document.getElementById('toast');
      document.getElementById('toastMessage').textContent = message;
      toast.classList.add('visible');
      setTimeout(() => toast.classList.remove('visible'), 3000);
    }

    // ============================================
    // AI ROUTE PLANNING (GEMINI)
    // ============================================
    let aiRoutePolyline = null;
    let aiRouteMarkers = [];
    let lastAiRouteData = null;

    function openAiRouteModal() {
      document.getElementById('aiRouteModal').classList.add('visible');
      // Reset state
      document.getElementById('generateRouteBtn').classList.remove('hidden');
      document.getElementById('aiRouteLoading').classList.add('hidden');
      document.getElementById('aiRouteResult').classList.add('hidden');
    }

    function closeAiRouteModal() {
      document.getElementById('aiRouteModal').classList.remove('visible');
    }

    async function generateAiRoute() {
      const from = document.getElementById('aiRouteFrom').value.trim();
      const to = document.getElementById('aiRouteTo').value.trim();

      if (!from || !to) {
        showToast('Please enter start and destination');
        return;
      }

      // Get preferences
      const preferences = [];
      if (document.getElementById('prefCoffee').checked) preferences.push('coffee shop stop');
      if (document.getElementById('prefShade').checked) preferences.push('shady tree-lined streets');
      if (document.getElementById('prefScenic').checked) preferences.push('scenic harbour/water views');
      if (document.getElementById('prefCharging').checked) preferences.push('e-bike charging station');
      if (document.getElementById('prefFlat').checked) preferences.push('flat terrain with minimal hills');
      if (document.getElementById('prefSafe').checked) preferences.push('separated bike lanes for safety');

      const customRequest = document.getElementById('aiRouteCustom').value.trim();

      // Show loading
      document.getElementById('generateRouteBtn').classList.add('hidden');
      document.getElementById('aiRouteLoading').classList.remove('hidden');
      document.getElementById('aiRouteResult').classList.add('hidden');

      try {
        const routeData = await callGeminiForRoute(from, to, preferences, customRequest);
        displayAiRouteResult(routeData);
      } catch (error) {
        console.error('AI Route Error:', error);
        showToast('AI route generation failed. Check API key.');
        document.getElementById('generateRouteBtn').classList.remove('hidden');
        document.getElementById('aiRouteLoading').classList.add('hidden');
      }
    }

    async function callGeminiForRoute(from, to, preferences, customRequest) {
      const apiKey = window.GEMINI_API_KEY;

      if (!apiKey || apiKey === 'YOUR_GEMINI_API_KEY_HERE') {
        // Demo mode - return mock data
        return getMockRouteData(from, to, preferences);
      }

      const prefText = preferences.length > 0 ? preferences.join(', ') : 'most direct bike-friendly route';
      const customText = customRequest ? `\nAdditional request: ${customRequest}` : '';

      const prompt = `You are a Sydney cycling route planner AI. Plan a bike route from "${from}" to "${to}" in Sydney, Australia.

User preferences: ${prefText}${customText}

Respond in this exact JSON format (no markdown, just raw JSON):
{
  "summary": "Brief 1-2 sentence description of the route",
  "distance_km": 5.2,
  "duration_mins": 22,
  "elevation_gain_m": 45,
  "route_type": "scenic/direct/safe",
  "stops": [
    {
      "name": "Stop name",
      "type": "coffee/charging/viewpoint/other",
      "address": "Address in Sydney",
      "why": "Brief reason for this stop",
      "lat": -33.8688,
      "lng": 151.2093
    }
  ],
  "waypoints": [
    {"lat": -33.8688, "lng": 151.2093},
    {"lat": -33.8700, "lng": 151.2100}
  ],
  "tips": ["Helpful tip 1", "Helpful tip 2"],
  "shade_rating": 4,
  "safety_rating": 5,
  "scenery_rating": 4
}

Include real Sydney locations, coffee shops, cycleways, and points of interest. Use actual coordinates for Sydney CBD and surrounding areas. Make the route practical and cyclist-friendly.`;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{
            parts: [{
              text: prompt
            }]
          }],
          generationConfig: {
            temperature: 0.7,
            maxOutputTokens: 2048,
          }
        })
      });

      if (!response.ok) {
        throw new Error('Gemini API request failed');
      }

      const data = await response.json();
      const text = data.candidates[0].content.parts[0].text;

      // Parse JSON from response (handle markdown code blocks)
      let jsonStr = text;
      if (text.includes('```json')) {
        jsonStr = text.split('```json')[1].split('```')[0];
      } else if (text.includes('```')) {
        jsonStr = text.split('```')[1].split('```')[0];
      }

      return JSON.parse(jsonStr.trim());
    }

    function getMockRouteData(from, to, preferences) {
      // Demo data when no API key
      const hasCoffee = preferences.includes('coffee shop stop');
      const hasShade = preferences.includes('shady tree-lined streets');
      const hasCharging = preferences.includes('e-bike charging station');
      const hasScenic = preferences.includes('scenic harbour/water views');

      const stops = [];

      if (hasCoffee) {
        stops.push({
          name: "Single O Surry Hills",
          type: "coffee",
          address: "60-64 Reservoir St, Surry Hills",
          why: "Top-rated specialty coffee, cyclist-friendly outdoor seating",
          lat: -33.8847,
          lng: 151.2110
        });
      }

      if (hasCharging) {
        stops.push({
          name: "Town Hall Charging Hub",
          type: "charging",
          address: "George St, Sydney CBD",
          why: "Fast charging with 6 available spots",
          lat: -33.8731,
          lng: 151.2065
        });
      }

      if (hasScenic) {
        stops.push({
          name: "Mrs Macquarie's Point",
          type: "viewpoint",
          address: "Mrs Macquaries Rd, Sydney",
          why: "Stunning Opera House and Harbour Bridge views",
          lat: -33.8598,
          lng: 151.2228
        });
      }

      return {
        summary: `A ${hasShade ? 'tree-lined ' : ''}${hasScenic ? 'scenic ' : ''}bike route from ${from} to ${to}${hasCoffee ? ' with a great coffee stop' : ''}.`,
        distance_km: 6.8,
        duration_mins: 28,
        elevation_gain_m: hasShade ? 25 : 55,
        route_type: hasScenic ? 'scenic' : (hasShade ? 'safe' : 'direct'),
        stops: stops,
        waypoints: [
          { lat: -33.8688, lng: 151.2093 },
          { lat: -33.8720, lng: 151.2100 },
          { lat: -33.8780, lng: 151.2120 },
          { lat: -33.8847, lng: 151.2110 },
          { lat: -33.8900, lng: 151.2050 }
        ],
        tips: [
          hasShade ? "Hyde Park and Moore Park offer great shade coverage" : "Apply sunscreen - limited shade on this route",
          "Kent Street cycleway has the smoothest surface",
          hasCoffee ? "Single O opens at 7am - perfect for morning rides" : "Several water fountains along Bourke St cycleway"
        ],
        shade_rating: hasShade ? 5 : 3,
        safety_rating: 4,
        scenery_rating: hasScenic ? 5 : 3
      };
    }

    function displayAiRouteResult(routeData) {
      lastAiRouteData = routeData;

      // Hide loading, show result
      document.getElementById('aiRouteLoading').classList.add('hidden');
      document.getElementById('aiRouteResult').classList.remove('hidden');

      // Populate AI response
      const resultText = document.getElementById('aiRouteText');
      resultText.innerHTML = `
        <p class="font-medium">${routeData.summary}</p>
        <div class="grid grid-cols-3 gap-2 mt-3">
          <div class="text-center p-2 bg-white dark:bg-slate-800 rounded-lg">
            <div class="text-lg font-bold text-primary">${routeData.distance_km}km</div>
            <div class="text-[10px] text-gray-500">Distance</div>
          </div>
          <div class="text-center p-2 bg-white dark:bg-slate-800 rounded-lg">
            <div class="text-lg font-bold text-acc-green">${routeData.duration_mins}min</div>
            <div class="text-[10px] text-gray-500">Time</div>
          </div>
          <div class="text-center p-2 bg-white dark:bg-slate-800 rounded-lg">
            <div class="text-lg font-bold text-acc-orange">${routeData.elevation_gain_m}m</div>
            <div class="text-[10px] text-gray-500">Climb</div>
          </div>
        </div>
        <div class="flex items-center gap-4 mt-3 text-xs">
          <div class="flex items-center gap-1">
            <span>üå≥</span>
            <span class="dark:text-gray-300">Shade: ${routeData.shade_rating}/5</span>
          </div>
          <div class="flex items-center gap-1">
            <span>üõ°Ô∏è</span>
            <span class="dark:text-gray-300">Safety: ${routeData.safety_rating}/5</span>
          </div>
          <div class="flex items-center gap-1">
            <span>üåä</span>
            <span class="dark:text-gray-300">Views: ${routeData.scenery_rating}/5</span>
          </div>
        </div>
      `;

      // Populate stops
      const stopsContainer = document.getElementById('aiRouteStops');
      if (routeData.stops && routeData.stops.length > 0) {
        stopsContainer.innerHTML = `
          <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Suggested Stops</h4>
          ${routeData.stops.map((stop, i) => `
            <div class="flex items-start gap-3 p-3 bg-gray-50 dark:bg-slate-800 rounded-xl">
              <div class="w-8 h-8 rounded-full bg-gradient-to-tr ${getStopGradient(stop.type)} flex items-center justify-center flex-shrink-0">
                <span class="text-sm">${getStopEmoji(stop.type)}</span>
              </div>
              <div class="flex-1">
                <h5 class="font-semibold dark:text-white text-sm">${stop.name}</h5>
                <p class="text-xs text-gray-500">${stop.address}</p>
                <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${stop.why}</p>
              </div>
            </div>
          `).join('')}
        `;
      } else {
        stopsContainer.innerHTML = '';
      }

      // Display tips
      if (routeData.tips && routeData.tips.length > 0) {
        stopsContainer.innerHTML += `
          <h4 class="text-xs font-bold text-gray-500 uppercase mb-2 mt-4">Route Tips</h4>
          <div class="space-y-1">
            ${routeData.tips.map(tip => `
              <div class="flex items-start gap-2 text-xs text-gray-600 dark:text-gray-400">
                <span class="text-acc-green">üí°</span>
                <span>${tip}</span>
              </div>
            `).join('')}
          </div>
        `;
      }

      // Draw route preview on map
      drawAiRouteOnMap(routeData);
    }

    function getStopEmoji(type) {
      const emojis = {
        coffee: '‚òï',
        charging: '‚ö°',
        viewpoint: 'üì∏',
        food: 'üçΩÔ∏è',
        park: 'üå≥',
        other: 'üìç'
      };
      return emojis[type] || 'üìç';
    }

    function getStopGradient(type) {
      const gradients = {
        coffee: 'from-amber-400 to-orange-500',
        charging: 'from-green-400 to-emerald-500',
        viewpoint: 'from-blue-400 to-cyan-500',
        food: 'from-red-400 to-pink-500',
        park: 'from-green-500 to-teal-500',
        other: 'from-purple-400 to-indigo-500'
      };
      return gradients[type] || 'from-gray-400 to-gray-500';
    }

    function drawAiRouteOnMap(routeData) {
      // Clear previous AI route
      clearAiRoute();

      if (!routeData.waypoints || routeData.waypoints.length < 2) return;

      // Draw the route polyline
      aiRoutePolyline = new google.maps.Polyline({
        path: routeData.waypoints,
        strokeColor: '#9333EA',
        strokeOpacity: 0,
        strokeWeight: 6,
        map: map,
        zIndex: 200,
        icons: [{
          icon: {
            path: 'M 0,-1 0,1',
            strokeOpacity: 1,
            strokeColor: '#9333EA',
            strokeWeight: 6,
            scale: 3
          },
          offset: '0',
          repeat: '15px'
        }]
      });

      // Add stop markers
      if (routeData.stops) {
        routeData.stops.forEach(stop => {
          if (stop.lat && stop.lng) {
            const marker = new google.maps.Marker({
              position: { lat: stop.lat, lng: stop.lng },
              map: map,
              icon: {
                url: `data:image/svg+xml,${encodeURIComponent(`
                  <svg xmlns="http://www.w3.org/2000/svg" width="36" height="44" viewBox="0 0 36 44">
                    <defs>
                      <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#9333EA"/>
                        <stop offset="100%" style="stop-color:#EC4899"/>
                      </linearGradient>
                    </defs>
                    <path d="M18 0 C8 0 0 8 0 18 C0 31 18 44 18 44 C18 44 36 31 36 18 C36 8 28 0 18 0Z" fill="url(#grad)"/>
                    <circle cx="18" cy="16" r="10" fill="white"/>
                    <text x="18" y="20" text-anchor="middle" font-size="12">${getStopEmoji(stop.type)}</text>
                  </svg>
                `)}`,
                scaledSize: new google.maps.Size(36, 44),
                anchor: new google.maps.Point(18, 44)
              },
              title: stop.name,
              zIndex: 201
            });

            marker.addListener('click', () => {
              showToast(`${stop.name}: ${stop.why}`);
            });

            aiRouteMarkers.push(marker);
          }
        });
      }

      // Fit bounds to show full route
      const bounds = new google.maps.LatLngBounds();
      routeData.waypoints.forEach(wp => bounds.extend(wp));
      if (routeData.stops) {
        routeData.stops.forEach(stop => {
          if (stop.lat && stop.lng) bounds.extend({ lat: stop.lat, lng: stop.lng });
        });
      }
      map.fitBounds(bounds, { padding: 80 });
    }

    function clearAiRoute() {
      if (aiRoutePolyline) {
        aiRoutePolyline.setMap(null);
        aiRoutePolyline = null;
      }
      aiRouteMarkers.forEach(marker => marker.setMap(null));
      aiRouteMarkers = [];
    }

    function applyAiRoute() {
      if (!lastAiRouteData || !lastAiRouteData.waypoints || lastAiRouteData.waypoints.length < 2) {
        showToast('No route to apply');
        return;
      }

      // Build Google Maps directions URL with waypoints
      const waypoints = lastAiRouteData.waypoints;
      const start = waypoints[0];
      const end = waypoints[waypoints.length - 1];

      let url = `https://www.google.com/maps/dir/?api=1&origin=${start.lat},${start.lng}&destination=${end.lat},${end.lng}&travelmode=bicycling`;

      // Add intermediate waypoints (max 8 for Google Maps URL)
      if (lastAiRouteData.stops && lastAiRouteData.stops.length > 0) {
        const stopCoords = lastAiRouteData.stops
          .filter(s => s.lat && s.lng)
          .map(s => `${s.lat},${s.lng}`)
          .slice(0, 8);

        if (stopCoords.length > 0) {
          url += `&waypoints=${stopCoords.join('|')}`;
        }
      }

      window.open(url, '_blank');
      closeAiRouteModal();
      showToast('Opening route in Google Maps! üó∫Ô∏è');
    }

    function regenerateAiRoute() {
      document.getElementById('aiRouteResult').classList.add('hidden');
      document.getElementById('generateRouteBtn').classList.remove('hidden');
      clearAiRoute();
    }

    // ============================================
    // EDUCATION & REWARDS SYSTEM
    // ============================================
    let currentModule = null;
    let currentModuleSection = 0;
    let currentQuiz = null;
    let currentQuizQuestion = 0;
    let quizScore = 0;
    let quizAnswered = false;

    function openEducationModal() {
      document.getElementById('educationModal').classList.add('visible');
      updateEducationUI();
      loadEducationModules();
    }

    function closeEducationModal() {
      document.getElementById('educationModal').classList.remove('visible');
    }

    function updateEducationUI() {
      if (typeof USER_PROGRESS === 'undefined') return;

      const points = USER_PROGRESS.total_points;
      document.getElementById('eduTotalPoints').textContent = points.toLocaleString();
      document.getElementById('eduPointsCurrent').textContent = points.toLocaleString();

      const level = getUserLevel(points);
      const nextLevel = getNextLevel(points);
      const progress = getLevelProgress(points);

      document.getElementById('eduLevelIcon').textContent = level.icon;
      document.getElementById('eduLevelName').textContent = level.name;
      document.getElementById('eduLevelLabel').textContent = `Level ${level.level}`;
      document.getElementById('eduLevelBar').style.width = progress + '%';

      if (nextLevel) {
        const pointsNeeded = nextLevel.min_points - points;
        document.getElementById('eduPointsNext').textContent = `${pointsNeeded} more to ${nextLevel.name}`;
      } else {
        document.getElementById('eduPointsNext').textContent = 'Max level reached!';
      }
    }

    function loadEducationModules() {
      if (typeof EDUCATION_MODULES === 'undefined') return;

      const container = document.getElementById('eduTabModules');
      container.innerHTML = EDUCATION_MODULES.map(mod => {
        const completed = isModuleCompleted(mod.id);
        return `
          <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl ${completed ? 'border-2 border-acc-green' : ''}" onclick="openModule('${mod.id}')">
            <div class="flex items-start gap-3">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-tr ${completed ? 'from-green-400 to-emerald-500' : 'from-blue-400 to-cyan-500'} flex items-center justify-center flex-shrink-0">
                <span class="text-2xl">${completed ? '‚úì' : mod.icon}</span>
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <h3 class="font-bold dark:text-white text-sm">${mod.title}</h3>
                  ${completed ? '<span class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700">Completed</span>' : ''}
                </div>
                <p class="text-xs text-gray-500 mb-2">${mod.description}</p>
                <div class="flex items-center gap-3 text-xs text-gray-400">
                  <span>‚è±Ô∏è ${mod.duration_mins} min</span>
                  <span>‚≠ê ${mod.points} pts</span>
                  <span class="px-2 py-0.5 rounded-full bg-gray-200 dark:bg-gray-700 dark:text-gray-300">${mod.difficulty}</span>
                </div>
              </div>
              <span class="material-icons-round text-gray-400">chevron_right</span>
            </div>
          </div>
        `;
      }).join('');

      // Load rewards
      loadRewards();

      // Load badges
      loadBadges();
    }

    function loadRewards() {
      if (typeof REWARDS === 'undefined') return;

      const container = document.getElementById('eduTabRewards');

      // Featured rewards first
      const featured = REWARDS.filter(r => r.featured);
      const regular = REWARDS.filter(r => !r.featured);

      container.innerHTML = `
        <div class="mb-4">
          <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">üö¥ E-Bike Discounts</h3>
          <div class="space-y-2">
            ${featured.map(reward => renderReward(reward)).join('')}
          </div>
        </div>
        <div>
          <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">üéÅ More Rewards</h3>
          <div class="space-y-2">
            ${regular.map(reward => renderReward(reward)).join('')}
          </div>
        </div>
      `;
    }

    function renderReward(reward) {
      const canAfford = USER_PROGRESS.total_points >= reward.points_cost;
      const redeemed = USER_PROGRESS.redeemed_rewards.includes(reward.id);

      return `
        <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl ${!canAfford && !redeemed ? 'opacity-60' : ''} ${redeemed ? 'border-2 border-acc-green' : ''}">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-tr ${reward.featured ? 'from-yellow-400 to-orange-500' : 'from-gray-400 to-gray-500'} flex items-center justify-center flex-shrink-0">
              <span class="text-xl">${reward.icon}</span>
            </div>
            <div class="flex-1">
              <h4 class="font-bold dark:text-white text-sm">${reward.name}</h4>
              <p class="text-xs text-gray-500">${reward.description}</p>
              <p class="text-[10px] text-gray-400 mt-1">Partner: ${reward.partner}</p>
            </div>
            <div class="text-right">
              ${redeemed ? `
                <span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700">Redeemed</span>
              ` : `
                <button onclick="event.stopPropagation(); redeemReward('${reward.id}')" class="px-3 py-1.5 rounded-full text-xs font-bold ${canAfford ? 'bg-acc-blue text-white hover:bg-acc-blue/90' : 'bg-gray-200 dark:bg-gray-700 text-gray-500 cursor-not-allowed'}">
                  ${reward.points_cost} pts
                </button>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function loadBadges() {
      if (typeof BADGES === 'undefined') return;

      const container = document.getElementById('eduTabBadges');
      container.innerHTML = BADGES.map(badge => {
        const earned = USER_PROGRESS.badges.includes(badge.id);
        return `
          <div class="flex items-center gap-3 p-3 rounded-xl ${earned ? 'bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20' : 'bg-gray-50 dark:bg-slate-800 opacity-50'}">
            <div class="w-12 h-12 rounded-full ${earned ? 'bg-gradient-to-tr from-yellow-400 to-orange-500' : 'bg-gray-300 dark:bg-gray-600'} flex items-center justify-center">
              <span class="text-2xl ${earned ? '' : 'grayscale opacity-50'}">${badge.icon}</span>
            </div>
            <div class="flex-1">
              <h4 class="font-bold dark:text-white text-sm">${badge.name}</h4>
              <p class="text-xs text-gray-500">${badge.description}</p>
            </div>
            ${earned ? `
              <span class="text-xs text-acc-green font-bold">+${badge.points_bonus}</span>
            ` : `
              <span class="material-icons-round text-gray-400">lock</span>
            `}
          </div>
        `;
      }).join('');
    }

    function redeemReward(rewardId) {
      const reward = REWARDS.find(r => r.id === rewardId);
      if (!reward) return;

      if (USER_PROGRESS.total_points < reward.points_cost) {
        showToast('Not enough points!');
        return;
      }

      USER_PROGRESS.total_points -= reward.points_cost;
      USER_PROGRESS.redeemed_rewards.push(rewardId);

      updateEducationUI();
      loadRewards();
      showToast(`üéâ Redeemed: ${reward.name}!`);
    }

    // Module functions
    function openModule(moduleId) {
      currentModule = EDUCATION_MODULES.find(m => m.id === moduleId);
      if (!currentModule) return;

      currentModuleSection = 0;
      displayModuleSection();
      document.getElementById('moduleModal').classList.add('visible');
    }

    function closeModuleModal() {
      document.getElementById('moduleModal').classList.remove('visible');
      currentModule = null;
    }

    function displayModuleSection() {
      if (!currentModule) return;

      const section = currentModule.sections[currentModuleSection];
      const total = currentModule.sections.length;
      const progress = ((currentModuleSection + 1) / total) * 100;

      document.getElementById('moduleIcon').textContent = currentModule.icon;
      document.getElementById('moduleTitle').textContent = currentModule.title;
      document.getElementById('moduleMeta').textContent = `${currentModule.duration_mins} min ‚Ä¢ ${currentModule.points} points`;
      document.getElementById('moduleSectionProgress').textContent = `Section ${currentModuleSection + 1} of ${total}`;
      document.getElementById('moduleSectionBar').style.width = progress + '%';
      document.getElementById('moduleSectionTitle').textContent = section.title;
      document.getElementById('moduleSectionText').textContent = section.content;

      // Update buttons
      document.getElementById('modulePrevBtn').style.display = currentModuleSection === 0 ? 'none' : 'block';

      const nextBtn = document.getElementById('moduleNextBtn');
      if (currentModuleSection === total - 1) {
        nextBtn.textContent = currentModule.quiz_id ? 'Take Quiz' : 'Complete';
        nextBtn.classList.remove('bg-acc-blue');
        nextBtn.classList.add('bg-acc-green');
      } else {
        nextBtn.textContent = 'Next';
        nextBtn.classList.add('bg-acc-blue');
        nextBtn.classList.remove('bg-acc-green');
      }
    }

    function prevModuleSection() {
      if (currentModuleSection > 0) {
        currentModuleSection--;
        displayModuleSection();
      }
    }

    function nextModuleSection() {
      if (!currentModule) return;

      if (currentModuleSection < currentModule.sections.length - 1) {
        currentModuleSection++;
        displayModuleSection();
      } else {
        // Module complete
        if (currentModule.quiz_id) {
          closeModuleModal();
          openQuiz(currentModule.quiz_id);
        } else {
          completeModule(currentModule.id);
          closeModuleModal();
        }
      }
    }

    function completeModule(moduleId) {
      if (!USER_PROGRESS.completed_modules.includes(moduleId)) {
        const mod = EDUCATION_MODULES.find(m => m.id === moduleId);
        USER_PROGRESS.completed_modules.push(moduleId);
        USER_PROGRESS.total_points += mod.points;
        updateEducationUI();
        loadEducationModules();
        showToast(`üéâ +${mod.points} points! Module completed!`);
      }
    }

    // Quiz functions
    function openQuiz(quizId) {
      currentQuiz = EDUCATION_QUIZZES.find(q => q.id === quizId);
      if (!currentQuiz) return;

      currentQuizQuestion = 0;
      quizScore = 0;
      document.getElementById('quizScore').classList.add('hidden');
      document.getElementById('quizNextBtn').classList.add('hidden');
      document.getElementById('quizContent').classList.remove('hidden');
      displayQuizQuestion();
      document.getElementById('quizModal').classList.add('visible');
    }

    function closeQuizModal() {
      document.getElementById('quizModal').classList.remove('visible');
      currentQuiz = null;
      openEducationModal();
    }

    function displayQuizQuestion() {
      if (!currentQuiz) return;

      const q = currentQuiz.questions[currentQuizQuestion];
      const total = currentQuiz.questions.length;
      const progress = ((currentQuizQuestion + 1) / total) * 100;

      document.getElementById('quizTitle').textContent = currentQuiz.title;
      document.getElementById('quizProgress').textContent = `Question ${currentQuizQuestion + 1} of ${total}`;
      document.getElementById('quizProgressBar').style.width = progress + '%';
      document.getElementById('quizQuestionText').textContent = q.question;
      document.getElementById('quizExplanation').classList.add('hidden');
      document.getElementById('quizNextBtn').classList.add('hidden');
      quizAnswered = false;

      const optionsContainer = document.getElementById('quizOptions');
      optionsContainer.innerHTML = q.options.map((opt, i) => `
        <button onclick="selectQuizAnswer(${i})" class="quiz-option w-full text-left p-4 rounded-xl bg-gray-50 dark:bg-slate-800 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors border-2 border-transparent">
          <span class="font-medium dark:text-white">${opt}</span>
        </button>
      `).join('');
    }

    function selectQuizAnswer(index) {
      if (quizAnswered) return;
      quizAnswered = true;

      const q = currentQuiz.questions[currentQuizQuestion];
      const options = document.querySelectorAll('.quiz-option');

      options.forEach((opt, i) => {
        opt.classList.remove('hover:bg-gray-100', 'dark:hover:bg-slate-700');
        if (i === q.correct) {
          opt.classList.add('border-acc-green', 'bg-green-50', 'dark:bg-green-900/20');
        } else if (i === index && index !== q.correct) {
          opt.classList.add('border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
        }
      });

      if (index === q.correct) {
        quizScore++;
      }

      // Show explanation
      document.getElementById('quizExplanationText').textContent = q.explanation;
      document.getElementById('quizExplanation').classList.remove('hidden');

      // Show next button
      const nextBtn = document.getElementById('quizNextBtn');
      if (currentQuizQuestion < currentQuiz.questions.length - 1) {
        nextBtn.textContent = 'Next Question';
      } else {
        nextBtn.textContent = 'See Results';
      }
      nextBtn.classList.remove('hidden');
    }

    function nextQuizQuestion() {
      if (currentQuizQuestion < currentQuiz.questions.length - 1) {
        currentQuizQuestion++;
        displayQuizQuestion();
      } else {
        // Quiz complete
        showQuizResults();
      }
    }

    function showQuizResults() {
      const total = currentQuiz.questions.length;
      const pointsEarned = quizScore * currentQuiz.points_per_question;
      const perfectBonus = quizScore === total ? currentQuiz.perfect_bonus : 0;
      const totalPoints = pointsEarned + perfectBonus;

      document.getElementById('quizContent').classList.add('hidden');
      document.getElementById('quizNextBtn').classList.add('hidden');

      const scoreDiv = document.getElementById('quizScore');
      document.getElementById('quizScoreEmoji').textContent = quizScore === total ? 'üéâ' : quizScore >= total / 2 ? 'üëç' : 'üìö';
      document.getElementById('quizScoreText').textContent = `+${totalPoints} Points!`;
      document.getElementById('quizScoreDetail').textContent = `You got ${quizScore}/${total} correct!${perfectBonus > 0 ? ' Perfect score bonus!' : ''}`;
      scoreDiv.classList.remove('hidden');

      // Update progress
      USER_PROGRESS.total_points += totalPoints;
      if (!USER_PROGRESS.completed_quizzes.includes(currentQuiz.id)) {
        USER_PROGRESS.completed_quizzes.push(currentQuiz.id);

        // Also complete the module
        const mod = EDUCATION_MODULES.find(m => m.quiz_id === currentQuiz.id);
        if (mod && !USER_PROGRESS.completed_modules.includes(mod.id)) {
          USER_PROGRESS.completed_modules.push(mod.id);
          USER_PROGRESS.total_points += mod.points;
        }
      }

      // Check for quiz master badge
      if (quizScore === total && !USER_PROGRESS.badges.includes('quiz_master')) {
        USER_PROGRESS.badges.push('quiz_master');
        USER_PROGRESS.total_points += 100;
        setTimeout(() => showToast('üèÖ New Badge: Quiz Master!'), 1000);
      }
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      // Network toggle
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.toggle-btn').forEach(b => {
            b.classList.remove('bg-acc-green', 'text-white');
            b.classList.add('text-gray-600', 'dark:text-gray-300');
          });
          btn.classList.add('bg-acc-green', 'text-white');
          btn.classList.remove('text-gray-600', 'dark:text-gray-300');
          switchNetworkView(btn.dataset.view);
        });
      });

      // Dark mode toggle
      document.getElementById('darkModeBtn').addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        if (map) {
          map.setOptions({ styles: getMapStyles() });
        }
      });

      // Sidebar buttons
      document.getElementById('routeBtn').addEventListener('click', openAiRouteModal);
      document.getElementById('editBtn').addEventListener('click', openReportModal);
      document.getElementById('communityBtn').addEventListener('click', openCommunityModal);
      document.getElementById('educationBtn').addEventListener('click', openEducationModal);
      document.getElementById('layersBtn').addEventListener('click', openLayersModal);

      // Education tabs
      document.querySelectorAll('.edu-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.edu-tab').forEach(t => {
            t.classList.remove('bg-acc-blue', 'text-white');
            t.classList.add('bg-gray-100', 'dark:bg-slate-800', 'text-gray-600', 'dark:text-gray-300');
          });
          tab.classList.add('bg-acc-blue', 'text-white');
          tab.classList.remove('bg-gray-100', 'dark:bg-slate-800', 'text-gray-600', 'dark:text-gray-300');

          document.querySelectorAll('.edu-tab-content').forEach(c => c.classList.add('hidden'));
          document.getElementById('eduTab' + tab.dataset.tab.charAt(0).toUpperCase() + tab.dataset.tab.slice(1)).classList.remove('hidden');
        });
      });

      // Community tabs
      document.querySelectorAll('.community-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.community-tab').forEach(t => {
            t.classList.remove('bg-primary', 'text-white');
            t.classList.add('bg-gray-100', 'dark:bg-slate-800', 'text-gray-600', 'dark:text-gray-300');
          });
          tab.classList.add('bg-primary', 'text-white');
          tab.classList.remove('bg-gray-100', 'dark:bg-slate-800', 'text-gray-600', 'dark:text-gray-300');

          document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
          document.getElementById('tab' + tab.dataset.tab.charAt(0).toUpperCase() + tab.dataset.tab.slice(1)).classList.remove('hidden');
        });
      });

      // Layer toggles
      document.getElementById('layerCharging').addEventListener('change', (e) => {
        showCharging = e.target.checked;
        updatePoiVisibility();
      });
      document.getElementById('layerStores').addEventListener('change', (e) => {
        showStores = e.target.checked;
        updatePoiVisibility();
      });
      document.getElementById('layerCommunities').addEventListener('change', (e) => {
        showCommunities = e.target.checked;
        updatePoiVisibility();
      });
      document.getElementById('layerVeloways').addEventListener('change', (e) => {
        showVeloways = e.target.checked;
        updateVelowayVisibility();
      });

      // Sheet handle
      document.getElementById('sheetHandle').addEventListener('click', () => {
        if (isSheetExpanded) {
          collapseSheet();
        } else if (selectedProject) {
          expandSheet();
        }
      });

      // Report types
      document.querySelectorAll('.report-type').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.report-type').forEach(b => b.classList.remove('ring-2', 'ring-primary'));
          btn.classList.add('ring-2', 'ring-primary');
        });
      });

      // Directions button
      document.getElementById('directionsBtn').addEventListener('click', () => {
        if (selectedProject && selectedProject.coordinates) {
          const coord = selectedProject.coordinates[0];
          window.open(`https://www.google.com/maps/dir/?api=1&destination=${coord.lat},${coord.lng}&travelmode=bicycling`, '_blank');
        }
      });

      // Favorite button
      document.getElementById('favoriteBtn').addEventListener('click', () => {
        const btn = document.getElementById('favoriteBtn');
        const icon = btn.querySelector('.material-icons-round');
        if (icon.textContent === 'favorite_border') {
          icon.textContent = 'favorite';
          btn.classList.add('text-red-500');
          showToast('Added to favorites!');
        } else {
          icon.textContent = 'favorite_border';
          btn.classList.remove('text-red-500');
        }
      });
    });

    // ============================================
    // ONBOARDING
    // ============================================
    // All onboarding logic (Splash, Sign In, Sign Up) is handled in app-core.js
    // Functions: showOnboarding, showSignInScreen, showSignUpScreen, handleSignIn, handleSignUp
    // DO NOT add any onboarding logic here - it will conflict with app-core.js

    // ============================================
    // PROFILE MODAL FUNCTIONS
    // ============================================
    function openProfileModal() {
      updateProfileDisplay();
      document.getElementById('profileModal').classList.add('visible');
    }

    function closeProfileModal() {
      document.getElementById('profileModal').classList.remove('visible');
    }

    function updateProfileDisplay() {
      // Check if AppState exists (from app-core.js)
      const user = window.AppState?.user;
      const profile = window.AppState?.userProfile;
      const isSignedIn = user && !user.isGuest;

      // Update avatar
      const avatarIcon = document.getElementById('profileAvatarIcon');
      const avatarImg = document.getElementById('profileAvatarImg');

      if (profile?.photoURL) {
        avatarIcon.classList.add('hidden');
        avatarImg.src = profile.photoURL;
        avatarImg.classList.remove('hidden');
      } else {
        avatarIcon.classList.remove('hidden');
        avatarImg.classList.add('hidden');
      }

      // Update name & email
      document.getElementById('profileName').textContent = profile?.displayName || user?.displayName || 'Cyclist';
      document.getElementById('profileEmail').textContent = profile?.email || user?.email || (user?.isGuest ? 'Guest mode' : 'Sign in to save progress');

      // Update points & level
      const points = window.AppState?.totalPoints || (typeof USER_PROGRESS !== 'undefined' ? USER_PROGRESS.total_points : 0);
      document.getElementById('profilePoints').textContent = points.toLocaleString();

      // Calculate level
      const level = calculateLevel(points);
      document.getElementById('profileLevel').textContent = level.name;
      document.getElementById('profileLevelBar').style.width = `${level.progress}%`;
      document.getElementById('profileLevelProgress').textContent = `${points.toLocaleString()} / ${level.nextThreshold.toLocaleString()} points to next level`;

      // Update stats
      const stats = profile?.stats || {};
      document.getElementById('profileRides').textContent = stats.totalRides || 0;
      document.getElementById('profileKm').textContent = stats.totalKm || 0;
      document.getElementById('profileCO2').textContent = (stats.co2Saved || 0).toFixed(1);

      // Update badges
      const badges = window.AppState?.earnedBadges || (typeof USER_PROGRESS !== 'undefined' ? USER_PROGRESS.badges : ['first_ride']);
      const badgesContainer = document.getElementById('profileBadges');
      badgesContainer.innerHTML = badges.map(badgeId => {
        const badge = typeof BADGES !== 'undefined' ? BADGES.find(b => b.id === badgeId) : null;
        return `<span class="text-2xl" title="${badge?.name || badgeId}">${badge?.icon || 'üèÜ'}</span>`;
      }).join('');

      // Update preferences
      const prefs = profile?.preferences || {};
      document.getElementById('prefShade').checked = prefs.preferShade || false;
      document.getElementById('prefScenic').checked = prefs.preferScenic || false;
      document.getElementById('prefSafe').checked = prefs.preferSafe !== false;
      document.getElementById('prefFlat').checked = prefs.preferFlat || false;

      // Update dark mode toggle
      document.getElementById('settingDarkMode').checked = document.documentElement.classList.contains('dark');

      // Update premium status
      const isPremium = window.AppState?.isPremium || false;
      document.getElementById('premiumSection').classList.toggle('hidden', !isPremium);
      document.getElementById('upgradePremiumSection').classList.toggle('hidden', isPremium);

      if (isPremium && profile?.premiumUntil) {
        document.getElementById('premiumUntil').textContent = `Valid until: ${new Date(profile.premiumUntil).toLocaleDateString()}`;
      }

      // Update sign in/out buttons
      document.getElementById('profileSignInBtn').classList.toggle('hidden', isSignedIn);
      document.getElementById('profileSignOutBtn').classList.toggle('hidden', !isSignedIn);
    }

    function calculateLevel(points) {
      const levels = typeof LEVELS !== 'undefined' ? LEVELS : [
        { name: 'Learner', threshold: 0 },
        { name: 'Pedal Pusher', threshold: 1000 },
        { name: 'Urban Cruiser', threshold: 2500 },
        { name: 'Path Pioneer', threshold: 5000 },
        { name: 'Safety Expert', threshold: 10000 },
        { name: 'Community Leader', threshold: 20000 },
        { name: 'Sydney Cycling Legend', threshold: 50000 }
      ];

      let currentLevel = levels[0];
      let nextLevel = levels[1] || levels[0];

      for (let i = 0; i < levels.length; i++) {
        if (points >= levels[i].threshold) {
          currentLevel = levels[i];
          nextLevel = levels[i + 1] || levels[i];
        }
      }

      const progressRange = nextLevel.threshold - currentLevel.threshold;
      const pointsInLevel = points - currentLevel.threshold;
      const progress = progressRange > 0 ? Math.min(100, (pointsInLevel / progressRange) * 100) : 100;

      return {
        name: currentLevel.name,
        progress: progress,
        nextThreshold: nextLevel.threshold
      };
    }

    function updatePreference(key, value) {
      if (typeof updateUserProfile === 'function' && window.AppState?.userProfile) {
        const prefs = window.AppState.userProfile.preferences || {};
        prefs[key] = value;
        updateUserProfile({ preferences: prefs });
        showToast('Preference saved');
      } else {
        // Save locally for guest users
        const localPrefs = JSON.parse(localStorage.getItem('micro2move_prefs') || '{}');
        localPrefs[key] = value;
        localStorage.setItem('micro2move_prefs', JSON.stringify(localPrefs));
      }
    }

    function toggleDarkMode(enabled) {
      document.documentElement.classList.toggle('dark', enabled);
      localStorage.setItem('micro2move_darkMode', enabled);
    }

    function toggleNotifications(enabled) {
      if (enabled && 'Notification' in window) {
        Notification.requestPermission().then(permission => {
          if (permission !== 'granted') {
            document.getElementById('settingNotifications').checked = false;
            showToast('Notifications blocked by browser');
          } else {
            localStorage.setItem('micro2move_notifications', 'true');
            showToast('Notifications enabled');
          }
        });
      } else {
        localStorage.setItem('micro2move_notifications', 'false');
      }
    }

    function showOnboardingForSignIn() {
      closeProfileModal();
      // Show the sign-in screen directly (skip splash)
      if (typeof showSignInScreen === 'function') {
        showSignInScreen();
      }
    }

    function handleSignOut() {
      if (typeof signOut === 'function') {
        signOut().then(() => {
          closeProfileModal();
          showToast('Signed out successfully');
          updateProfileDisplay();
        });
      } else {
        // Clear local storage for guest
        localStorage.removeItem('micro2move_user');
        localStorage.removeItem('micro2move_guest');
        window.AppState = window.AppState || {};
        window.AppState.user = null;
        window.AppState.userProfile = null;
        closeProfileModal();
        showToast('Signed out');
      }
    }

    function showPremiumOptions() {
      closeProfileModal();
      // Show a premium upgrade modal or redirect
      const premiumInfo = `
        <div class="text-center p-4">
          <div class="w-16 h-16 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 flex items-center justify-center mx-auto mb-4">
            <span class="material-icons-round text-white text-3xl">workspace_premium</span>
          </div>
          <h3 class="text-xl font-bold mb-2">Micro2Move Premium</h3>
          <p class="text-gray-600 mb-4">Unlock advanced features:</p>
          <ul class="text-left text-sm space-y-2 mb-6">
            <li class="flex items-center gap-2"><span class="material-icons-round text-acc-green text-lg">check_circle</span> Unlimited AI route planning</li>
            <li class="flex items-center gap-2"><span class="material-icons-round text-acc-green text-lg">check_circle</span> Offline maps download</li>
            <li class="flex items-center gap-2"><span class="material-icons-round text-acc-green text-lg">check_circle</span> 2x points on all activities</li>
            <li class="flex items-center gap-2"><span class="material-icons-round text-acc-green text-lg">check_circle</span> Exclusive partner discounts</li>
          </ul>
          <button onclick="handlePremiumPurchase('monthly')" class="w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-bold py-3 rounded-2xl mb-2">
            $4.99/month
          </button>
          <button onclick="handlePremiumPurchase('yearly')" class="w-full bg-primary text-white font-bold py-3 rounded-2xl">
            $39.99/year (Save 33%)
          </button>
        </div>
      `;

      // Use existing modal or show toast
      showToast('Premium coming soon!');
    }

    function handlePremiumPurchase(plan) {
      if (typeof purchasePremium === 'function') {
        const priceId = plan === 'yearly' ? 'price_yearly_id' : 'price_monthly_id';
        purchasePremium(priceId);
      } else {
        showToast('Please sign in to purchase');
      }
    }

    // Initialize dark mode from localStorage
    if (localStorage.getItem('micro2move_darkMode') === 'true') {
      document.documentElement.classList.add('dark');
    }
  </script>

  </div><!-- End mainApp -->

  <!-- Firebase SDK (v9 compat for easy migration) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

  <!-- Stripe SDK -->
  <script src="https://js.stripe.com/v3/"></script>

  <!-- Firebase Config (gitignored) -->
  <script src="js/firebase-config.js" onerror="console.log('Firebase config not found - running in demo mode')"></script>

  <!-- App Core (Auth, Firestore, Payments) -->
  <script src="js/app-core.js"></script>
</body>
</html>
